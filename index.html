<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Black Bee - Digital Payment Solution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f0f0f;
            color: #ffffff;
        }
        
        /* Dark theme overrides */
        .dark-bg {
            background-color: #0f0f0f;
        }
        
        .card-bg {
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
        }
        
        .header-bg {
            background-color: #000000;
            border-bottom: 1px solid #2a2a2a;
        }
        
        .yellow-gradient {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        }
        
        .yellow-text {
            color: #FFD700;
        }
        
        .gray-text {
            color: #a0a0a0;
        }
        
        .border-gray-dark {
            border-color: #2a2a2a;
        }
        
        /* Black Bee specific styles */
        .bee-card {
            background: linear-gradient(145deg, #1a1a1a 0%, #151515 100%);
            border: 1px solid #333;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .bee-button {
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 12px;
            transition: all 0.3s;
        }
        
        .bee-button:hover {
            background: #333;
            transform: translateY(-2px);
        }
        
        .bee-yellow-button {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            color: #000;
            font-weight: 600;
            border-radius: 12px;
        }
        
        .bee-yellow-button:hover {
            opacity: 0.9;
        }
        
        /* Balance display */
        .balance-display {
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -1px;
            text-shadow: 0 2px 10px rgba(255, 215, 0, 0.2);
        }
        
        /* Loan badge */
        .loan-badge {
            background: rgba(255, 0, 0, 0.15);
            border: 1px solid rgba(255, 0, 0, 0.3);
            color: #ff4444;
            border-radius: 20px;
        }
        
        /* Icon containers */
        .icon-container {
            width: 50px;
            height: 50px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: #2a2a2a;
            border: 1px solid #333;
        }
        
        /* Logo styles */
        .logo-image {
            width: 120px;
            height: 120px;
            object-fit: contain;
            margin-bottom: 1rem;
        }
        
        .logo-image-small {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }
        
        /* Animation for fade in */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Bottom navigation */
        .bottom-nav {
            background: #000000;
            border-top: 1px solid #2a2a2a;
            padding: 12px 0;
        }
        
        .nav-item {
            color: #a0a0a0;
            transition: color 0.3s;
        }
        
        .nav-item.active {
            color: #FFD700;
        }
        
        .nav-item:hover {
            color: #ffffff;
        }
        
        /* Notification badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #FF4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Dropdown menu */
        .dropdown-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            min-width: 150px;
            z-index: 40;
            display: none;
        }
        
        .dropdown-menu.show {
            display: block;
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: #ffffff;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .dropdown-item:hover {
            background-color: #2a2a2a;
        }
        
        .dropdown-item.delete {
            color: #ff4444;
        }
        
        /* Loading screen */
        .loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #0f0f0f;
        }
        
        .loading-logo {
            width: 120px;
            height: 120px;
            margin-bottom: 1rem;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        /* Success page */
        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.5s ease-out;
        }
        
        .success-card {
            background: linear-gradient(145deg, #1a1a1a 0%, #151515 100%);
            border: 1px solid #333;
            border-radius: 24px;
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            text-align: center;
            color: white;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2.5rem;
            color: #000;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 20px;
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            color: white;
        }
        
        /* Input styles */
        .bee-input {
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 12px;
            color: white;
            padding: 0.75rem 1rem;
            width: 100%;
        }
        
        .bee-input:focus {
            outline: none;
            border-color: #FFD700;
        }
        
        .bee-input-disabled {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            color: #a0a0a0;
            cursor: not-allowed;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }
        
        /* Hold to pay button */
        .hold-to-pay-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
            user-select: none;
            border: none;
        }
        
        .hold-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(255, 215, 0, 0.3);
            width: 0%;
            transition: width 2s linear;
            z-index: 1;
        }
        
        .hold-to-pay-btn.holding .hold-progress {
            animation: fillProgress 2s linear forwards;
        }
        
        @keyframes fillProgress {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        /* Status badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-active {
            background: rgba(0, 255, 0, 0.1);
            color: #00ff00;
            border: 1px solid rgba(0, 255, 0, 0.3);
        }
        
        .status-pending {
            background: rgba(255, 215, 0, 0.1);
            color: #FFD700;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .status-rejected {
            background: rgba(255, 0, 0, 0.1);
            color: #ff4444;
            border: 1px solid rgba(255, 0, 0, 0.3);
        }
        
        /* Profile specific styles */
        .profile-section-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #2a2a2a;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #2a2a2a;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: #a0a0a0;
            font-size: 0.875rem;
        }
        
        .info-value {
            font-weight: 500;
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }
        
        .edit-btn {
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            transition: all 0.3s;
        }
        
        .edit-btn:hover {
            background: #333;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            color: #000;
            font-weight: 600;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .cancel-btn {
            background: #2a2a2a;
            border: 1px solid #333;
            color: #a0a0a0;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            margin-right: 0.5rem;
        }
        
        /* Fund Transfer specific */
        .transfer-option-card {
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .transfer-option-card:hover {
            background: #333;
            transform: translateY(-2px);
        }
        
        /* Inbox styles */
        .inbox-item {
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }
        
        .inbox-item:hover {
            background: #333;
        }
        
        .inbox-item-title {
            font-weight: 600;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }
        
        .inbox-item-date {
            font-size: 0.75rem;
            color: #a0a0a0;
            margin-top: 0.75rem;
        }
        
        .inbox-item-processing {
            border-left: 4px solid #FFD700;
        }
        
        .inbox-item-successful {
            border-left: 4px solid #00ff00;
        }
        
        .inbox-item-rejected {
            border-left: 4px solid #ff4444;
        }
        
        /* Transaction Review styles */
        .review-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #333;
        }
        
        .review-item:last-child {
            border-bottom: none;
        }
        
        .review-total {
            font-size: 1.5rem;
            font-weight: 700;
            color: #FFD700;
        }
        
        /* Request Sent styles */
        .request-sent-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 3rem;
            color: #000;
        }
        
        /* Loan specific styles */
        .loan-installment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #333;
            border-radius: 10px;
            margin-bottom: 0.5rem;
        }
        
        .loan-installment-item.pending {
            background: rgba(255, 215, 0, 0.1);
            border-color: rgba(255, 215, 0, 0.3);
        }
        
        .loan-installment-item.paid {
            background: rgba(0, 255, 0, 0.1);
            border-color: rgba(0, 255, 0, 0.3);
        }
        
        .loan-installment-item.overdue {
            background: rgba(255, 0, 0, 0.1);
            border-color: rgba(255, 0, 0, 0.3);
        }
        
        .loan-installment-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #333;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loan-installment-checkbox.checked {
            background: #FFD700;
            border-color: #FFD700;
        }
        
        .loan-term-option {
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .loan-term-option:hover {
            background: #333;
            transform: translateY(-2px);
        }
        
        .loan-term-option.selected {
            background: rgba(255, 215, 0, 0.2);
            border-color: #FFD700;
        }
        
        /* Installment pay button */
        .installment-pay-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            color: #000;
            font-weight: 600;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
        }
        
        .installment-pay-btn:hover {
            opacity: 0.9;
        }
        
        .installment-pay-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Clear loan button */
        .clear-loan-btn {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            margin-top: 1rem;
        }
        
        .clear-loan-btn:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body class="dark-bg text-white min-h-screen">
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 transform translate-x-full transition-transform duration-300 z-50 bg-black border-l-4 border-gray-500 shadow-lg rounded-r p-4 flex items-center hidden">
        <div id="toast-icon" class="text-gray-400 mr-3"><i class="fas fa-info-circle"></i></div>
        <div>
            <p id="toast-title" class="font-bold text-sm">Notification</p>
            <p id="toast-message" class="text-xs text-gray-400">Message content</p>
        </div>
    </div>

    <!-- Success Overlay -->
    <div id="successPage" class="success-overlay hidden">
        <div class="success-card fade-in">
            <button onclick="closeSuccessPage()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl">
                <i class="fas fa-times"></i>
            </button>
            <div class="success-icon">
                <i id="successIcon" class="fas fa-check"></i>
            </div>
            <h1 id="successTitle" class="text-xl font-bold mb-2">Payment Successful</h1>
            <p id="successMessage" class="text-gray-400 mb-4">Your transaction has been processed successfully</p>
            <div id="successAmount" class="text-2xl font-bold yellow-text mb-2">৳0.00</div>
            <div id="successMethod" class="text-gray-400 mb-6">Via Method</div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="dbLoading" class="success-overlay hidden">
        <div class="success-card">
            <div class="flex flex-col items-center">
                <div class="w-16 h-16 border-4 border-t-yellow-500 border-gray-700 rounded-full animate-spin mb-4"></div>
                <h2 class="text-xl font-bold mb-2">Processing</h2>
                <p class="text-gray-400">Please wait...</p>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app" class="min-h-screen pb-20">
        <!-- Loading Screen -->
        <div class="loading-screen">
            <div class="bee-card p-8 flex flex-col items-center">
                <!-- LOGO HERE - Replaced bee icon with your PNG -->
                <img src="https://i.ibb.co/mFF6tP6z/Black-Bee.png" alt="Black Bee Logo" class="logo-image loading-logo">
                <h1 class="text-2xl font-bold mb-2">WebeemeX</h1>
                <p class="text-gray-400 mb-6">Developed By MR. MIRROR</p>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-yellow-500 rounded-full animate-pulse mr-2"></div>
                    <p class="text-gray-400">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        /**
         * FIREBASE INTEGRATION
         */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD5fr0JZKm9ZvVHY6CRNoi8KqLOXDDIdUY",
            authDomain: "coffee-spark-ai-barista-7951b.firebaseapp.com",
            projectId: "coffee-spark-ai-barista-7951b",
            storageBucket: "coffee-spark-ai-barista-7951b.firebasestorage.app",
            messagingSenderId: "720643698314",
            appId: "1:720643698314:web:546679d3d90210384e4773"
        };
        
        const appInstance = initializeApp(firebaseConfig);
        const auth = getAuth(appInstance);
        const db = getFirestore(appInstance);
        const appId = 'mizx-pay-live';

        // State Management
        let localUsers = [];
        let localHistory = [];
        let localTransactions = [];
        let localSendMoneyHistory = [];
        let localInboxMessages = [];
        let localFundTransfers = [];
        let localLoanRequests = [];
        let currentUser = null;
        let currentView = 'dashboard';
        let currentUserView = 'dashboard';
        let successTimer = null;
        let selectedRecipient = null;
        let holdTimer = null;
        let isHolding = false;
        let isEditingProfile = false;
        let currentFundTransfer = null;
        let currentLoanRequest = null;

        // User Type Definitions
        const userTypes = {
            'starter': {
                name: 'Starter User',
                loanEligibleAmount: 500,
                loanEligibleTerms: [1],
                canUploadProfilePicture: false
            },
            'standard': {
                name: 'Standard User',
                loanEligibleAmount: 2000,
                loanEligibleTerms: [1, 3],
                canUploadProfilePicture: false
            },
            'trusted': {
                name: 'Trusted User',
                loanEligibleAmount: 5000,
                loanEligibleTerms: [1, 3, 6],
                canUploadProfilePicture: false
            },
            'vip': {
                name: 'VIP User',
                loanEligibleAmount: 40000,
                loanEligibleTerms: [1, 3, 6, 12],
                canUploadProfilePicture: true
            }
        };

        // Default Users with Linked Profile Fields
        const defaultUsers = [
            { 
                id: 1, 
                username: 'Mizx999', 
                password: '123', 
                role: 'admin', 
                balance: 0, 
                isLocked: false, 
                fullName: 'System Administrator', 
                email: 'admin@blackbee.com',
                phone: '+8801700000000',
                address: 'Dhaka, Bangladesh',
                accountType: 'vip',
                userType: 'vip',
                createdAt: new Date().toISOString(),
                loanAmount: 0,
                loanActive: false,
                profilePicture: '',
                bkashAccount: '01700000000',
                bankName: 'BRAC Bank',
                bankAccount: '1020001234567'
            },
            { 
                id: 2, 
                username: 'muzahid0x2', 
                password: 'password', 
                role: 'user', 
                balance: 1150.00, 
                isLocked: false, 
                fullName: 'Muzahidul Islam', 
                email: 'muzahid@example.com',
                phone: '+8801712345678',
                address: 'Dhaka, Bangladesh',
                accountType: 'member',
                userType: 'standard',
                createdAt: new Date().toISOString(),
                loanAmount: 500.00,
                loanActive: true,
                profilePicture: '',
                bkashAccount: '01712345678',
                bankName: 'Dutch Bangla Bank',
                bankAccount: '101234567890'
            },
            { 
                id: 3, 
                username: 'user2', 
                password: 'password', 
                role: 'user', 
                balance: 250.50, 
                isLocked: false, 
                fullName: 'Jane Smith',
                email: 'jane@example.com',
                phone: '+8801711111111',
                address: 'Dhaka, Bangladesh',
                accountType: 'standard',
                userType: 'starter',
                createdAt: new Date().toISOString(),
                loanAmount: 0,
                loanActive: false,
                profilePicture: '',
                bkashAccount: '01711111111',
                bankName: 'City Bank',
                bankAccount: '102345678901'
            }
        ];

        // Format currency
        function formatCurrency(amount) {
            return `৳${amount.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        }

        // Initialize Auth
        async function initAuth() {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth Error:", error);
                showToast('Connection Error', 'Could not connect to database', 'error');
            }
        }

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Connected to Firebase as:", user.uid);
                setupRealtimeListeners();
            }
        });

        function setupRealtimeListeners() {
            const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
            const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'fundHistory');
            const transactionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
            const sendMoneyHistoryRef = collection(db, 'artifacts', appId, 'public', 'data', 'sendMoneyHistory');
            const inboxRef = collection(db, 'artifacts', appId, 'public', 'data', 'inboxMessages');
            const fundTransfersRef = collection(db, 'artifacts', appId, 'public', 'data', 'fundTransfers');
            const loanRequestsRef = collection(db, 'artifacts', appId, 'public', 'data', 'loanRequests');

            // Users listener
            onSnapshot(usersRef, (snapshot) => {
                localUsers = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    localUsers.push({ 
                        ...data, 
                        docId: doc.id,
                        email: data.email || '',
                        phone: data.phone || '',
                        address: data.address || '',
                        accountType: data.accountType || 'normal',
                        userType: data.userType || 'starter',
                        loanAmount: data.loanAmount || 0,
                        loanActive: data.loanActive || false,
                        profilePicture: data.profilePicture || '',
                        bkashAccount: data.bkashAccount || '',
                        bankName: data.bankName || '',
                        bankAccount: data.bankAccount || ''
                    });
                });
                
                if (localUsers.length === 0 && !window.hasSeeded) {
                    window.hasSeeded = true;
                    defaultUsers.forEach(async (u) => {
                        await addDoc(usersRef, u);
                    });
                    return;
                }

                if (currentUser) {
                    const updated = localUsers.find(u => u.id === currentUser.id);
                    if (updated) currentUser = updated;
                }

                refreshUI();
            });

            // History listener
            onSnapshot(historyRef, (snapshot) => {
                localHistory = [];
                snapshot.forEach((doc) => {
                    localHistory.push({ ...doc.data(), docId: doc.id });
                });
                refreshUI();
            });

            // Transactions listener
            onSnapshot(transactionsRef, (snapshot) => {
                localTransactions = [];
                snapshot.forEach((doc) => {
                    localTransactions.push({ ...doc.data(), docId: doc.id });
                });
                refreshUI();
            });

            // Send Money History listener
            onSnapshot(sendMoneyHistoryRef, (snapshot) => {
                localSendMoneyHistory = [];
                snapshot.forEach((doc) => {
                    localSendMoneyHistory.push({ ...doc.data(), docId: doc.id });
                });
                refreshUI();
            });

            // Inbox Messages listener
            onSnapshot(inboxRef, (snapshot) => {
                localInboxMessages = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    localInboxMessages.push({ 
                        ...data, 
                        docId: doc.id,
                        timestamp: data.timestamp?.toDate ? data.timestamp.toDate() : new Date(data.timestamp),
                        expiresAt: data.expiresAt?.toDate ? data.expiresAt.toDate() : new Date(data.expiresAt)
                    });
                });
                refreshUI();
            });

            // Fund Transfers listener
            onSnapshot(fundTransfersRef, (snapshot) => {
                localFundTransfers = [];
                snapshot.forEach((doc) => {
                    localFundTransfers.push({ ...doc.data(), docId: doc.id });
                });
                refreshUI();
            });

            // Loan Requests listener
            onSnapshot(loanRequestsRef, (snapshot) => {
                localLoanRequests = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    localLoanRequests.push({ 
                        ...data, 
                        docId: doc.id,
                        timestamp: data.timestamp?.toDate ? data.timestamp.toDate() : new Date(data.timestamp)
                    });
                });
                refreshUI();
            });
        }

        function refreshUI() {
            const app = document.getElementById('app');
            app.classList.remove('loading-screen');
            
            if (!currentUser) {
                renderLogin();
            } else if (currentUser.role === 'admin') {
                renderAdminPanel();
            } else {
                renderUserPanel();
            }
        }

        // Firebase document ID helper
        function getFirestoreDocId(numericId) {
            const user = localUsers.find(u => u.id === numericId);
            return user ? user.docId : null;
        }

        // UI Utilities
        function showToast(title, message, type = 'info') {
            const toast = document.getElementById('toast');
            const tTitle = document.getElementById('toast-title');
            const tMsg = document.getElementById('toast-message');
            const tIcon = document.getElementById('toast-icon');

            tTitle.innerText = title;
            tMsg.innerText = message;
            toast.classList.remove('hidden', 'translate-x-full');
            
            if(type === 'error') {
                toast.classList.replace('border-gray-500', 'border-red-500');
                tIcon.innerHTML = '<i class="fas fa-exclamation-circle text-red-500"></i>';
            } else if (type === 'success') {
                toast.classList.replace('border-gray-500', 'border-green-500');
                tIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
            } else {
                toast.classList.replace('border-red-500', 'border-gray-500');
                tIcon.innerHTML = '<i class="fas fa-info-circle text-gray-400"></i>';
            }

            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        function showDBLoading() {
            const loading = document.getElementById('dbLoading');
            loading.classList.remove('hidden');
        }

        function hideDBLoading() {
            const loading = document.getElementById('dbLoading');
            loading.classList.add('hidden');
        }

        function showSuccessPage(type, amount, method = '', recipientName = '') {
            const successPage = document.getElementById('successPage');
            const successIcon = document.getElementById('successIcon');
            const successTitle = document.getElementById('successTitle');
            const successMessage = document.getElementById('successMessage');
            const successAmount = document.getElementById('successAmount');
            const successMethod = document.getElementById('successMethod');
            
            // Clear any existing timer
            if (successTimer) {
                clearInterval(successTimer);
                successTimer = null;
            }
            
            if (type === 'deposit') {
                successIcon.className = 'fas fa-check';
                successTitle.textContent = 'Payment Successful';
                successMessage.textContent = `Your deposit of ${formatCurrency(amount)} has been submitted for approval.`;
                successMethod.textContent = `Via ${method.toUpperCase()}`;
            } else if (type === 'withdraw') {
                successIcon.className = 'fas fa-check';
                successTitle.textContent = 'Withdrawal Requested';
                successMessage.textContent = `Your withdrawal of ${formatCurrency(amount)} has been submitted for approval.`;
                successMethod.textContent = `Via ${method.toUpperCase()}`;
            } else if (type === 'sendmoney') {
                successIcon.className = 'fas fa-exchange-alt';
                successTitle.textContent = 'Send Money Successful!';
                successMessage.textContent = `Your money transfer has been completed successfully.`;
                successMethod.textContent = 'DIRECT TRANSFER';
            } else if (type === 'loan') {
                successIcon.className = 'fas fa-check';
                successTitle.textContent = 'Loan Request Submitted';
                successMessage.textContent = `Your loan request of ${formatCurrency(amount)} has been submitted for approval.`;
                successMethod.textContent = 'LOAN APPLICATION';
            } else if (type === 'installment') {
                successIcon.className = 'fas fa-check';
                successTitle.textContent = 'Installment Paid';
                successMessage.textContent = `Your loan installment of ${formatCurrency(amount)} has been paid successfully.`;
                successMethod.textContent = 'LOAN PAYMENT';
            } else if (type === 'clearloan') {
                successIcon.className = 'fas fa-check';
                successTitle.textContent = 'Loan Cleared';
                successMessage.textContent = `Your entire loan of ${formatCurrency(amount)} has been paid off.`;
                successMethod.textContent = 'FULL PAYMENT';
            }
            
            successAmount.textContent = formatCurrency(amount);
            successPage.classList.remove('hidden');
        }

        // Function to close success page
        function closeSuccessPage() {
            const successPage = document.getElementById('successPage');
            successPage.classList.add('hidden');
            
            // Clear any existing timer
            if (successTimer) {
                clearInterval(successTimer);
                successTimer = null;
            }
            
            // Return to home page
            if (currentUser && currentUser.role !== 'admin') {
                setUserCurrentView('dashboard');
            }
        }

        // CSV Download Function
        function downloadHistoryCSV() {
            try {
                // Get all history records
                const history = localHistory;
                
                if (history.length === 0) {
                    showToast('Info', 'No history to download', 'info');
                    return;
                }
                
                // Define CSV headers
                const headers = ['ID', 'User ID', 'Username', 'Type', 'Amount', 'Method', 'Details', 'Status', 'Date'];
                
                // Convert history to CSV rows
                const rows = history.map(log => [
                    log.id || '',
                    log.userId || '',
                    log.username || '',
                    log.type || '',
                    formatCurrency(log.amount || 0).replace('৳', ''),
                    log.method || '',
                    `"${(log.transactionDetails || '').replace(/"/g, '""')}"`,
                    log.status || '',
                    new Date(log.timestamp).toLocaleString()
                ]);
                
                // Combine headers and rows
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.join(','))
                ].join('\n');
                
                // Create a Blob and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `transaction_history_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('CSV Downloaded', 'Transaction history exported successfully', 'success');
                
            } catch (error) {
                console.error('CSV download error:', error);
                showToast('Error', 'Failed to download CSV', 'error');
            }
        }

        // Render Login Page
        function renderLogin() {
            const app = document.getElementById('app');
            app.className = "min-h-screen pb-20 flex items-center justify-center p-4";
            app.innerHTML = `
                <div class="w-full max-w-md fade-in">
                    <div class="bee-card p-8 mb-6 text-center">
                        <!-- LOGO HERE - Replaced bee icon with your PNG -->
                        <img src="https://i.ibb.co/mFF6tP6z/Black-Bee.png" alt="Black Bee Logo" class="logo-image mx-auto mb-4">
                        <h1 class="text-3xl font-bold mb-2">WebeemeX</h1>
                        <p class="text-gray-400 mb-8">Developed By MR. MIRROR</p>
                        
                        <form id="loginForm" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">User ID</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                        <i class="fas fa-user"></i>
                                    </span>
                                    <input type="text" id="username" class="bee-input pl-10" placeholder="Enter User ID" required>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Password</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                        <i class="fas fa-lock"></i>
                                    </span>
                                    <input type="password" id="password" class="bee-input pl-10" placeholder="Enter Password" required>
                                    <button type="button" onclick="togglePasswordVisibility()" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-gray-300">
                                        <i class="fas fa-eye" id="eyeIcon"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <button type="submit" class="w-full bee-yellow-button py-3 rounded-xl font-bold text-black">
                                Login to Dashboard
                            </button>
                        </form>
                        
                        <div class="mt-6 pt-6 border-t border-gray-800">
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-shield-alt mr-1"></i> Secure System. Your data is protected.
                            </p>
                        </div>
                    </div>
                    
                    <div class="text-center text-gray-500 text-sm">
                        <p>Don't have an account? Contact administration</p>
                    </div>
                </div>
            `;

            const form = document.getElementById('loginForm');
            if(form) form.addEventListener('submit', handleLogin);
        }

        // Render User Panel (Black Bee Style)
        function renderUserPanel() {
            const app = document.getElementById('app');
            app.className = "min-h-screen pb-20";
            
            // Determine active nav item
            const dashboardActive = currentUserView === 'dashboard' ? 'active' : '';
            const depositActive = currentUserView === 'deposit' ? 'active' : '';
            const withdrawActive = currentUserView === 'withdraw' ? 'active' : '';
            const sendmoneyActive = currentUserView === 'sendmoney' ? 'active' : '';
            const historyActive = currentUserView === 'history' ? 'active' : '';
            const profileActive = currentUserView === 'profile' ? 'active' : '';
            const fundtransferActive = currentUserView === 'fundtransfer' ? 'active' : '';
            const inboxActive = currentUserView === 'inbox' ? 'active' : '';
            const loanrequestActive = currentUserView === 'loanrequest' ? 'active' : '';
            const loandetailsActive = currentUserView === 'loandetails' ? 'active' : '';
            const loaninstallmentActive = currentUserView === 'loaninstallment' ? 'active' : '';
            const loanconfirmActive = currentUserView === 'loanconfirm' ? 'active' : '';
            const loanActive = currentUserView === 'loan' ? 'active' : '';
            const agentoutActive = currentUserView === 'agentout' ? 'active' : '';
            const agentoutreviewActive = currentUserView === 'agentoutreview' ? 'active' : '';
            
            // Count unread inbox messages
            const unreadInboxCount = localInboxMessages
                .filter(msg => msg.userId === currentUser.id && !msg.isRead && new Date(msg.expiresAt) > new Date())
                .length;
            
            app.innerHTML = `
                <!-- Header -->
                <div class="header-bg p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center mb-2">
                                <img src="https://i.ibb.co/mFF6tP6z/Black-Bee.png" alt="Black Bee Logo" class="logo-image-small mr-3">
                                <div>
                                    <h1 class="text-2xl font-bold mb-1">WebeemeX</h1>
                                    <p class="text-gray-400 text-sm">@${currentUser.username}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 mb-2">
                                <h2 class="text-lg font-semibold">${currentUser.fullName}</h2>
                                <span class="text-xs yellow-text bg-black px-2 py-1 rounded-full">${userTypes[currentUser.userType]?.name || 'BLACK BEE MEMBER'}</span>
                            </div>
                        </div>
                        <button onclick="logout()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-sign-out-alt text-xl"></i>
                        </button>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="p-4 fade-in">
                    ${currentUserView === 'dashboard' ? renderUserDashboard() : 
                      currentUserView === 'deposit' ? renderUserDeposit() : 
                      currentUserView === 'sendmoney' ? renderUserSendMoney() :
                      currentUserView === 'history' ? renderUserHistory() :
                      currentUserView === 'profile' ? (isEditingProfile ? renderProfileEditForm() : renderUserProfile()) :
                      currentUserView === 'fundtransfer' ? renderFundTransferOptions() :
                      currentUserView === 'bkashtransfer' ? renderBkashTransferForm() :
                      currentUserView === 'banktransfer' ? renderBankTransferForm() :
                      currentUserView === 'transferreview' ? renderTransferReview() :
                      currentUserView === 'requestsent' ? renderRequestSent() :
                      currentUserView === 'inbox' ? renderUserInbox() :
                      currentUserView === 'loanrequest' ? renderUserLoanRequest() :
                      currentUserView === 'loandetails' ? renderUserLoanDetails() :
                      currentUserView === 'loaninstallment' ? renderUserInstallmentPlan() :
                      currentUserView === 'loanconfirm' ? renderUserLoanConfirm() :
                      currentUserView === 'loan' ? renderUserLoanManagement() :
                      currentUserView === 'agentout' ? renderAgentOutForm() :
                      currentUserView === 'agentoutreview' ? renderAgentOutReview() : ''}
                </div>

                <!-- Bottom Navigation -->
                <div class="bottom-nav fixed bottom-0 left-0 right-0 z-30">
                    <div class="flex justify-around">
                        <button onclick="setUserCurrentView('dashboard')" class="nav-item ${dashboardActive} flex flex-col items-center">
                            <i class="fas fa-home text-xl mb-1"></i>
                            <span class="text-xs">Home</span>
                        </button>
                        
                        <button onclick="setUserCurrentView('history')" class="nav-item ${historyActive} flex flex-col items-center">
                            <i class="fas fa-history text-xl mb-1"></i>
                            <span class="text-xs">History</span>
                        </button>
                        
                        <button onclick="setUserCurrentView('inbox')" class="nav-item ${inboxActive} flex flex-col items-center relative">
                            <i class="fas fa-inbox text-xl mb-1"></i>
                            <span class="text-xs">Inbox</span>
                            ${unreadInboxCount > 0 ? `<span class="notification-badge">${unreadInboxCount}</span>` : ''}
                        </button>
                        
                        <button onclick="setUserCurrentView('profile')" class="nav-item ${profileActive} flex flex-col items-center">
                            <i class="fas fa-user-circle text-xl mb-1"></i>
                            <span class="text-xs">Profile</span>
                        </button>
                    </div>
                </div>
            `;
            
            // Add form event listeners based on current view
            setupFormListeners();
        }

        // Render User Dashboard (Black Bee Style) - UPDATED: Fixed Help button with WhatsApp redirect
        function renderUserDashboard() {
            const user = currentUser;
            const hasActiveLoan = user.loanActive && user.loanAmount > 0;
            
            return `
                <!-- Current Balance & Active Loan -->
                <div class="bee-card p-6 mb-6">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <p class="text-gray-400 text-sm mb-1">CURRENT BALANCE</p>
                            <div class="balance-display yellow-text">${formatCurrency(user.balance)}</div>
                        </div>
                        ${hasActiveLoan ? `
                            <div class="loan-badge px-4 py-2">
                                <p class="text-sm font-bold">ACTIVE LOAN</p>
                                <p class="text-lg font-bold">${formatCurrency(user.loanAmount)}</p>
                                <p class="text-xs text-gray-400">Loan Amount Received: $ ${user.loanAmount}</p>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Send Money Big Button -->
                    <div class="text-center mb-6">
                        <button onclick="setUserCurrentView('sendmoney')" class="bee-yellow-button w-full py-3 rounded-xl font-bold text-black mb-4">
                            Send Money
                        </button>
                    </div>

                    <!-- Quick Actions Grid - UPDATED: Removed profile button, now 4 buttons in 2x2 grid -->
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <button onclick="setUserCurrentView('deposit')" class="bee-button p-4 flex flex-col items-center">
                            <div class="icon-container mb-2">
                                <i class="fas fa-plus"></i>
                            </div>
                            <span class="text-sm font-medium">Add Money</span>
                        </button>
                        
                        <button onclick="setUserCurrentView('fundtransfer')" class="bee-button p-4 flex flex-col items-center">
                            <div class="icon-container mb-2">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <span class="text-sm font-medium">Fund Transfer</span>
                        </button>
                        
                        <button onclick="${hasActiveLoan ? "setUserCurrentView('loan')" : "setUserCurrentView('loanrequest')"}" class="bee-button p-4 flex flex-col items-center">
                            <div class="icon-container mb-2">
                                <i class="fas fa-hand-holding-usd"></i>
                            </div>
                            <span class="text-sm font-medium">${hasActiveLoan ? 'Manage Loan' : 'Get Loan'}</span>
                        </button>
                        
                        <button onclick="setUserCurrentView('agentout')" class="bee-button p-4 flex flex-col items-center">
                            <div class="icon-container mb-2">
                                <i class="fas fa-mobile-alt"></i>
                            </div>
                            <span class="text-sm font-medium">Agent Out</span>
                            <span class="text-xs text-gray-400">bKash Agent Cash Out</span>
                        </button>
                    </div>

                    <!-- Additional Button - UPDATED: Fixed Help button to redirect to WhatsApp -->
                    <div class="grid grid-cols-1 gap-3">
                        <button onclick="window.open('https://wa.me/8801344889434', '_blank')" class="bee-button p-4 flex flex-col items-center">
                            <div class="icon-container mb-2">
                                <i class="fas fa-question-circle"></i>
                            </div>
                            <span class="text-sm font-medium">Help</span>
                            <span class="text-xs text-gray-400">Get support</span>
                        </button>
                    </div>
                </div>

                <!-- Recent Activity - UPDATED: Show only last 10 items -->
                <div class="bee-card p-6">
                    <h3 class="text-lg font-bold mb-4">Recent Activity</h3>
                    ${renderRecentActivity()}
                </div>
                
                ${user.isLocked ? `
                    <div class="mt-6 p-4 border border-red-800 bg-red-900/20 rounded-xl">
                        <div class="flex items-center">
                            <i class="fas fa-lock text-red-400 mr-3"></i>
                            <div>
                                <p class="text-red-400 font-medium">Account Locked</p>
                                <p class="text-sm text-gray-400">Contact administration to unlock your account</p>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // Render Agent Out Form
        function renderAgentOutForm() {
            if (currentUser.isLocked) {
                return renderLockedMessage();
            }
            
            return `
                <div class="bee-card p-6">
                    <div class="flex items-center mb-6">
                        <button onclick="setUserCurrentView('dashboard')" class="mr-4 text-gray-400 hover:text-white">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h2 class="text-xl font-bold">bKash Agent Cash Out</h2>
                    </div>
                    
                    <form id="agentOutForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">bKash Agent Number</label>
                            <input type="text" id="agentOutAccount" class="bee-input" placeholder="e.g., 017xxxxxxxx" pattern="[0-9]{11}" required>
                            <p class="text-xs text-gray-500 mt-1">Enter 11-digit bKash agent number</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Confirm bKash Agent Number</label>
                            <input type="text" id="confirmAgentOutAccount" class="bee-input" placeholder="re-enter account number" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Amount ($)</label>
                            <input type="number" id="agentOutAmount" min="10" step="0.01" max="${currentUser.balance}" class="bee-input" placeholder="0.00" required>
                        </div>
                        
                        <button type="button" onclick="reviewAgentOutTransfer()" class="w-full bee-yellow-button py-3 rounded-xl font-bold text-black">
                            Confirm Transfer
                        </button>
                    </form>
                    
                    <p class="text-xs text-gray-500 mt-4 text-center">*Next, you will review charges and tap to submit.</p>
                </div>
            `;
        }

        // Render Agent Out Review
        function renderAgentOutReview() {
            if (!currentFundTransfer) {
                setUserCurrentView('agentout');
                return '';
            }
            
            const chargePercentage = 0.88;
            const chargeAmount = currentFundTransfer.amount * (chargePercentage / 100);
            const totalDeduction = currentFundTransfer.amount + chargeAmount;
            
            return `
                <div class="bee-card p-6">
                    <div class="flex items-center mb-6">
                        <button onclick="setUserCurrentView('agentout')" class="mr-4 text-gray-400 hover:text-white">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h2 class="text-xl font-bold">Transaction Review</h2>
                    </div>
                    
                    <h3 class="text-lg font-semibold mb-4">Review Details</h3>
                    
                    <div class="space-y-4 mb-6">
                        <div class="review-item">
                            <span class="text-gray-400">Mode</span>
                            <span class="font-medium">bKash Agent Cash Out</span>
                        </div>
                        
                        <div class="review-item">
                            <span class="text-gray-400">Sender (Black Bee)</span>
                            <span class="font-medium">${currentUser.fullName}</span>
                        </div>
                        
                        <div class="review-item">
                            <span class="text-gray-400">Receiver Account</span>
                            <span class="font-medium">${currentFundTransfer.account}</span>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-700 pt-4 mb-6">
                        <h3 class="text-lg font-semibold mb-4">FINANCIAL BREAKDOWN</h3>
                        
                        <div class="space-y-3">
                            <div class="review-item">
                                <span class="text-gray-400">Amount to Transfer</span>
                                <span class="font-bold">${formatCurrency(currentFundTransfer.amount)}</span>
                            </div>
                            
                            <div class="review-item">
                                <span class="text-gray-400">Charges (${chargePercentage}%)</span>
                                <span class="font-bold">${formatCurrency(chargeAmount)}</span>
                            </div>
                            
                            <div class="review-item pt-4 border-t border-gray-700">
                                <span class="text-lg font-bold">Total Deduction</span>
                                <span class="text-xl font-bold yellow-text review-total">${formatCurrency(totalDeduction)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <button id="confirmAgentOutHoldBtn" class="hold-to-pay-btn bee-yellow-button w-full py-4 rounded-xl font-bold text-black relative text-lg">
                        <div class="hold-progress"></div>
                        <div class="relative z-10">
                            <i class="fas fa-hand-holding mr-2"></i>
                            Tap and Hold (2.0s)
                        </div>
                    </button>
                    <p class="text-center text-xs text-gray-500 mt-2">Hold for 2 seconds to confirm transfer</p>
                </div>
            `;
        }

        // Render User Loan Request Page
        function renderUserLoanRequest() {
            if (currentUser.isLocked) {
                return renderLockedMessage();
            }
            
            if (currentUser.loanActive) {
                return `
                    <div class="bee-card p-6 text-center">
                        <div class="w-16 h-16 bg-yellow-900/30 border border-yellow-800 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-exclamation-triangle text-yellow-400 text-2xl"></i>
                        </div>
                        <h2 class="text-xl font-bold mb-2">Active Loan Exists</h2>
                        <p class="text-gray-400 mb-4">You already have an active loan of ${formatCurrency(currentUser.loanAmount)}. Please repay your existing loan before applying for a new one.</p>
                        <button onclick="setUserCurrentView('loan')" class="bee-yellow-button w-full py-3 rounded-xl font-bold text-black mb-3">
                            Manage Existing Loan
                        </button>
                        <button onclick="setUserCurrentView('dashboard')" class="bee-button w-full py-3 rounded-xl font-medium">
                            Back to Dashboard
                        </button>
                    </div>
                `;
            }
            
            const userType = userTypes[currentUser.userType] || userTypes['starter'];
            const eligibleAmount = userType.loanEligibleAmount;
            const eligibleTerms = userType.loanEligibleTerms;
            
            return `
                <div class="bee-card p-6">
                    <div class="flex items-center mb-6">
                        <button onclick="setUserCurrentView('dashboard')" class="mr-4 text-gray-400 hover:text-white">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h2 class="text-xl font-bold">Loan Request</h2>
                    </div>
                    
                    <div class="mb-6 p-4 border border-yellow-800 bg-yellow-900/20 rounded-xl">
                        <div class="flex items-center">
                            <i class="fas fa-info-circle text-yellow-400 mr-3"></i>
                            <div>
                                <p class="text-yellow-400 font-medium">Eligible Loan Amount</p>
                                <p class="text-2xl font-bold">${formatCurrency(eligibleAmount)}</p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <p class="text-gray-400 text-sm">Eligible Terms: ${eligibleTerms.map(term => `${term} Month${term > 1 ? 's' : ''}`).join(', ')}</p>
                        </div>
                    </div>
                    
                    <form id="loanRequestForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Enter Loan Amount</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                    <i class="fas fa-dollar-sign"></i>
                                </span>
                                <input type="number" id="loanAmount" min="10" max="${eligibleAmount}" step="10" class="bee-input pl-10" placeholder="Enter loan amount" required>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Maximum: ${formatCurrency(eligibleAmount)}</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Select Term</label>
                            <div class="grid grid-cols-2 gap-3">
                                ${eligibleTerms.map(term => `
                                    <div class="loan-term-option" onclick="selectLoanTerm(${term})" id="term-${term}">
                                        <div class="text-lg font-bold">${term} Month${term > 1 ? 's' : ''}</div>
                                        <div class="text-xs text-gray-400">Repayment Term</div>
                                    </div>
                                `).join('')}
                            </div>
                            <input type="hidden" id="selectedTerm" value="">
                        </div>
                        
                        <button type="button" onclick="calculateLoanDetails()" class="w-full bee-yellow-button py-3 rounded-xl font-bold text-black">
                            Proceed to Loan Details
                        </button>
                    </form>
                </div>
            `;
        }

        // Render User Loan Details Page
        function renderUserLoanDetails() {
            if (!currentLoanRequest) {
                setUserCurrentView('loanrequest');
                return '';
            }
            
            const principal = currentLoanRequest.amount;
            const termMonths = currentLoanRequest.term;
            
            // Calculate loan details using the given formulas
            const bankFeeRate = 0.004; // 0.4%
            const chargesRate = 0.005; // 0.5%
            
            const bankFee = principal * bankFeeRate;
            const charges = principal * chargesRate * termMonths;
            const totalRepayment = principal + bankFee + charges;
            const monthlyInstallment = totalRepayment / termMonths;
            
            currentLoanRequest.bankFee = bankFee;
            currentLoanRequest.charges = charges;
            currentLoanRequest.totalRepayment = totalRepayment;
            currentLoanRequest.monthlyInstallment = monthlyInstallment;
            currentLoanRequest.startDate = new Date().toISOString().split('T')[0];
            
            return `
                <div class="bee-card p-6">
                    <div class="flex items-center mb-6">
                        <button onclick="setUserCurrentView('loanrequest')" class="mr-4 text-gray-400 hover:text-white">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h2 class="text-xl font-bold">Loan Details</h2>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-4">Loan From</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">Taking Date</span>
                                <span class="font-medium">${new Date().toLocaleDateString()}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">Provider</span>
                                <span class="font-medium yellow-text">WebeemeX</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-700 pt-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4">AMOUNT DETAILS</h3>
                        <div class="space-y-4">
                            <div class="review-item">
                                <span class="text-gray-400">Loan Taken</span>
                                <span class="font-bold">${formatCurrency(principal)}</span>
                            </div>
                            <div class="review-item">
                                <span class="text-gray-400">Bank Fee (0.4%)</span>
                                <span class="font-bold text-green-400">+ ${formatCurrency(bankFee)}</span>
                            </div>
                            <div class="review-item">
                                <span class="text-gray-400">Charges (0.5% × ${termMonths} months)</span>
                                <span class="font-bold text-green-400">+ ${formatCurrency(charges)}</span>
                            </div>
                            <div class="review-item pt-4 border-t border-gray-700">
                                <span class="text-lg font-bold">Net Repayment Amount</span>
                                <span class="text-xl font-bold yellow-text review-total">${formatCurrency(totalRepayment)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="showInstallmentPlan()" class="w-full bee-yellow-button py-3 rounded-xl font-bold text-black">
                        Proceed to Installment Plan
                    </button>
                </div>
            `;
        }

        // Render User Installment Plan Page
        function renderUserInstallmentPlan() {
            if (!currentLoanRequest) {
                setUserCurrentView('loanrequest');
                return '';
            }
            
            const { amount, term, totalRepayment, monthlyInstallment, startDate } = currentLoanRequest;
            
            // Generate installment dates (like the demo: 13/07/2026, 13/08/2026, etc.)
            const installments = [];
            const start = new Date(startDate);
            // Set to 13th of the month as shown in demo
            start.setDate(13);
            
            for (let i = 1; i <= term; i++) {
                const dueDate = new Date(start);
                dueDate.setMonth(dueDate.getMonth() + i);
                
                // Format as DD/MM/YYYY
                const formattedDate = dueDate.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                
                installments.push({
                    month: i,
                    dueDate: formattedDate,
                    amount: monthlyInstallment,
                    status: 'pending',
                    dueTimestamp: dueDate.getTime(),
                    paidDate: null,
                    isOverdue: false
                });
            }
            
            currentLoanRequest.installments = installments;
            
            return `
                <div class="bee-card p-6">
                    <div class="flex items-center mb-6">
                        <button onclick="setUserCurrentView('loandetails')" class="mr-4 text-gray-400 hover:text-white">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h2 class="text-xl font-bold">Installment Plan</h2>
                    </div>
                    
                    <div class="mb-6 text-center">
                        <h3 class="text-lg font-bold mb-2">Total Repayment Amount</h3>
                        <div class="text-3xl font-bold yellow-text">${formatCurrency(totalRepayment)}</div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-4">REPAYMENT SCHEDULE (${term} MONTHS)</h3>
                        <div class="space-y-3">
                            ${installments.map((installment, index) => `
                                <div class="loan-installment-item pending">
                                    <div class="flex items-center">
                                        <div class="loan-installment-checkbox mr-3" id="check-${index}">
                                            <i class="fas fa-check text-black text-xs hidden"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium">${installment.dueDate}</p>
                                            <p class="text-sm text-gray-400">Month ${installment.month}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold">${formatCurrency(installment.amount)}</p>
                                        <p class="text-xs text-gray-400">Monthly Installment</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <button onclick="showLoanConfirmation()" class="w-full bee-yellow-button py-3 rounded-xl font-bold text-black">
                        Confirm Loan Request
                    </button>
                </div>
            `;
        }

        // Render User Loan Confirmation Page
        function renderUserLoanConfirm() {
            if (!currentLoanRequest) {
                setUserCurrentView('loanrequest');
                return '';
            }
            
            const { amount, term, totalRepayment, monthlyInstallment, installments } = currentLoanRequest;
            
            // Get first 6 installments for display
            const displayInstallments = installments.slice(0, 6);
            
            return `
                <div class="bee-card p-6">
                    <div class="flex items-center mb-6">
                        <button onclick="setUserCurrentView('loaninstallment')" class="mr-4 text-gray-400 hover:text-white">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h2 class="text-xl font-bold">Confirm Loan Request</h2>
                    </div>
                    
                    <div class="mb-6 text-center">
                        <div class="text-2xl font-bold yellow-text mb-2">${formatCurrency(amount)}</div>
                        <p class="text-gray-400">Loan Amount for ${term} Month${term > 1 ? 's' : ''}</p>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-4">REPAYMENT SCHEDULE</h3>
                        <div class="space-y-3">
                            ${displayInstallments.map(installment => `
                                <div class="flex justify-between items-center p-3 border border-gray-800 rounded-lg">
                                    <div>
                                        <p class="font-medium">${installment.dueDate}</p>
                                        <p class="text-sm text-gray-400">Month ${installment.month}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold">${formatCurrency(installment.amount)}</p>
                                    </div>
                                </div>
                            `).join('')}
                            ${installments.length > 6 ? `
                                <div class="text-center text-gray-500 text-sm">
                                    + ${installments.length - 6} more installments
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="mb-6 p-4 border border-green-800 bg-green-900/20 rounded-xl">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-400 text-sm">Total Repayment</p>
                                <p class="text-xl font-bold">${formatCurrency(totalRepayment)}</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-sm">Monthly Payment</p>
                                <p class="text-xl font-bold yellow-text">${formatCurrency(monthlyInstallment)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="submitLoanRequest()" class="w-full bee-yellow-button py-3 rounded-xl font-bold text-black">
                        Confirm and Submit Request
                    </button>
                </div>
            `;
        }

        // Render User Loan Management Page
        function renderUserLoanManagement() {
            if (!currentUser.loanActive) {
                setUserCurrentView('dashboard');
                return '';
            }
            
            // Find active loan request
            const activeLoan = localLoanRequests.find(loan => 
                loan.userId === currentUser.id && 
                loan.status === 'approved' &&
                loan.isActive
            );
            
            if (!activeLoan) {
                return `
                    <div class="bee-card p-6 text-center">
                        <div class="w-16 h-16 bg-yellow-900/30 border border-yellow-800 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-exclamation-triangle text-yellow-400 text-2xl"></i>
                        </div>
                        <h2 class="text-xl font-bold mb-2">No Active Loan Found</h2>
                        <p class="text-gray-400 mb-4">You don't have an active loan at the moment.</p>
                        <button onclick="setUserCurrentView('dashboard')" class="bee-yellow-button w-full py-3 rounded-xl font-bold text-black">
                            Back to Dashboard
                        </button>
                    </div>
                `;
            }
            
            // Check and update installment statuses
            const updatedInstallments = checkInstallmentStatuses(activeLoan.installments || []);
            const remainingBalance = calculateRemainingBalance(updatedInstallments);
            const paidInstallments = updatedInstallments.filter(i => i.status === 'paid').length;
            const totalInstallments = activeLoan.term;
            const isFullyPaid = remainingBalance <= 0;
            
            return `
                <div class="bee-card p-6">
                    <div class="flex items-center mb-6">
                        <button onclick="setUserCurrentView('dashboard')" class="mr-4 text-gray-400 hover:text-white">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h2 class="text-xl font-bold">Loan Management</h2>
                    </div>
                    
                    <div class="mb-6">
                        <div class="p-4 border border-yellow-800 bg-yellow-900/20 rounded-xl">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <p class="text-gray-400 text-sm">Loan Amount</p>
                                    <p class="text-2xl font-bold yellow-text">${formatCurrency(activeLoan.amount)}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-gray-400 text-sm">Term</p>
                                    <p class="text-2xl font-bold">${activeLoan.term} Month${activeLoan.term > 1 ? 's' : ''}</p>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="flex justify-between text-sm text-gray-400 mb-1">
                                    <span>Repayment Progress</span>
                                    <span>${paidInstallments}/${totalInstallments} Installments</span>
                                </div>
                                <div class="w-full bg-gray-800 rounded-full h-2.5">
                                    <div class="bg-yellow-500 h-2.5 rounded-full" style="width: ${(paidInstallments / totalInstallments) * 100}%"></div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-gray-400 text-sm">Total Repayment</p>
                                    <p class="text-lg font-bold">${formatCurrency(activeLoan.totalRepayment)}</p>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-sm">Remaining Balance</p>
                                    <p class="text-lg font-bold ${remainingBalance > 0 ? 'text-red-400' : 'text-green-400'}">${formatCurrency(remainingBalance)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-4">INSTALLMENT STATUS</h3>
                        <p class="text-gray-400 text-sm mb-4"><i class="fas fa-info-circle mr-2"></i>Auto-deduction for installments is enabled. If you miss the due date by 3 days, it will be auto-cut from your balance.</p>
                        
                        <div class="space-y-3">
                            ${updatedInstallments.map((installment, index) => {
                                const isPaid = installment.status === 'paid';
                                const isOverdue = installment.status === 'overdue';
                                const isPending = installment.status === 'pending';
                                const dueDate = new Date(installment.dueTimestamp);
                                const now = new Date();
                                const canPay = isPending || isOverdue;
                                
                                return `
                                    <div class="loan-installment-item ${isPaid ? 'paid' : isOverdue ? 'overdue' : 'pending'}">
                                        <div class="flex items-center">
                                            <div class="loan-installment-checkbox mr-3 ${isPaid ? 'checked' : ''}">
                                                <i class="fas fa-check text-black text-xs ${isPaid ? '' : 'hidden'}"></i>
                                            </div>
                                            <div>
                                                <p class="font-medium">${installment.dueDate}</p>
                                                <p class="text-sm ${isPaid ? 'text-green-400' : isOverdue ? 'text-red-400' : 'text-yellow-400'}">
                                                    ${isPaid ? 'Paid' : isOverdue ? 'Overdue - Auto-cut in progress' : 'Scheduled'}
                                                </p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-bold">${formatCurrency(installment.amount)}</p>
                                            ${canPay ? `
                                                <button onclick="payInstallment('${activeLoan.docId}', ${index})" class="installment-pay-btn mt-1" 
                                                    ${currentUser.balance < installment.amount ? 'disabled' : ''}>
                                                    Pay Now
                                                </button>
                                            ` : `
                                                <p class="text-xs text-green-400 mt-1">Paid on ${installment.paidDate || 'N/A'}</p>
                                            `}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    ${remainingBalance > 0 ? `
                        <div class="mt-6 pt-6 border-t border-gray-700">
                            <h3 class="text-lg font-bold mb-4">Clear Entire Loan</h3>
                            <p class="text-gray-400 text-sm mb-4">Pay off the remaining balance of ${formatCurrency(remainingBalance)} in one payment.</p>
                            <button onclick="clearLoan('${activeLoan.docId}')" class="clear-loan-btn w-full py-3 rounded-xl font-bold">
                                <i class="fas fa-check-circle mr-2"></i>
                                Clear Loan (Simulate Payoff)
                            </button>
                            <p class="text-xs text-gray-500 mt-2 text-center">*This will deduct ${formatCurrency(remainingBalance)} from your balance</p>
                        </div>
                    ` : `
                        <div class="p-4 border border-green-800 bg-green-900/20 rounded-xl text-center">
                            <i class="fas fa-check-circle text-green-400 text-2xl mb-2"></i>
                            <h3 class="text-lg font-bold mb-1">Loan Fully Paid!</h3>
                            <p class="text-gray-400">Congratulations! You have successfully paid off your entire loan.</p>
                        </div>
                    `}
                </div>
            `;
        }

        // Helper function to check installment statuses
        function checkInstallmentStatuses(installments) {
            const now = new Date().getTime();
            const threeDaysMs = 3 * 24 * 60 * 60 * 1000; // 3 days in milliseconds
            
            return installments.map(installment => {
                if (installment.status === 'paid') return installment;
                
                const dueTimestamp = installment.dueTimestamp || new Date(installment.dueDate.split('/').reverse().join('-')).getTime();
                
                // If overdue by more than 3 days, auto-deduct if possible
                if (now > dueTimestamp + threeDaysMs) {
                    // Auto-deduct logic
                    if (currentUser.balance >= installment.amount) {
                        // Auto pay the installment
                        autoPayInstallment(installment);
                        return {
                            ...installment,
                            status: 'paid',
                            paidDate: new Date().toLocaleDateString('en-GB'),
                            dueTimestamp: dueTimestamp
                        };
                    } else {
                        return {
                            ...installment,
                            status: 'overdue',
                            dueTimestamp: dueTimestamp
                        };
                    }
                }
                
                return {
                    ...installment,
                    status: 'pending',
                    dueTimestamp: dueTimestamp
                };
            });
        }

        // Helper function to calculate remaining balance
        function calculateRemainingBalance(installments) {
            return installments
                .filter(i => i.status !== 'paid')
                .reduce((total, i) => total + i.amount, 0);
        }

        // Function to auto-pay an installment
        async function autoPayInstallment(installment) {
            try {
                // Find active loan
                const activeLoan = localLoanRequests.find(loan => 
                    loan.userId === currentUser.id && 
                    loan.status === 'approved' &&
                    loan.isActive
                );
                
                if (!activeLoan) return;
                
                // Update user balance
                const userDocId = getFirestoreDocId(currentUser.id);
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userDocId);
                await updateDoc(userRef, {
                    balance: currentUser.balance - installment.amount
                });
                
                // Update loan installment status
                const loanRef = doc(db, 'artifacts', appId, 'public', 'data', 'loanRequests', activeLoan.docId);
                const updatedInstallments = activeLoan.installments.map(inst => {
                    if (inst.dueDate === installment.dueDate) {
                        return {
                            ...inst,
                            status: 'paid',
                            paidDate: new Date().toLocaleDateString('en-GB')
                        };
                    }
                    return inst;
                });
                
                await updateDoc(loanRef, {
                    installments: updatedInstallments
                });
                
                // Record in history
                const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'fundHistory');
                await addDoc(historyRef, {
                    id: Date.now(),
                    userId: currentUser.id,
                    username: currentUser.username,
                    amount: installment.amount,
                    type: 'loan_installment',
                    method: 'auto_deduction',
                    transactionDetails: `Loan installment auto-deduction for ${installment.dueDate}`,
                    timestamp: new Date().toISOString(),
                    status: 'completed'
                });
                
                // Update local state
                currentUser.balance -= installment.amount;
                
            } catch (error) {
                console.error('Auto pay installment error:', error);
            }
        }

        // Function to pay a single installment
        async function payInstallment(loanId, installmentIndex) {
            const loan = localLoanRequests.find(l => l.docId === loanId);
            if (!loan || !loan.installments || !loan.installments[installmentIndex]) {
                showToast('Error', 'Installment not found', 'error');
                return;
            }
            
            const installment = loan.installments[installmentIndex];
            
            if (installment.status === 'paid') {
                showToast('Info', 'This installment is already paid', 'info');
                return;
            }
            
            if (currentUser.balance < installment.amount) {
                showToast('Error', `Insufficient balance. Need ${formatCurrency(installment.amount)}`, 'error');
                return;
            }
            
            try {
                showDBLoading();
                
                // Update user balance
                const userDocId = getFirestoreDocId(currentUser.id);
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userDocId);
                await updateDoc(userRef, {
                    balance: currentUser.balance - installment.amount
                });
                
                // Update loan installment status
                const loanRef = doc(db, 'artifacts', appId, 'public', 'data', 'loanRequests', loanId);
                const updatedInstallments = [...loan.installments];
                updatedInstallments[installmentIndex] = {
                    ...updatedInstallments[installmentIndex],
                    status: 'paid',
                    paidDate: new Date().toLocaleDateString('en-GB')
                };
                
                // Check if loan is fully paid
                const allPaid = updatedInstallments.every(inst => inst.status === 'paid');
                if (allPaid) {
                    await updateDoc(userRef, {
                        loanActive: false,
                        loanAmount: 0
                    });
                    
                    await updateDoc(loanRef, {
                        isActive: false,
                        paidAmount: loan.totalRepayment,
                        paidInstallments: loan.term
                    });
                }
                
                await updateDoc(loanRef, {
                    installments: updatedInstallments,
                    paidAmount: (loan.paidAmount || 0) + installment.amount,
                    paidInstallments: (loan.paidInstallments || 0) + 1
                });
                
                // Record in history
                const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'fundHistory');
                await addDoc(historyRef, {
                    id: Date.now(),
                    userId: currentUser.id,
                    username: currentUser.username,
                    amount: installment.amount,
                    type: 'loan_installment',
                    method: 'manual_payment',
                    transactionDetails: `Loan installment payment for ${installment.dueDate}`,
                    timestamp: new Date().toISOString(),
                    status: 'completed'
                });
                
                // Create inbox message - UPDATED: 3 days expiry
                const inboxRef = collection(db, 'artifacts', appId, 'public', 'data', 'inboxMessages');
                const expiresAt = new Date();
                expiresAt.setDate(expiresAt.getDate() + 3); // FIXED: Changed from 7 to 3 days
                
                await addDoc(inboxRef, {
                    userId: currentUser.id,
                    title: 'Loan Installment Paid',
                    message: `Your loan installment of ${formatCurrency(installment.amount)} for ${installment.dueDate} has been successfully paid.`,
                    status: 'successful',
                    type: 'loan_payment',
                    isRead: false,
                    timestamp: new Date().toISOString(),
                    expiresAt: expiresAt.toISOString()
                });
                
                hideDBLoading();
                
                // Update local state
                currentUser.balance -= installment.amount;
                
                // Check if loan is now fully paid
                if (allPaid) {
                    currentUser.loanActive = false;
                    currentUser.loanAmount = 0;
                    showSuccessPage('clearloan', loan.totalRepayment);
                } else {
                    showSuccessPage('installment', installment.amount);
                }
                
                // Refresh the view
                setTimeout(() => {
                    renderUserPanel();
                }, 2000);
                
            } catch (error) {
                console.error('Pay installment error:', error);
                hideDBLoading();
                showToast('Error', 'Failed to process installment payment', 'error');
            }
        }

        // Function to clear entire loan
        async function clearLoan(loanId) {
            const loan = localLoanRequests.find(l => l.docId === loanId);
            if (!loan) {
                showToast('Error', 'Loan not found', 'error');
                return;
            }
            
            // Calculate remaining balance
            const remainingInstallments = loan.installments?.filter(inst => inst.status !== 'paid') || [];
            const remainingBalance = remainingInstallments.reduce((total, inst) => total + inst.amount, 0);
            
            if (remainingBalance <= 0) {
                showToast('Info', 'Loan is already fully paid', 'info');
                return;
            }
            
            if (currentUser.balance < remainingBalance) {
                showToast('Error', `Insufficient balance. Need ${formatCurrency(remainingBalance)}`, 'error');
                return;
            }
            
            // Confirm with user
            if (!confirm(`Are you sure you want to pay off your entire loan? This will deduct ${formatCurrency(remainingBalance)} from your balance.`)) {
                return;
            }
            
            try {
                showDBLoading();
                
                // Update user balance
                const userDocId = getFirestoreDocId(currentUser.id);
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userDocId);
                await updateDoc(userRef, {
                    balance: currentUser.balance - remainingBalance,
                    loanActive: false,
                    loanAmount: 0
                });
                
                // Update loan status
                const loanRef = doc(db, 'artifacts', appId, 'public', 'data', 'loanRequests', loanId);
                const updatedInstallments = loan.installments.map(inst => ({
                    ...inst,
                    status: 'paid',
                    paidDate: new Date().toLocaleDateString('en-GB')
                }));
                
                await updateDoc(loanRef, {
                    installments: updatedInstallments,
                    isActive: false,
                    paidAmount: loan.totalRepayment,
                    paidInstallments: loan.term
                });
                
                // Record in history
                const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'fundHistory');
                await addDoc(historyRef, {
                    id: Date.now(),
                    userId: currentUser.id,
                    username: currentUser.username,
                    amount: remainingBalance,
                    type: 'loan_payoff',
                    method: 'full_payment',
                    transactionDetails: `Full loan payoff - ${remainingInstallments.length} installments`,
                    timestamp: new Date().toISOString(),
                    status: 'completed'
                });
                
                // Create inbox message - UPDATED: 3 days expiry
                const inboxRef = collection(db, 'artifacts', appId, 'public', 'data', 'inboxMessages');
                const expiresAt = new Date();
                expiresAt.setDate(expiresAt.getDate() + 3); // FIXED: Changed from 7 to 3 days
                
                await addDoc(inboxRef, {
                    userId: currentUser.id,
                    title: 'Loan Fully Paid',
                    message: `Congratulations! You have successfully paid off your entire loan of ${formatCurrency(loan.totalRepayment)}.`,
                    status: 'successful',
                    type: 'loan_payment',
                    isRead: false,
                    timestamp: new Date().toISOString(),
                    expiresAt: expiresAt.toISOString()
                });
                
                hideDBLoading();
                
                // Update local state
                currentUser.balance -= remainingBalance;
                currentUser.loanActive = false;
                currentUser.loanAmount = 0;
                
                showSuccessPage('clearloan', remainingBalance);
                
                // Refresh the view
                setTimeout(() => {
                    renderUserPanel();
                }, 2000);
                
            } catch (error) {
                console.error('Clear loan error:', error);
                hideDBLoading();
                showToast('Error', 'Failed to process loan payoff', 'error');
            }
        }

        // Render Fund Transfer Options
        function renderFundTransferOptions() {
            if (currentUser.isLocked) {
                return renderLockedMessage();
            }
            
            return `
                <div class="bee-card p-6">
                    <h2 class="text-xl font-bold mb-6">Fund Transfer</h2>
                    <p class="text-gray-400 mb-6">Choose Transfer Method</p>
                    
                    <div class="space-y-4">
                        <div onclick="startBkashTransfer()" class="transfer-option-card">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-green-900/30 rounded-xl flex items-center justify-center mr-4">
                                        <i class="fas fa-mobile-alt text-green-400 text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg">bKash Personal</h3>
                                        <p class="text-gray-400 text-sm">Send money to any bKash personal account</p>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right text-gray-400"></i>
                            </div>
                        </div>
                        
                        <div onclick="startBankTransfer()" class="transfer-option-card">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-blue-900/30 rounded-xl flex items-center justify-center mr-4">
                                        <i class="fas fa-university text-blue-400 text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg">Bank Transfer (BEFTN)</h3>
                                        <p class="text-gray-400 text-sm">Transfer funds to a bank account. Takes max 5 hours to complete.</p>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 p-4 bg-gray-900/50 rounded-xl">
                        <div class="flex items-center">
                            <i class="fas fa-wallet text-yellow-400 mr-3"></i>
                            <div>
                                <p class="text-gray-400 text-sm">Available Balance</p>
                                <p class="text-xl font-bold yellow-text">${formatCurrency(currentUser.balance)}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render Bkash Transfer Form - UPDATED: Uses linked profile
        function renderBkashTransferForm() {
            if (currentUser.isLocked) {
                return renderLockedMessage();
            }
            
            // Check if user has linked bKash account
            if (!currentUser.bkashAccount) {
                return `
                    <div class="bee-card p-6">
                        <div class="flex items-center mb-6">
                            <button onclick="setUserCurrentView('fundtransfer')" class="mr-4 text-gray-400 hover:text-white">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <h2 class="text-xl font-bold">bKash Personal</h2>
                        </div>
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-triangle text-3xl text-yellow-500 mb-3"></i>
                            <p class="text-gray-400">No linked bKash account found.</p>
                            <p class="text-sm text-gray-500">Please contact administration to link your bKash account.</p>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="bee-card p-6">
                    <div class="flex items-center mb-6">
                        <button onclick="setUserCurrentView('fundtransfer')" class="mr-4 text-gray-400 hover:text-white">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h2 class="text-xl font-bold">bKash Personal</h2>
                    </div>
                    
                    <form id="bkashForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Linked bKash Account</label>
                            <input type="text" class="bee-input bee-input-disabled" value="${currentUser.bkashAccount}" readonly>
                            <p class="text-xs text-gray-500 mt-1">This is your linked bKash account. Contact admin to change.</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Amount ($)</label>
                            <input type="number" id="bkashAmount" min="10" step="0.01" max="${currentUser.balance}" class="bee-input" placeholder="0.00" required>
                        </div>
                        
                        <button type="button" onclick="reviewBkashTransfer()" class="w-full bee-yellow-button py-3 rounded-xl font-bold text-black">
                            Confirm Transfer
                        </button>
                    </form>
                    
                    <p class="text-xs text-gray-500 mt-4 text-center">*Next, you will review charges and tap to submit.</p>
                </div>
            `;
        }

        // Render Bank Transfer Form - UPDATED: Uses linked profile
        function renderBankTransferForm() {
            if (currentUser.isLocked) {
                return renderLockedMessage();
            }
            
            // Check if user has linked bank account
            if (!currentUser.bankAccount || !currentUser.bankName) {
                return `
                    <div class="bee-card p-6">
                        <div class="flex items-center mb-6">
                            <button onclick="setUserCurrentView('fundtransfer')" class="mr-4 text-gray-400 hover:text-white">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <h2 class="text-xl font-bold">Bank Transfer (BEFTN)</h2>
                        </div>
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-triangle text-3xl text-yellow-500 mb-3"></i>
                            <p class="text-gray-400">No linked bank account found.</p>
                            <p class="text-sm text-gray-500">Please contact administration to link your bank account.</p>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="bee-card p-6">
                    <div class="flex items-center mb-6">
                        <button onclick="setUserCurrentView('fundtransfer')" class="mr-4 text-gray-400 hover:text-white">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h2 class="text-xl font-bold">Bank Transfer (BEFTN)</h2>
                    </div>
                    
                    <form id="bankForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Linked Bank Account</label>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Bank Name</label>
                                    <input type="text" class="bee-input bee-input-disabled" value="${currentUser.bankName}" readonly>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Bank Account Number</label>
                                    <input type="text" class="bee-input bee-input-disabled" value="${currentUser.bankAccount}" readonly>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">This is your linked bank account. Contact admin to change.</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Amount ($)</label>
                            <input type="number" id="bankAmount" min="10" step="0.01" max="${currentUser.balance}" class="bee-input" placeholder="0.00" required>
                        </div>
                        
                        <button type="button" onclick="reviewBankTransfer()" class="w-full bee-yellow-button py-3 rounded-xl font-bold text-black">
                            Confirm Transfer
                        </button>
                    </form>
                    
                    <p class="text-xs text-gray-500 mt-4 text-center">*Next, you will review charges and tap to submit.</p>
                </div>
            `;
        }

        // Render Transfer Review
        function renderTransferReview() {
            if (!currentFundTransfer) {
                setUserCurrentView('fundtransfer');
                return '';
            }
            
            const isBkash = currentFundTransfer.type === 'bkash';
            const isBank = currentFundTransfer.type === 'bank';
            const isAgentOut = currentFundTransfer.type === 'agent_out';
            const chargePercentage = isAgentOut ? 0.88 : (isBkash ? 0 : 0.88);
            const chargeAmount = currentFundTransfer.amount * (chargePercentage / 100);
            const totalDeduction = currentFundTransfer.amount + chargeAmount;
            
            let transferType = '';
            if (isBkash) transferType = 'bKash Personal';
            else if (isBank) transferType = 'Bank Transfer (BEFTN)';
            else if (isAgentOut) transferType = 'bKash Agent Cash Out';
            
            return `
                <div class="bee-card p-6">
                    <div class="flex items-center mb-6">
                        <button onclick="setUserCurrentView(isAgentOut ? 'agentout' : (isBkash ? 'bkashtransfer' : 'banktransfer'))" class="mr-4 text-gray-400 hover:text-white">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h2 class="text-xl font-bold">Transaction Review</h2>
                    </div>
                    
                    <h3 class="text-lg font-semibold mb-4">Review Details</h3>
                    
                    <div class="space-y-4 mb-6">
                        <div class="review-item">
                            <span class="text-gray-400">Mode</span>
                            <span class="font-medium">${transferType}</span>
                        </div>
                        
                        <div class="review-item">
                            <span class="text-gray-400">Sender (Black Bee)</span>
                            <span class="font-medium">${currentUser.fullName}</span>
                        </div>
                        
                        <div class="review-item">
                            <span class="text-gray-400">Receiver Account</span>
                            <span class="font-medium">${isAgentOut ? currentFundTransfer.account : (isBkash ? currentUser.bkashAccount : `${currentUser.bankName} - ${currentUser.bankAccount}`)}</span>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-700 pt-4 mb-6">
                        <h3 class="text-lg font-semibold mb-4">FINANCIAL BREAKDOWN</h3>
                        
                        <div class="space-y-3">
                            <div class="review-item">
                                <span class="text-gray-400">Amount to Transfer</span>
                                <span class="font-bold">${formatCurrency(currentFundTransfer.amount)}</span>
                            </div>
                            
                            <div class="review-item">
                                <span class="text-gray-400">Charges (${chargePercentage}%)</span>
                                <span class="font-bold">${formatCurrency(chargeAmount)}</span>
                            </div>
                            
                            <div class="review-item pt-4 border-t border-gray-700">
                                <span class="text-lg font-bold">Total Deduction</span>
                                <span class="text-xl font-bold yellow-text review-total">${formatCurrency(totalDeduction)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <button id="confirmTransferHoldBtn" class="hold-to-pay-btn bee-yellow-button w-full py-4 rounded-xl font-bold text-black relative text-lg">
                        <div class="hold-progress"></div>
                        <div class="relative z-10">
                            <i class="fas fa-hand-holding mr-2"></i>
                            Tap and Hold (2.0s)
                        </div>
                    </button>
                    <p class="text-center text-xs text-gray-500 mt-2">Hold for 2 seconds to confirm transfer</p>
                </div>
            `;
        }

        // Render Request Sent Page
        function renderRequestSent() {
            if (!currentFundTransfer) {
                setUserCurrentView('fundtransfer');
                return '';
            }
            
            const isAgentOut = currentFundTransfer.type === 'agent_out';
            
            return `
                <div class="bee-card p-6 text-center">
                    <div class="request-sent-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    
                    <h1 class="text-2xl font-bold mb-2">Request Sent!</h1>
                    <p class="text-gray-400 mb-6">Your transaction is now <span class="font-bold text-yellow-500">Pending</span> admin review.</p>
                    
                    <div class="p-4 bg-gray-900/50 rounded-xl mb-6">
                        <h3 class="text-lg font-bold mb-4">TRANSACTION DETAILS</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <p class="text-gray-400 text-sm">Amount</p>
                                <p class="text-2xl font-bold yellow-text">${formatCurrency(currentFundTransfer.amount)}</p>
                            </div>
                            
                            <div>
                                <p class="text-gray-400 text-sm">Receiver (${isAgentOut ? 'agent' : currentFundTransfer.type})</p>
                                <p class="font-medium">${isAgentOut ? currentFundTransfer.account : (currentFundTransfer.type === 'bkash' ? currentUser.bkashAccount : `${currentUser.bankName} - ${currentUser.bankAccount}`)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="setUserCurrentView('inbox')" class="bee-button w-full py-3 rounded-xl font-medium">
                        View Status in Inbox
                    </button>
                    
                    <button onclick="setUserCurrentView('dashboard')" class="mt-3 bee-yellow-button w-full py-3 rounded-xl font-bold text-black">
                        Back to Dashboard
                    </button>
                </div>
            `;
        }

        // Render User Inbox - UPDATED: Show approval/rejection reasons and filter expired messages
        function renderUserInbox() {
            // Filter messages for current user and not expired (3 days)
            const userInbox = localInboxMessages
                .filter(msg => msg.userId === currentUser.id && new Date(msg.expiresAt) > new Date())
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Mark messages as read when viewing inbox
            userInbox.forEach(async (msg) => {
                if (!msg.isRead) {
                    try {
                        const msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'inboxMessages', msg.docId);
                        await updateDoc(msgRef, { isRead: true });
                    } catch (error) {
                        console.error('Error marking message as read:', error);
                    }
                }
            });
            
            return `
                <div class="bee-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Inbox</h2>
                        <span class="text-sm text-gray-400">${userInbox.length} messages</span>
                    </div>
                    
                    ${userInbox.length > 0 ? userInbox.map(msg => {
                        const isProcessing = msg.status === 'processing';
                        const isSuccessful = msg.status === 'successful';
                        const isRejected = msg.status === 'rejected';
                        
                        let statusClass = '';
                        let statusIcon = '';
                        let statusText = '';
                        
                        if (isProcessing) {
                            statusClass = 'inbox-item-processing';
                            statusIcon = '<i class="fas fa-clock text-yellow-500 mr-2"></i>';
                            statusText = 'Processing';
                        } else if (isSuccessful) {
                            statusClass = 'inbox-item-successful';
                            statusIcon = '<i class="fas fa-check-circle text-green-500 mr-2"></i>';
                            statusText = 'Successful';
                        } else if (isRejected) {
                            statusClass = 'inbox-item-rejected';
                            statusIcon = '<i class="fas fa-times-circle text-red-500 mr-2"></i>';
                            statusText = 'Rejected';
                        }
                        
                        // Calculate days until expiry
                        const expiresInDays = Math.ceil((new Date(msg.expiresAt) - new Date()) / (1000 * 60 * 60 * 24));
                        
                        return `
                            <div class="inbox-item ${statusClass}">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <div class="inbox-item-title">
                                            ${statusIcon}${msg.title}
                                        </div>
                                        <p class="text-gray-400 text-sm">${msg.message}</p>
                                        <!-- FIXED: Show approval reason for successful messages -->
                                        ${msg.approvalReason ? `<p class="text-green-400 text-sm mt-2"><strong>Approval Reason:</strong> ${msg.approvalReason}</p>` : ''}
                                        ${msg.rejectionReason ? `<p class="text-red-400 text-sm mt-2"><strong>Rejection Reason:</strong> ${msg.rejectionReason}</p>` : ''}
                                    </div>
                                    <span class="status-badge ${isProcessing ? 'status-pending' : isSuccessful ? 'status-active' : 'status-rejected'}">
                                        ${statusText}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <div class="inbox-item-date">
                                        Submitted: ${new Date(msg.timestamp).toLocaleDateString()} 
                                        (Message expires in ${expiresInDays} days)
                                    </div>
                                    ${!msg.isRead ? '<span class="w-2 h-2 bg-blue-500 rounded-full"></span>' : ''}
                                </div>
                            </div>
                        `;
                    }).join('') : `
                        <div class="text-center py-8">
                            <i class="fas fa-inbox text-4xl text-gray-700 mb-3"></i>
                            <p class="text-gray-500">No messages</p>
                            <p class="text-sm text-gray-600 mt-1">Your inbox is empty</p>
                        </div>
                    `}
                </div>
            `;
        }

        // Render Recent Activity (Updated to include fund transfers) - UPDATED: Show only last 10 items
        function renderRecentActivity() {
            // Get all user transactions (send money, deposits, withdrawals, fund transfers)
            const userHistory = localHistory
                .filter(log => log.userId === currentUser.id)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 10); // FIXED: Changed from 5 to 10 items

            // Get user fund transfers
            const userFundTransfers = localFundTransfers
                .filter(log => log.userId === currentUser.id)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);

            const allActivity = [...userHistory, ...userFundTransfers]
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 10); // FIXED: Show only last 10 items

            if (allActivity.length === 0) {
                return `
                    <div class="text-center py-8">
                        <i class="fas fa-history text-3xl text-gray-700 mb-3"></i>
                        <p class="text-gray-500">No transactions recorded yet</p>
                        <p class="text-sm text-gray-600 mt-1">Make your first transaction to see activity here</p>
                    </div>
                `;
            }

            return allActivity.map(activity => {
                const isDeposit = activity.type === 'deposit';
                const isSendMoney = activity.type === 'sendmoney';
                const isWithdraw = activity.type === 'withdraw';
                const isFundTransfer = activity.hasOwnProperty('transferId') || activity.type === 'fund_transfer';
                const isAgentOut = activity.type === 'agent_out';
                const isLoanPayment = activity.type === 'loan_installment' || activity.type === 'loan_payoff';
                
                let iconClass = '';
                let icon = '';
                let title = '';
                let amountClass = '';
                
                if (isDeposit) {
                    iconClass = 'bg-green-900/30 border-green-800';
                    icon = 'fa-arrow-down';
                    title = 'Deposit';
                    amountClass = 'text-green-400';
                } else if (isSendMoney) {
                    iconClass = 'bg-purple-900/30 border-purple-800';
                    icon = 'fa-exchange-alt';
                    title = 'Send Money';
                    amountClass = 'text-red-400';
                } else if (isWithdraw) {
                    iconClass = 'bg-red-900/30 border-red-800';
                    icon = 'fa-arrow-up';
                    title = 'Withdrawal';
                    amountClass = 'text-red-400';
                } else if (isLoanPayment) {
                    iconClass = 'bg-yellow-900/30 border-yellow-800';
                    icon = 'fa-hand-holding-usd';
                    title = 'Loan Payment';
                    amountClass = 'text-red-400';
                } else if (isFundTransfer) {
                    if (isAgentOut) {
                        iconClass = 'bg-orange-900/30 border-orange-800';
                        icon = 'fa-user-tie';
                        title = 'Agent Out';
                        amountClass = 'text-red-400';
                    } else if (activity.type === 'bkash') {
                        iconClass = 'bg-green-900/30 border-green-800';
                        icon = 'fa-mobile-alt';
                        title = 'bKash Transfer';
                        amountClass = 'text-red-400';
                    } else {
                        iconClass = 'bg-blue-900/30 border-blue-800';
                        icon = 'fa-university';
                        title = 'Bank Transfer';
                        amountClass = 'text-red-400';
                    }
                }
                
                const status = activity.status || 'completed';
                const isPending = status === 'pending';
                
                return `
                    <div class="flex items-center justify-between py-3 border-b border-gray-800 last:border-0">
                        <div class="flex items-center">
                            <div class="icon-container mr-3 ${iconClass}">
                                <i class="fas ${icon} ${isDeposit ? 'text-green-400' : isSendMoney ? 'text-purple-400' : isLoanPayment ? 'text-yellow-400' : isAgentOut ? 'text-orange-400' : isFundTransfer && activity.type === 'bkash' ? 'text-green-400' : isFundTransfer ? 'text-blue-400' : 'text-red-400'}"></i>
                            </div>
                            <div>
                                <p class="font-medium">${title}</p>
                                <p class="text-xs text-gray-400">${new Date(activity.timestamp).toLocaleDateString()}</p>
                                ${isPending ? '<span class="text-xs text-yellow-500 font-medium">Pending</span>' : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold ${amountClass}">${isDeposit ? '+' : '-'} ${formatCurrency(activity.amount)}</p>
                            <p class="text-xs text-gray-400">${activity.method || 'N/A'}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render User History Page (Updated to include fund transfers) - UPDATED: Show only last 10 histories
        function renderUserHistory() {
            // Get send money history
            const userSendMoneyHistory = localSendMoneyHistory
                .filter(log => (log.userId === currentUser.id || log.recipientId === currentUser.id))
                .map(log => ({
                    ...log,
                    transactionType: 'sendmoney',
                    date: new Date(log.timestamp)
                }));

            // Get fund transfer history
            const userFundTransfers = localFundTransfers
                .filter(log => log.userId === currentUser.id)
                .map(log => ({
                    ...log,
                    transactionType: 'fundtransfer',
                    date: new Date(log.timestamp)
                }));

            // Get deposit/withdrawal history
            const userTransactions = localHistory
                .filter(log => log.userId === currentUser.id && (log.type === 'deposit' || log.type === 'withdraw' || log.type === 'loan_installment' || log.type === 'loan_payoff'))
                .map(log => ({
                    ...log,
                    transactionType: log.type,
                    date: new Date(log.timestamp)
                }));

            // Combine all transactions and limit to last 10
            const allTransactions = [...userSendMoneyHistory, ...userFundTransfers, ...userTransactions]
                .sort((a, b) => b.date - a.date)
                .slice(0, 10); // FIXED: Show only last 10 histories

            return `
                <div class="bee-card p-6">
                    <h2 class="text-xl font-bold mb-6">Transaction History (Last 10)</h2>
                    
                    <div class="space-y-4">
                        ${allTransactions.length > 0 ? allTransactions.map(log => {
                            const isSendMoney = log.transactionType === 'sendmoney';
                            const isFundTransfer = log.transactionType === 'fundtransfer';
                            const isDeposit = log.transactionType === 'deposit';
                            const isWithdraw = log.transactionType === 'withdraw';
                            const isLoanPayment = log.transactionType === 'loan_installment' || log.transactionType === 'loan_payoff';
                            const isAgentOut = log.type === 'agent_out';
                            const isSender = log.userId === currentUser.id;
                            
                            let iconClass = '';
                            let icon = '';
                            let title = '';
                            let description = '';
                            let amountClass = '';
                            let statusBadge = '';
                            
                            if (isSendMoney) {
                                const otherUser = isSender ? (log.recipientName || 'User') : (log.senderName || 'User');
                                iconClass = isSender ? 'bg-purple-900/30 border-purple-800' : 'bg-green-900/30 border-green-800';
                                icon = isSender ? 'fa-arrow-up' : 'fa-arrow-down';
                                title = isSender ? `Sent to ${otherUser}` : `Received from ${otherUser}`;
                                description = isSender ? 'Money Transfer' : 'Money Received';
                                amountClass = isSender ? 'text-red-400' : 'text-green-400';
                                statusBadge = '<span class="status-badge status-active">Completed</span>';
                            } else if (isFundTransfer) {
                                if (isAgentOut) {
                                    iconClass = 'bg-orange-900/30 border-orange-800';
                                    icon = 'fa-user-tie';
                                    title = 'Agent Out';
                                    description = `To: ${log.account}`;
                                } else if (log.type === 'bkash') {
                                    iconClass = 'bg-green-900/30 border-green-800';
                                    icon = 'fa-mobile-alt';
                                    title = 'bKash Transfer';
                                    description = `To: ${log.account}`;
                                } else {
                                    iconClass = 'bg-blue-900/30 border-blue-800';
                                    icon = 'fa-university';
                                    title = 'Bank Transfer';
                                    description = `To: ${log.account}`;
                                }
                                amountClass = 'text-red-400';
                                
                                if (log.status === 'pending') {
                                    statusBadge = '<span class="status-badge status-pending">Pending</span>';
                                } else if (log.status === 'successful') {
                                    statusBadge = '<span class="status-badge status-active">Completed</span>';
                                } else if (log.status === 'rejected') {
                                    statusBadge = '<span class="status-badge status-rejected">Rejected</span>';
                                }
                            } else if (isDeposit) {
                                iconClass = 'bg-green-900/30 border-green-800';
                                icon = 'fa-arrow-down';
                                title = 'Deposit';
                                description = log.method || 'N/A';
                                amountClass = 'text-green-400';
                                statusBadge = log.status === 'pending' ? '<span class="status-badge status-pending">Pending</span>' : '<span class="status-badge status-active">Completed</span>';
                            } else if (isWithdraw) {
                                iconClass = 'bg-red-900/30 border-red-800';
                                icon = 'fa-arrow-up';
                                title = 'Withdrawal';
                                description = log.method || 'N/A';
                                amountClass = 'text-red-400';
                                statusBadge = log.status === 'pending' ? '<span class="status-badge status-pending">Pending</span>' : '<span class="status-badge status-active">Completed</span>';
                            } else if (isLoanPayment) {
                                iconClass = 'bg-yellow-900/30 border-yellow-800';
                                icon = 'fa-hand-holding-usd';
                                title = log.transactionType === 'loan_payoff' ? 'Loan Payoff' : 'Loan Installment';
                                description = log.transactionDetails || 'Loan Payment';
                                amountClass = 'text-red-400';
                                statusBadge = '<span class="status-badge status-active">Completed</span>';
                            }
                            
                            return `
                                <div class="flex items-center justify-between p-3 border border-gray-800 rounded-xl">
                                    <div class="flex items-center">
                                        <div class="icon-container mr-3 ${iconClass}">
                                            <i class="fas ${icon} ${isSendMoney && isSender ? 'text-purple-400' : isSendMoney && !isSender ? 'text-green-400' : isLoanPayment ? 'text-yellow-400' : isAgentOut ? 'text-orange-400' : isFundTransfer && log.type === 'bkash' ? 'text-green-400' : isFundTransfer ? 'text-blue-400' : isDeposit ? 'text-green-400' : 'text-red-400'}"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium">${title}</p>
                                            <p class="text-xs text-gray-400">${description}</p>
                                            <p class="text-xs text-gray-400">${new Date(log.timestamp).toLocaleString()}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold ${amountClass}">${isSendMoney && !isSender ? '+' : isDeposit ? '+' : '-'} ${formatCurrency(log.amount)}</p>
                                        ${statusBadge}
                                    </div>
                                </div>
                            `;
                        }).join('') : `
                            <div class="text-center py-8">
                                <i class="fas fa-history text-3xl text-gray-700 mb-3"></i>
                                <p class="text-gray-500">No transaction history</p>
                                <p class="text-sm text-gray-600 mt-1">Your transactions will appear here</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // Render User Deposit Page (UPDATED with conditional fields)
        function renderUserDeposit() {
            if (currentUser.isLocked) {
                return renderLockedMessage();
            }
            
            return `
                <div class="bee-card p-6">
                    <h2 class="text-xl font-bold mb-6">Add Money</h2>
                    
                    <form id="depositForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-3">Payment Method</label>
                            <div class="grid grid-cols-3 gap-3">
                                <label class="bee-button p-3 flex flex-col items-center cursor-pointer" id="bkashLabel">
                                    <input type="radio" name="depositMethod" value="bkash" class="hidden" required onchange="showDepositFields('bkash')">
                                    <i class="fas fa-mobile-alt text-xl mb-2"></i>
                                    <span class="text-sm">Bkash</span>
                                </label>
                                
                                <label class="bee-button p-3 flex flex-col items-center cursor-pointer" id="nagadLabel">
                                    <input type="radio" name="depositMethod" value="nagad" class="hidden" onchange="showDepositFields('nagad')">
                                    <i class="fas fa-wallet text-xl mb-2"></i>
                                    <span class="text-sm">Nagad</span>
                                </label>
                                
                                <label class="bee-button p-3 flex flex-col items-center cursor-pointer" id="bankLabel">
                                    <input type="radio" name="depositMethod" value="bank" class="hidden" onchange="showDepositFields('bank')">
                                    <i class="fas fa-university text-xl mb-2"></i>
                                    <span class="text-sm">Bank</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Bkash/Nagad Fields (Initially hidden) -->
                        <div id="bkashNagadFields" class="space-y-4 hidden">
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Name</label>
                                <input type="text" id="bkashName" class="bee-input" placeholder="Enter your name">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Transaction ID/Account Number</label>
                                <input type="text" id="bkashTrxId" class="bee-input" placeholder="Enter Transaction ID/Account Number">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Amount ($)</label>
                                <input type="number" id="bkashDepositAmount" min="10" step="0.01" class="bee-input" placeholder="Enter amount">
                            </div>
                        </div>
                        
                        <!-- Bank Fields (Initially hidden) -->
                        <div id="bankFields" class="space-y-4 hidden">
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Bank Name</label>
                                <input type="text" id="bankDepositName" class="bee-input" placeholder="Enter bank name">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Bank AC Number</label>
                                <input type="text" id="bankDepositAc" class="bee-input" placeholder="Enter bank account number">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Amount ($)</label>
                                <input type="number" id="bankDepositAmount" min="10" step="0.01" class="bee-input" placeholder="Enter amount">
                            </div>
                        </div>
                        
                        <!-- Common amount field (fallback) -->
                        <div id="commonAmountField" class="hidden">
                            <label class="block text-sm font-medium text-gray-400 mb-2">Amount ($)</label>
                            <input type="number" id="depositAmount" min="10" step="0.01" class="bee-input" placeholder="Enter amount">
                        </div>
                        
                        <button type="button" id="depositHoldButton" class="hold-to-pay-btn bee-yellow-button w-full py-3 rounded-xl font-bold text-black relative hidden">
                            <div class="hold-progress"></div>
                            <div class="relative z-10">
                                <i class="fas fa-hand-holding mr-2"></i>
                                Hold to Submit
                            </div>
                        </button>
                        <p id="holdInstructions" class="text-center text-xs text-gray-500 mt-2 hidden">Press and hold for 2 seconds to confirm</p>
                    </form>
                </div>
                
                <div class="mt-6 p-4 border border-yellow-800 bg-yellow-900/20 rounded-xl">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-yellow-400 mr-3 mt-1"></i>
                        <div>
                            <p class="text-yellow-400 font-medium">Important</p>
                            <p class="text-sm text-gray-400">Your deposit will be processed after verification. This may take up to 24 hours.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render User Send Money Page
        function renderUserSendMoney() {
            if (currentUser.isLocked) {
                return renderLockedMessage();
            }
            
            return `
                <div class="bee-card p-6 mb-6">
                    <h2 class="text-xl font-bold mb-6">Send Money</h2>
                    
                    <form id="sendMoneyForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Recipient Username</label>
                            <input type="text" id="recipientUsername" class="bee-input" placeholder="Enter username" oninput="searchRecipient()">
                            <div id="recipientResults" class="mt-2 space-y-2"></div>
                        </div>
                        
                        ${selectedRecipient ? `
                            <div class="p-4 border border-green-800 bg-green-900/20 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center mr-3">
                                            <span class="font-bold">${selectedRecipient.fullName.charAt(0)}</span>
                                        </div>
                                        <div>
                                            <p class="font-medium">${selectedRecipient.fullName}</p>
                                            <p class="text-sm text-gray-400">@${selectedRecipient.username}</p>
                                        </div>
                                    </div>
                                    <button type="button" onclick="clearRecipient()" class="text-red-400">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Amount</label>
                                <input type="number" id="sendMoneyAmount" min="10" step="0.01" max="${currentUser.balance}" class="bee-input" placeholder="Enter amount" required>
                            </div>
                            
                            <button type="button" id="sendMoneyHoldButton" class="hold-to-pay-btn bee-yellow-button w-full py-3 rounded-xl font-bold text-black relative">
                                <div class="hold-progress"></div>
                                <div class="relative z-10">
                                    <i class="fas fa-hand-holding mr-2"></i>
                                    Hold to Send
                                </div>
                            </button>
                            <p class="text-center text-xs text-gray-500 mt-2">Press and hold for 2 seconds to confirm</p>
                        ` : `
                            <div class="text-center py-4">
                                <i class="fas fa-user-friends text-3xl text-gray-700 mb-3"></i>
                                <p class="text-gray-500">Search and select a recipient to send money</p>
                            </div>
                        `}
                    </form>
                </div>
                
                ${selectedRecipient ? `
                    <div class="p-4 border border-green-800 bg-green-900/20 rounded-xl">
                        <div class="flex items-start">
                            <i class="fas fa-bolt text-green-400 mr-3 mt-1"></i>
                            <div>
                                <p class="text-green-400 font-medium">Instant Transfer</p>
                                <p class="text-sm text-gray-400">Money will be transferred instantly to the recipient</p>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // Render User Profile Page (View Mode) - UPDATED: Added Linked Profile section
        function renderUserProfile() {
            const userType = userTypes[currentUser.userType] || userTypes['starter'];
            
            return `
                <div class="bee-card p-6 mb-4">
                    <div class="text-center mb-6">
                        ${currentUser.profilePicture ? `
                            <img src="${currentUser.profilePicture}" alt="Profile Picture" class="w-24 h-24 rounded-full mx-auto mb-4 object-cover border-2 border-yellow-500">
                        ` : `
                            <div class="w-24 h-24 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-yellow-500">
                                <i class="fas fa-user text-3xl text-gray-400"></i>
                            </div>
                        `}
                        <h2 class="text-xl font-bold">${currentUser.fullName}</h2>
                        <p class="text-gray-400">@${currentUser.username}</p>
                        <div class="mt-2">
                            <span class="inline-block px-3 py-1 bg-black text-yellow-500 text-xs font-bold rounded-full">${userType.name}</span>
                        </div>
                        ${userType.canUploadProfilePicture && !currentUser.profilePicture ? `
                            <button onclick="uploadProfilePicture()" class="mt-2 text-sm text-yellow-500 hover:text-yellow-400">
                                <i class="fas fa-camera mr-1"></i> Upload Profile Picture
                            </button>
                        ` : ''}
                    </div>
                    
                    <div class="flex justify-end mb-4">
                        <button onclick="toggleProfileEditMode(true)" class="edit-btn flex items-center">
                            <i class="fas fa-edit mr-2"></i> Edit Profile
                        </button>
                    </div>
                    
                    <!-- Account Information Section -->
                    <div class="mb-8">
                        <h3 class="profile-section-title">Account Information</h3>
                        <div class="space-y-3">
                            <div class="info-row">
                                <span class="info-label">Account ID</span>
                                <span class="info-value">${currentUser.id}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Username</span>
                                <span class="info-value">${currentUser.username}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Full Name</span>
                                <span class="info-value">${currentUser.fullName}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">User Type</span>
                                <span class="info-value yellow-text">${userType.name}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Member Since</span>
                                <span class="info-value">${new Date(currentUser.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Account Status</span>
                                <span class="info-value ${currentUser.isLocked ? 'text-red-400' : 'text-green-400'}">
                                    ${currentUser.isLocked ? 'Locked' : 'Active'}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NEW: Linked Profile Section (Non-editable by user) -->
                    <div class="mb-8">
                        <h3 class="profile-section-title">Linked Profile <span class="text-xs text-gray-500">(Admin Set)</span></h3>
                        <div class="space-y-3">
                            <div class="info-row">
                                <span class="info-label">bKash Account</span>
                                <span class="info-value">${currentUser.bkashAccount || 'Not set by admin'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Bank Name</span>
                                <span class="info-value">${currentUser.bankName || 'Not set by admin'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Bank Account</span>
                                <span class="info-value">${currentUser.bankAccount || 'Not set by admin'}</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2"><i class="fas fa-info-circle mr-1"></i> These details are set by admin and used for fund transfers</p>
                    </div>
                    
                    <!-- Personal Details Section -->
                    <div class="mb-8">
                        <h3 class="profile-section-title">Personal Details</h3>
                        <div class="space-y-3">
                            <div class="info-row">
                                <span class="info-label">Contact Number</span>
                                <span class="info-value">${currentUser.phone || 'Not provided'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Email Address</span>
                                <span class="info-value">${currentUser.email || 'Not provided'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Address</span>
                                <span class="info-value">${currentUser.address || 'Not provided'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loan Eligibility Section -->
                    <div class="mb-8">
                        <h3 class="profile-section-title">Loan Eligibility</h3>
                        <div class="space-y-3">
                            <div class="info-row">
                                <span class="info-label">Maximum Loan Amount</span>
                                <span class="info-value yellow-text font-bold">${formatCurrency(userType.loanEligibleAmount)}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Available Terms</span>
                                <span class="info-value">${userType.loanEligibleTerms.map(term => `${term} Month${term > 1 ? 's' : ''}`).join(', ')}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Account Balance Section -->
                    <div>
                        <h3 class="profile-section-title">Account Balance</h3>
                        <div class="space-y-3">
                            <div class="info-row">
                                <span class="info-label">Current Balance</span>
                                <span class="info-value yellow-text font-bold">${formatCurrency(currentUser.balance)}</span>
                            </div>
                            ${currentUser.loanActive ? `
                                <div class="info-row">
                                    <span class="info-label">Active Loan</span>
                                    <span class="info-value text-red-400 font-bold">${formatCurrency(currentUser.loanAmount)}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="p-4 border border-blue-800 bg-blue-900/20 rounded-xl">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-blue-400 mr-3 mt-1"></i>
                        <div>
                            <p class="text-blue-400 font-medium">Profile Information</p>
                            <p class="text-sm text-gray-400">Your personal details are secure and encrypted. Click "Edit Profile" to update your information.</p>
                            <p class="text-xs text-gray-500 mt-1"><i class="fas fa-lock mr-1"></i> Linked Profile details are set by admin and cannot be changed by users</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render Profile Edit Form - UPDATED: Linked Profile is read-only
        function renderProfileEditForm() {
            const userType = userTypes[currentUser.userType] || userTypes['starter'];
            
            return `
                <div class="bee-card p-6 mb-4">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Edit Profile</h2>
                        <button onclick="toggleProfileEditMode(false)" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form id="profileEditForm" class="space-y-6">
                        <!-- Account Information (Read-only) -->
                        <div>
                            <h3 class="profile-section-title">Account Information</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Account ID</label>
                                    <input type="text" class="bee-input bee-input-disabled" value="${currentUser.id}" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Username</label>
                                    <input type="text" class="bee-input bee-input-disabled" value="${currentUser.username}" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Full Name</label>
                                    <input type="text" class="bee-input bee-input-disabled" value="${currentUser.fullName}" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">User Type</label>
                                    <input type="text" class="bee-input bee-input-disabled" value="${userType.name}" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Linked Profile (Read-only - Admin Set) -->
                        <div>
                            <h3 class="profile-section-title">Linked Profile <span class="text-xs text-gray-500">(Admin Set - Read Only)</span></h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">bKash Account</label>
                                    <input type="text" class="bee-input bee-input-disabled" value="${currentUser.bkashAccount || ''}" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Bank Name</label>
                                    <input type="text" class="bee-input bee-input-disabled" value="${currentUser.bankName || ''}" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Bank Account</label>
                                    <input type="text" class="bee-input bee-input-disabled" value="${currentUser.bankAccount || ''}" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Personal Details (Editable) -->
                        <div>
                            <h3 class="profile-section-title">Personal Details</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Contact Number</label>
                                    <input type="text" id="editPhone" class="bee-input" value="${currentUser.phone || ''}" placeholder="Enter your phone number">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Email Address</label>
                                    <input type="email" id="editEmail" class="bee-input" value="${currentUser.email || ''}" placeholder="Enter your email address">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Address</label>
                                    <textarea id="editAddress" class="bee-input" rows="3" placeholder="Enter your address">${currentUser.address || ''}</textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Profile Picture (for VIP users) -->
                        ${userType.canUploadProfilePicture ? `
                            <div>
                                <h3 class="profile-section-title">Profile Picture</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-400 mb-2">Profile Picture URL</label>
                                        <input type="url" id="editProfilePicture" class="bee-input" value="${currentUser.profilePicture || ''}" placeholder="Enter image URL (e.g., https://example.com/photo.jpg)">
                                        <p class="text-xs text-gray-500 mt-1">Only VIP users can upload profile pictures</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="button" onclick="toggleProfileEditMode(false)" class="cancel-btn flex-1">
                                Cancel
                            </button>
                            <button type="button" onclick="saveProfile()" class="save-btn flex-1">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="p-4 border border-yellow-800 bg-yellow-900/20 rounded-xl">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-yellow-400 mr-3 mt-1"></i>
                        <div>
                            <p class="text-yellow-400 font-medium">Important</p>
                            <p class="text-sm text-gray-400">Ensure your contact information is accurate for transaction notifications and account recovery.</p>
                            <p class="text-xs text-gray-500 mt-1"><i class="fas fa-lock mr-1"></i> Linked Profile details can only be changed by admin</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render Locked Message
        function renderLockedMessage() {
            return `
                <div class="bee-card p-6 text-center">
                    <div class="w-16 h-16 bg-red-900/30 border border-red-800 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-lock text-red-400 text-2xl"></i>
                    </div>
                    <h2 class="text-xl font-bold mb-2">Account Locked</h2>
                    <p class="text-gray-400 mb-4">Dear Client! Your account has been Locked. Contact the Administration to unlock your account.</p>
                    <button onclick="setUserCurrentView('dashboard')" class="bee-button w-full py-3 rounded-xl font-medium">
                        Return to Dashboard
                    </button>
                </div>
            `;
        }

        // Render Admin Panel (Black Bee Style)
        function renderAdminPanel() {
            const users = localUsers.filter(u => u.role !== 'admin');
            const totalUsers = users.length;
            const totalBalance = users.reduce((acc, curr) => acc + curr.balance, 0);
            const activeUsers = users.filter(u => !u.isLocked).length;
            const pendingFundTransfers = localFundTransfers.filter(t => t.status === 'pending').length;
            const pendingTransactions = localTransactions.filter(t => t.status === 'pending').length;
            const pendingLoanRequests = localLoanRequests.filter(t => t.status === 'pending').length;
            const totalPending = pendingFundTransfers + pendingTransactions + pendingLoanRequests;
            
            const app = document.getElementById('app');
            app.className = "min-h-screen";
            
            app.innerHTML = `
                <!-- Admin Header -->
                <div class="header-bg p-6">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <img src="https://i.ibb.co/mFF6tP6z/Black-Bee.png" alt="Black Bee Logo" class="logo-image-small mr-3">
                            <div>
                                <h1 class="text-xl font-bold">Admin Console</h1>
                                <p class="text-sm text-gray-400">Black Bee System</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm bg-gray-800 px-3 py-1 rounded-full">${currentUser.username}</span>
                            <button onclick="logout()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Admin Navigation -->
                    <div class="flex space-x-4 mt-4 overflow-x-auto">
                        <button onclick="setCurrentView('dashboard')" class="px-4 py-2 rounded-xl ${currentView === 'dashboard' ? 'bg-gray-800' : 'bg-transparent hover:bg-gray-800/50'}">
                            Dashboard
                        </button>
                        <button onclick="setCurrentView('users')" class="px-4 py-2 rounded-xl ${currentView === 'users' ? 'bg-gray-800' : 'bg-transparent hover:bg-gray-800/50'}">
                            Users
                        </button>
                        <button onclick="setCurrentView('transactions')" class="px-4 py-2 rounded-xl ${currentView === 'transactions' ? 'bg-gray-800' : 'bg-transparent hover:bg-gray-800/50'} relative">
                            Transactions
                            ${pendingTransactions > 0 ? `<span class="notification-badge">${pendingTransactions}</span>` : ''}
                        </button>
                        <button onclick="setCurrentView('fundtransfers')" class="px-4 py-2 rounded-xl ${currentView === 'fundtransfers' ? 'bg-gray-800' : 'bg-transparent hover:bg-gray-800/50'} relative">
                            Fund Transfers
                            ${pendingFundTransfers > 0 ? `<span class="notification-badge">${pendingFundTransfers}</span>` : ''}
                        </button>
                        <button onclick="setCurrentView('loanrequests')" class="px-4 py-2 rounded-xl ${currentView === 'loanrequests' ? 'bg-gray-800' : 'bg-transparent hover:bg-gray-800/50'} relative">
                            Loan Requests
                            ${pendingLoanRequests > 0 ? `<span class="notification-badge">${pendingLoanRequests}</span>` : ''}
                        </button>
                        <button onclick="setCurrentView('history')" class="px-4 py-2 rounded-xl ${currentView === 'history' ? 'bg-gray-800' : 'bg-transparent hover:bg-gray-800/50'}">
                            History
                        </button>
                    </div>
                </div>

                <!-- Admin Content -->
                <div class="p-4 fade-in">
                    ${currentView === 'dashboard' ? renderAdminDashboard(users, totalUsers, totalBalance, activeUsers, pendingLoanRequests) :
                      currentView === 'users' ? renderAdminUsers(users) :
                      currentView === 'transactions' ? renderAdminTransactions() :
                      currentView === 'fundtransfers' ? renderAdminFundTransfers() :
                      currentView === 'loanrequests' ? renderAdminLoanRequests() :
                      currentView === 'history' ? renderAdminHistory() : ''}
                </div>

                <!-- Admin Modals -->
                ${getAdminModals()}
            `;
            
            // Add admin event listeners
            setupAdminListeners();
        }

        function renderAdminDashboard(users, totalUsers, totalBalance, activeUsers, pendingLoanRequests) {
            return `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bee-card p-6">
                        <div class="flex items-center">
                            <div class="icon-container mr-4">
                                <i class="fas fa-users"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">Total Users</p>
                                <p class="text-2xl font-bold">${totalUsers}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bee-card p-6">
                        <div class="flex items-center">
                            <div class="icon-container mr-4">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">System Balance</p>
                                <p class="text-2xl font-bold yellow-text">${formatCurrency(totalBalance)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bee-card p-6">
                        <div class="flex items-center">
                            <div class="icon-container mr-4">
                                <i class="fas fa-hand-holding-usd"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">Pending Loans</p>
                                <p class="text-2xl font-bold">${pendingLoanRequests}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bee-card p-6">
                        <div class="flex items-center">
                            <div class="icon-container mr-4">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">Active Users</p>
                                <p class="text-2xl font-bold">${activeUsers}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bee-card p-6">
                        <div class="flex items-center">
                            <div class="icon-container mr-4">
                                <i class="fas fa-user-tag"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">VIP Users</p>
                                <p class="text-2xl font-bold">${users.filter(u => u.userType === 'vip').length}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bee-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Recent Loan Requests</h2>
                        <button onclick="setCurrentView('loanrequests')" class="text-sm text-yellow-500 hover:text-yellow-400">
                            View All
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        ${localLoanRequests.filter(lr => lr.status === 'pending').slice(0, 3).map(loan => {
                            const user = localUsers.find(u => u.id === loan.userId);
                            return `
                                <div class="flex items-center justify-between p-3 border border-gray-800 rounded-xl">
                                    <div class="flex items-center">
                                        <div class="icon-container mr-3 bg-purple-900/30 border-purple-800">
                                            <i class="fas fa-hand-holding-usd text-purple-400"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium">${user ? user.fullName : 'Unknown User'}</p>
                                            <p class="text-xs text-gray-400">${formatCurrency(loan.amount)} • ${loan.term} Month${loan.term > 1 ? 's' : ''}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold">${formatCurrency(loan.totalRepayment)}</p>
                                        <span class="status-badge status-pending">Pending</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        ${localLoanRequests.filter(lr => lr.status === 'pending').length === 0 ? `
                            <div class="text-center py-4">
                                <p class="text-gray-500">No pending loan requests</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderAdminUsers(users) {
            return `
                <div class="bee-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">User Management</h2>
                        <button onclick="openCreateUserModal()" class="bee-yellow-button px-4 py-2 rounded-xl font-medium text-black">
                            <i class="fas fa-plus mr-2"></i> New User
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        ${users.map(user => {
                            const userType = userTypes[user.userType] || userTypes['starter'];
                            return `
                                <div class="flex items-center justify-between p-4 border border-gray-800 rounded-xl">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center mr-3">
                                            ${user.profilePicture ? `
                                                <img src="${user.profilePicture}" alt="Profile" class="w-full h-full rounded-full object-cover">
                                            ` : `
                                                <span class="font-bold">${user.fullName.charAt(0)}</span>
                                            `}
                                        </div>
                                        <div>
                                            <p class="font-medium">${user.fullName}</p>
                                            <p class="text-sm text-gray-400">@${user.username} • ${formatCurrency(user.balance)}</p>
                                            <p class="text-xs ${user.userType === 'vip' ? 'text-yellow-400' : user.userType === 'trusted' ? 'text-blue-400' : user.userType === 'standard' ? 'text-green-400' : 'text-gray-400'}">${userType.name}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <button onclick="openUserDepositModal(${user.id})" class="bee-button p-2" title="Deposit">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                        <button onclick="openEditUserModal(${user.id})" class="bee-button p-2" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="toggleUserLock(${user.id})" class="bee-button p-2 ${user.isLocked ? 'text-red-400' : 'text-green-400'}" title="${user.isLocked ? 'Unlock' : 'Lock'}">
                                            <i class="fas ${user.isLocked ? 'fa-lock' : 'fa-lock-open'}"></i>
                                        </button>
                                        <button onclick="openDeleteUserModal(${user.id})" class="bee-button p-2 text-red-400" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderAdminTransactions() {
            const pendingTransactions = localTransactions.filter(t => t.status === 'pending');
            
            return `
                <div class="bee-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Pending Transactions</h2>
                        <span class="text-sm text-gray-400">${pendingTransactions.length} pending</span>
                    </div>
                    
                    ${pendingTransactions.length > 0 ? pendingTransactions.map(tx => {
                        const user = localUsers.find(u => u.id === tx.userId);
                        return `
                            <div class="mb-4 p-4 border border-gray-800 rounded-xl">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <p class="font-bold">${user ? user.fullName : 'Unknown User'}</p>
                                        <p class="text-sm text-gray-400">@${tx.username} • ${tx.type.toUpperCase()}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-xl font-bold ${tx.type === 'deposit' ? 'text-green-400' : 'text-red-400'}">${formatCurrency(tx.amount)}</p>
                                        <span class="status-badge status-pending">Pending</span>
                                    </div>
                                </div>
                                
                                <div class="text-sm text-gray-400 mb-4">
                                    <p><strong>Method:</strong> ${tx.method}</p>
                                    <p><strong>Details:</strong> ${tx.transactionDetails}</p>
                                    <p><strong>Date:</strong> ${new Date(tx.timestamp).toLocaleString()}</p>
                                </div>
                                
                                <div class="flex space-x-2">
                                    <button onclick="showApproveTransactionModal('${tx.docId}', ${tx.userId}, '${tx.type}', ${tx.amount}, '${tx.method}')" class="flex-1 bee-yellow-button py-2 rounded-xl font-medium text-black">
                                        Approve
                                    </button>
                                    <button onclick="showRejectTransactionModal('${tx.docId}')" class="flex-1 bee-button py-2 rounded-xl font-medium">
                                        Reject
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('') : `
                        <div class="text-center py-8">
                            <i class="fas fa-check-circle text-3xl text-gray-700 mb-3"></i>
                            <p class="text-gray-500">No pending transactions</p>
                        </div>
                    `}
                </div>
                
                <!-- Approve Transaction Modal -->
                <div id="approveTransactionModal" class="modal-overlay hidden">
                    <div class="modal-content fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold">Approve Transaction</h3>
                            <button onclick="closeApproveTransactionModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-gray-400 mb-2">Optional: Enter approval reason</p>
                            <textarea id="approveTransactionReason" class="bee-input" rows="3" placeholder="Enter reason for approval (optional)"></textarea>
                        </div>
                        
                        <button onclick="confirmApproveTransaction()" class="w-full bee-yellow-button py-3 rounded-xl font-bold text-black">
                            Approve Transaction
                        </button>
                    </div>
                </div>
                
                <!-- Reject Transaction Modal -->
                <div id="rejectTransactionModal" class="modal-overlay hidden">
                    <div class="modal-content fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold">Reject Transaction</h3>
                            <button onclick="closeRejectTransactionModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-gray-400 mb-2">Enter rejection reason (MANDATORY)</p>
                            <textarea id="rejectTransactionReason" class="bee-input" rows="3" placeholder="Enter reason for rejection" required></textarea>
                        </div>
                        
                        <button onclick="confirmRejectTransaction()" class="w-full bee-button py-3 rounded-xl font-medium bg-red-900/30 border-red-800 text-red-400">
                            Reject Transaction
                        </button>
                    </div>
                </div>
            `;
        }

        function renderAdminFundTransfers() {
            const pendingTransfers = localFundTransfers.filter(t => t.status === 'pending');
            
            return `
                <div class="bee-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Pending Fund Transfers</h2>
                        <span class="text-sm text-gray-400">${pendingTransfers.length} pending</span>
                    </div>
                    
                    ${pendingTransfers.length > 0 ? `
                        <div class="mb-6 p-4 border border-blue-800 bg-blue-900/20 rounded-xl">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-400 mr-3 mt-1"></i>
                                <div>
                                    <p class="text-blue-400 font-medium">Admin Simulation Panel</p>
                                    <p class="text-sm text-gray-400">Simulate admin action on pending requests:</p>
                                </div>
                            </div>
                        </div>
                        
                        ${pendingTransfers.map(transfer => {
                            const user = localUsers.find(u => u.id === transfer.userId);
                            const isBkash = transfer.type === 'bkash';
                            const isBank = transfer.type === 'bank';
                            const isAgentOut = transfer.type === 'agent_out';
                            const chargePercentage = isAgentOut ? 0.88 : (isBkash ? 0 : 0.88);
                            const chargeAmount = transfer.amount * (chargePercentage / 100);
                            const totalDeduction = transfer.amount + chargeAmount;
                            
                            let transferType = '';
                            if (isAgentOut) transferType = 'Agent Out';
                            else if (isBkash) transferType = 'bKash Personal';
                            else transferType = 'Bank Transfer';
                            
                            return `
                                <div class="mb-6 p-4 border border-gray-800 rounded-xl">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <p class="font-bold">${transferType}: ${transfer.account}</p>
                                            <p class="text-sm text-gray-400">${user ? user.fullName : 'Unknown User'} • @${transfer.username}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-xl font-bold">${formatCurrency(transfer.amount)}</p>
                                            <p class="text-sm text-gray-400">Total: ${formatCurrency(totalDeduction)}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="text-sm text-gray-400 mb-4 space-y-1">
                                        ${isBank ? `<p><strong>Bank Name:</strong> ${transfer.bankName}</p>` : ''}
                                        <p><strong>Date:</strong> ${new Date(transfer.timestamp).toLocaleString()}</p>
                                        <p><strong>Charges:</strong> ${chargePercentage}% (${formatCurrency(chargeAmount)})</p>
                                    </div>
                                    
                                    <div class="flex space-x-2">
                                        <button onclick="showApproveFundTransferModal('${transfer.docId}', ${transfer.userId}, ${transfer.amount}, '${transfer.type}')" class="flex-1 bee-yellow-button py-2 rounded-xl font-medium text-black">
                                            Approve Transfer
                                        </button>
                                        <button onclick="showRejectFundTransferModal('${transfer.docId}')" class="flex-1 bee-button py-2 rounded-xl font-medium">
                                            Reject Transfer
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    ` : `
                        <div class="text-center py-8">
                            <i class="fas fa-check-circle text-3xl text-gray-700 mb-3"></i>
                            <p class="text-gray-500">No pending fund transfers</p>
                        </div>
                    `}
                </div>
                
                <!-- Approve Fund Transfer Modal -->
                <div id="approveFundTransferModal" class="modal-overlay hidden">
                    <div class="modal-content fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold">Approve Transfer</h3>
                            <button onclick="closeApproveFundTransferModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-gray-400 mb-2">Optional: Enter approval reason</p>
                            <textarea id="approveFundTransferReason" class="bee-input" rows="3" placeholder="Enter reason for approval (optional)"></textarea>
                        </div>
                        
                        <button onclick="confirmApproveFundTransfer()" class="w-full bee-yellow-button py-3 rounded-xl font-bold text-black">
                            Approve Transfer
                        </button>
                    </div>
                </div>
                
                <!-- Reject Fund Transfer Modal -->
                <div id="rejectFundTransferModal" class="modal-overlay hidden">
                    <div class="modal-content fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold">Reject Transfer</h3>
                            <button onclick="closeRejectFundTransferModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-gray-400 mb-2">Enter rejection reason (MANDATORY)</p>
                            <textarea id="rejectFundTransferReason" class="bee-input" rows="3" placeholder="Enter reason for rejection" required></textarea>
                        </div>
                        
                        <button onclick="confirmRejectFundTransfer()" class="w-full bee-button py-3 rounded-xl font-medium bg-red-900/30 border-red-800 text-red-400">
                            Reject Transfer
                        </button>
                    </div>
                </div>
            `;
        }

        function renderAdminLoanRequests() {
            const pendingLoans = localLoanRequests.filter(t => t.status === 'pending');
            
            return `
                <div class="bee-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Pending Loan Requests</h2>
                        <span class="text-sm text-gray-400">${pendingLoans.length} pending</span>
                    </div>
                    
                    ${pendingLoans.length > 0 ? `
                        <div class="mb-6 p-4 border border-purple-800 bg-purple-900/20 rounded-xl">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-purple-400 mr-3 mt-1"></i>
                                <div>
                                    <p class="text-purple-400 font-medium">Admin Loan Approval Panel</p>
                                    <p class="text-sm text-gray-400">Review and approve/reject loan requests:</p>
                                </div>
                            </div>
                        </div>
                        
                        ${pendingLoans.map(loan => {
                            const user = localUsers.find(u => u.id === loan.userId);
                            const userType = userTypes[user?.userType] || userTypes['starter'];
                            
                            return `
                                <div class="mb-6 p-4 border border-gray-800 rounded-xl">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <p class="font-bold">${user ? user.fullName : 'Unknown User'}</p>
                                            <p class="text-sm text-gray-400">@${loan.username} • ${userType.name}</p>
                                            <p class="text-sm text-gray-400">Term: ${loan.term} Month${loan.term > 1 ? 's' : ''}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-xl font-bold">${formatCurrency(loan.amount)}</p>
                                            <p class="text-sm text-gray-400">Total: ${formatCurrency(loan.totalRepayment)}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="text-sm text-gray-400 mb-4 space-y-1">
                                        <p><strong>Bank Fee (0.4%):</strong> ${formatCurrency(loan.bankFee)}</p>
                                        <p><strong>Charges (0.5% × ${loan.term}):</strong> ${formatCurrency(loan.charges)}</p>
                                        <p><strong>Monthly Installment:</strong> ${formatCurrency(loan.monthlyInstallment)}</p>
                                        <p><strong>Date:</strong> ${new Date(loan.timestamp).toLocaleString()}</p>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <p class="text-gray-400 mb-2">Installment Schedule (First 6 months):</p>
                                        <div class="space-y-1">
                                            ${loan.installments ? loan.installments.slice(0, 6).map(installment => `
                                                <div class="flex justify-between text-sm">
                                                    <span>${installment.dueDate}</span>
                                                    <span>${formatCurrency(installment.amount)}</span>
                                                </div>
                                            `).join('') : '<p class="text-gray-500 text-sm">No schedule available</p>'}
                                        </div>
                                    </div>
                                    
                                    <div class="flex space-x-2">
                                        <button onclick="showApproveLoanModal('${loan.docId}', ${loan.userId}, ${loan.amount}, ${loan.totalRepayment}, ${loan.term})" class="flex-1 bee-yellow-button py-2 rounded-xl font-medium text-black">
                                            Approve Loan
                                        </button>
                                        <button onclick="showRejectLoanModal('${loan.docId}')" class="flex-1 bee-button py-2 rounded-xl font-medium">
                                            Reject Loan
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    ` : `
                        <div class="text-center py-8">
                            <i class="fas fa-check-circle text-3xl text-gray-700 mb-3"></i>
                            <p class="text-gray-500">No pending loan requests</p>
                        </div>
                    `}
                </div>
                
                <!-- Approve Loan Modal -->
                <div id="approveLoanModal" class="modal-overlay hidden">
                    <div class="modal-content fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold">Approve Loan</h3>
                            <button onclick="closeApproveLoanModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-gray-400 mb-2">Optional: Enter approval reason</p>
                            <textarea id="approveLoanReason" class="bee-input" rows="3" placeholder="Enter reason for approval (optional)"></textarea>
                        </div>
                        
                        <button onclick="confirmApproveLoan()" class="w-full bee-yellow-button py-3 rounded-xl font-bold text-black">
                            Approve Loan
                        </button>
                    </div>
                </div>
                
                <!-- Reject Loan Modal -->
                <div id="rejectLoanModal" class="modal-overlay hidden">
                    <div class="modal-content fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold">Reject Loan</h3>
                            <button onclick="closeRejectLoanModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-gray-400 mb-2">Enter rejection reason (MANDATORY)</p>
                            <textarea id="rejectLoanReason" class="bee-input" rows="3" placeholder="Enter reason for rejection" required></textarea>
                        </div>
                        
                        <button onclick="confirmRejectLoan()" class="w-full bee-button py-3 rounded-xl font-medium bg-red-900/30 border-red-800 text-red-400">
                            Reject Loan
                        </button>
                    </div>
                </div>
            `;
        }

        function renderAdminHistory() {
            const recentHistory = localHistory
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 20);
            
            return `
                <div class="bee-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Transaction History</h2>
                        <div class="flex space-x-2">
                            <button onclick="downloadHistoryCSV()" class="bee-button px-4 py-2 rounded-xl font-medium">
                                <i class="fas fa-file-csv mr-2"></i> Export CSV
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        ${recentHistory.length > 0 ? recentHistory.map(log => {
                            const user = localUsers.find(u => u.id === log.userId);
                            return `
                                <div class="flex items-center justify-between p-3 border border-gray-800 rounded-xl">
                                    <div class="flex items-center">
                                        <div class="icon-container mr-3 ${log.type === 'deposit' ? 'bg-green-900/30 border-green-800' : log.type === 'sendmoney' ? 'bg-purple-900/30 border-purple-800' : log.type === 'withdraw' ? 'bg-red-900/30 border-red-800' : log.type === 'agent_out' ? 'bg-orange-900/30 border-orange-800' : log.type === 'loan_installment' || log.type === 'loan_payoff' ? 'bg-yellow-900/30 border-yellow-800' : 'bg-gray-900/30 border-gray-800'}">
                                            <i class="fas ${log.type === 'deposit' ? 'fa-arrow-down' : log.type === 'sendmoney' ? 'fa-exchange-alt' : log.type === 'withdraw' ? 'fa-arrow-up' : log.type === 'agent_out' ? 'fa-user-tie' : log.type === 'loan_installment' || log.type === 'loan_payoff' ? 'fa-hand-holding-usd' : 'fa-exchange-alt'} ${log.type === 'deposit' ? 'text-green-400' : log.type === 'sendmoney' ? 'text-purple-400' : log.type === 'withdraw' ? 'text-red-400' : log.type === 'agent_out' ? 'text-orange-400' : log.type === 'loan_installment' || log.type === 'loan_payoff' ? 'text-yellow-400' : 'text-gray-400'}"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium">${user ? user.fullName : 'Unknown User'}</p>
                                            <p class="text-xs text-gray-400">${log.type === 'agent_out' ? 'AGENT OUT' : log.type === 'loan_installment' ? 'LOAN INSTALLMENT' : log.type === 'loan_payoff' ? 'LOAN PAYOFF' : log.type.toUpperCase()} • ${new Date(log.timestamp).toLocaleDateString()}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold ${log.type === 'deposit' ? 'text-green-400' : 'text-red-400'}">${log.type === 'deposit' ? '+' : '-'} ${formatCurrency(log.amount)}</p>
                                        <p class="text-xs text-gray-400">${log.method || 'N/A'}</p>
                                    </div>
                                </div>
                            `;
                        }).join('') : `
                            <div class="text-center py-8">
                                <i class="fas fa-history text-3xl text-gray-700 mb-3"></i>
                                <p class="text-gray-500">No transaction history</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function getAdminModals() {
            return `
                <!-- Create User Modal - UPDATED: Added Linked Profile fields -->
                <div id="createUserModal" class="modal-overlay hidden">
                    <div class="modal-content fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold">Create New User</h3>
                            <button onclick="closeCreateUserModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="createUserForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Full Name</label>
                                <input type="text" name="fullName" class="bee-input" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Username</label>
                                <input type="text" name="username" class="bee-input" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Password</label>
                                <input type="password" name="password" class="bee-input" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">User Type</label>
                                <select name="userType" class="bee-input" required>
                                    <option value="starter">Starter User</option>
                                    <option value="standard">Standard User</option>
                                    <option value="trusted">Trusted User</option>
                                    <option value="vip">VIP User</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Initial Balance</label>
                                <input type="number" name="balance" value="0" class="bee-input" required>
                            </div>
                            
                            <!-- Linked Profile Fields -->
                            <div class="pt-4 border-t border-gray-700">
                                <h4 class="text-sm font-medium text-gray-400 mb-3">Linked Profile (For Fund Transfers)</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-2">bKash Account Number</label>
                                        <input type="text" name="bkashAccount" class="bee-input" placeholder="e.g., 017xxxxxxxx">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-2">Bank Name</label>
                                        <input type="text" name="bankName" class="bee-input" placeholder="e.g., BRAC Bank">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-2">Bank Account Number</label>
                                        <input type="text" name="bankAccount" class="bee-input" placeholder="e.g., 1020001234567">
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="w-full bee-yellow-button py-3 rounded-xl font-bold text-black">
                                Create User
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Edit User Modal - UPDATED: Added Linked Profile fields -->
                <div id="editUserModal" class="modal-overlay hidden">
                    <div class="modal-content fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold">Edit User</h3>
                            <button onclick="closeEditUserModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="editUserForm" class="space-y-4">
                            <input type="hidden" id="editUserId">
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Full Name</label>
                                <input type="text" id="editUserFullName" class="bee-input" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">User Type</label>
                                <select id="editUserType" class="bee-input" required>
                                    <option value="starter">Starter User</option>
                                    <option value="standard">Standard User</option>
                                    <option value="trusted">Trusted User</option>
                                    <option value="vip">VIP User</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Email</label>
                                <input type="email" id="editUserEmail" class="bee-input">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Phone</label>
                                <input type="text" id="editUserPhone" class="bee-input">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Address</label>
                                <textarea id="editUserAddress" class="bee-input" rows="2"></textarea>
                            </div>
                            
                            <!-- Linked Profile Fields -->
                            <div class="pt-4 border-t border-gray-700">
                                <h4 class="text-sm font-medium text-gray-400 mb-3">Linked Profile (For Fund Transfers)</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-2">bKash Account Number</label>
                                        <input type="text" id="editUserBkashAccount" class="bee-input" placeholder="e.g., 017xxxxxxxx">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-2">Bank Name</label>
                                        <input type="text" id="editUserBankName" class="bee-input" placeholder="e.g., BRAC Bank">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-2">Bank Account Number</label>
                                        <input type="text" id="editUserBankAccount" class="bee-input" placeholder="e.g., 1020001234567">
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Profile Picture URL</label>
                                <input type="url" id="editUserProfilePicture" class="bee-input" placeholder="Enter image URL">
                            </div>
                            
                            <button type="submit" class="w-full bee-yellow-button py-3 rounded-xl font-bold text-black">
                                Update User
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Deposit Modal -->
                <div id="depositModal" class="modal-overlay hidden">
                    <div class="modal-content fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold">Deposit Funds</h3>
                            <button onclick="closeDepositModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="adminDepositForm" class="space-y-4">
                            <input type="hidden" id="depositUserId">
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Amount</label>
                                <input type="number" id="adminDepositAmount" class="bee-input" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Method</label>
                                <select id="adminDepositMethod" class="bee-input">
                                    <option value="bkash">Bkash</option>
                                    <option value="nagad">Nagad</option>
                                    <option value="bank">Bank</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Transaction ID</label>
                                <input type="text" id="adminDepositTrxId" class="bee-input" required>
                            </div>
                            
                            <button type="submit" class="w-full bee-yellow-button py-3 rounded-xl font-bold text-black">
                                Process Deposit
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Delete User Modal -->
                <div id="deleteUserModal" class="modal-overlay hidden">
                    <div class="modal-content fade-in">
                        <div class="text-center">
                            <div class="w-12 h-12 bg-red-900/30 border border-red-800 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-exclamation-triangle text-red-400"></i>
                            </div>
                            <h3 class="text-lg font-bold mb-2">Delete User?</h3>
                            <p class="text-gray-400 mb-6">Are you sure you want to delete this user account?</p>
                            
                            <div class="flex space-x-3">
                                <button onclick="closeDeleteUserModal()" class="flex-1 bee-button py-2 rounded-xl font-medium">
                                    Cancel
                                </button>
                                <button onclick="confirmDeleteUser()" class="flex-1 bee-button py-2 rounded-xl font-medium bg-red-900/30 border-red-800 text-red-400">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Event Handlers
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Special admin login
            if (username === 'Mizx999' && password === '123') {
                const adminUser = localUsers.find(u => u.username === 'Mizx999');
                if (adminUser) {
                    currentUser = adminUser;
                    currentView = 'dashboard';
                    refreshUI();
                    showToast('Welcome Admin', 'Logged in as system administrator', 'success');
                    return;
                }
            }
            
            // Regular user login
            const foundUser = localUsers.find(u => u.username === username && u.password === password);
            
            if (foundUser) {
                currentUser = foundUser;
                currentUserView = 'dashboard';
                isEditingProfile = false;
                refreshUI();
                
                if (foundUser.isLocked) {
                    showToast('Account Locked', 'Your account is locked. Contact administration.', 'error');
                } else {
                    showToast('Welcome Back', `Logged in as ${foundUser.fullName}`, 'success');
                }
            } else {
                showToast('Login Failed', 'Invalid username or password', 'error');
            }
        }

        function logout() {
            currentUser = null;
            currentView = 'dashboard';
            currentUserView = 'dashboard';
            selectedRecipient = null;
            currentFundTransfer = null;
            currentLoanRequest = null;
            isEditingProfile = false;
            refreshUI();
        }

        function setUserCurrentView(view) {
            currentUserView = view;
            isEditingProfile = false;
            renderUserPanel();
        }

        function setCurrentView(view) {
            currentView = view;
            renderAdminPanel();
        }

        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const eyeIcon = document.getElementById('eyeIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.remove('fa-eye');
                eyeIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('fa-eye-slash');
                eyeIcon.classList.add('fa-eye');
            }
        }

        // Show/hide deposit fields based on payment method
        function showDepositFields(method) {
            const bkashNagadFields = document.getElementById('bkashNagadFields');
            const bankFields = document.getElementById('bankFields');
            const depositHoldButton = document.getElementById('depositHoldButton');
            const holdInstructions = document.getElementById('holdInstructions');
            
            // Reset all fields
            bkashNagadFields.classList.add('hidden');
            bankFields.classList.add('hidden');
            depositHoldButton.classList.add('hidden');
            holdInstructions.classList.add('hidden');
            
            // Show appropriate fields
            if (method === 'bkash' || method === 'nagad') {
                bkashNagadFields.classList.remove('hidden');
                depositHoldButton.classList.remove('hidden');
                holdInstructions.classList.remove('hidden');
            } else if (method === 'bank') {
                bankFields.classList.remove('hidden');
                depositHoldButton.classList.remove('hidden');
                holdInstructions.classList.remove('hidden');
            }
        }

        function setupFormListeners() {
            // Deposit form - handle radio button changes
            const bkashRadio = document.querySelector('input[name="depositMethod"][value="bkash"]');
            const nagadRadio = document.querySelector('input[name="depositMethod"][value="nagad"]');
            const bankRadio = document.querySelector('input[name="depositMethod"][value="bank"]');
            
            if (bkashRadio) {
                bkashRadio.addEventListener('change', () => showDepositFields('bkash'));
            }
            if (nagadRadio) {
                nagadRadio.addEventListener('change', () => showDepositFields('nagad'));
            }
            if (bankRadio) {
                bankRadio.addEventListener('change', () => showDepositFields('bank'));
            }
            
            // Deposit form hold button
            const depositHoldButton = document.getElementById('depositHoldButton');
            if (depositHoldButton) {
                setupHoldButton(depositHoldButton, handleUserDeposit);
            }
            
            // Send money form hold button
            const sendMoneyHoldButton = document.getElementById('sendMoneyHoldButton');
            if (sendMoneyHoldButton) {
                setupHoldButton(sendMoneyHoldButton, handleSendMoney);
            }
            
            // Fund transfer hold button
            const confirmTransferBtn = document.getElementById('confirmTransferHoldBtn');
            if (confirmTransferBtn) {
                setupHoldButton(confirmTransferBtn, submitFundTransfer);
            }
            
            // Agent Out hold button
            const confirmAgentOutBtn = document.getElementById('confirmAgentOutHoldBtn');
            if (confirmAgentOutBtn) {
                setupHoldButton(confirmAgentOutBtn, submitFundTransfer);
            }
        }

        function setupHoldButton(button, callback) {
            let holdStartTime = null;
            const holdDuration = 2000;
            
            button.addEventListener('mousedown', startHold);
            button.addEventListener('mouseup', endHold);
            button.addEventListener('mouseleave', endHold);
            
            button.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startHold();
            });
            button.addEventListener('touchend', endHold);
            button.addEventListener('touchcancel', endHold);
            
            function startHold() {
                holdStartTime = Date.now();
                button.classList.add('holding');
                button.disabled = true;
                
                holdTimer = setTimeout(() => {
                    callback();
                    button.classList.remove('holding');
                    button.disabled = false;
                }, holdDuration);
            }
            
            function endHold() {
                if (holdTimer) clearTimeout(holdTimer);
                button.classList.remove('holding');
                button.disabled = false;
                
                if (holdStartTime) {
                    const holdTime = Date.now() - holdStartTime;
                    if (holdTime < holdDuration) {
                        showToast('Hold Longer', 'Please hold for 2 seconds to confirm', 'info');
                    }
                }
            }
        }

        // Agent Out Functions
        function reviewAgentOutTransfer() {
            const account = document.getElementById('agentOutAccount').value;
            const confirmAccount = document.getElementById('confirmAgentOutAccount').value;
            const amount = parseFloat(document.getElementById('agentOutAmount').value);
            
            if (!account || !confirmAccount || !amount) {
                showToast('Error', 'Please fill all fields', 'error');
                return;
            }
            
            if (account !== confirmAccount) {
                showToast('Error', 'Account numbers do not match', 'error');
                return;
            }
            
            if (account.length !== 11) {
                showToast('Error', 'bKash agent account must be 11 digits', 'error');
                return;
            }
            
            if (amount < 10) {
                showToast('Error', 'Minimum amount is $10', 'error');
                return;
            }
            
            if (amount > currentUser.balance) {
                showToast('Error', 'Insufficient balance', 'error');
                return;
            }
            
            currentFundTransfer = {
                type: 'agent_out',
                account: account,
                amount: amount,
                timestamp: new Date().toISOString()
            };
            
            setUserCurrentView('agentoutreview');
        }

        // Loan Functions
        function selectLoanTerm(term) {
            // Remove selected class from all term options
            document.querySelectorAll('.loan-term-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked term
            const selectedOption = document.getElementById(`term-${term}`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
                document.getElementById('selectedTerm').value = term;
            }
        }

        function calculateLoanDetails() {
            const amount = parseFloat(document.getElementById('loanAmount').value);
            const term = parseInt(document.getElementById('selectedTerm').value);
            
            if (!amount || amount <= 0) {
                showToast('Error', 'Please enter a valid loan amount', 'error');
                return;
            }
            
            if (!term) {
                showToast('Error', 'Please select a loan term', 'error');
                return;
            }
            
            const userType = userTypes[currentUser.userType] || userTypes['starter'];
            if (amount > userType.loanEligibleAmount) {
                showToast('Error', `Maximum loan amount for ${userType.name} is ${formatCurrency(userType.loanEligibleAmount)}`, 'error');
                return;
            }
            
            if (!userType.loanEligibleTerms.includes(term)) {
                showToast('Error', `Invalid loan term for ${userType.name}`, 'error');
                return;
            }
            
            currentLoanRequest = {
                amount: amount,
                term: term,
                userId: currentUser.id,
                username: currentUser.username,
                fullName: currentUser.fullName,
                userType: currentUser.userType
            };
            
            setUserCurrentView('loandetails');
        }

        function showInstallmentPlan() {
            if (!currentLoanRequest) {
                showToast('Error', 'Loan details not found', 'error');
                return;
            }
            
            setUserCurrentView('loaninstallment');
        }

        function showLoanConfirmation() {
            if (!currentLoanRequest) {
                showToast('Error', 'Installment plan not found', 'error');
                return;
            }
            
            setUserCurrentView('loanconfirm');
        }

        async function submitLoanRequest() {
            if (!currentLoanRequest) {
                showToast('Error', 'No loan data found', 'error');
                return;
            }
            
            try {
                showDBLoading();
                
                // Create loan request record with installments
                const loanRequestsRef = collection(db, 'artifacts', appId, 'public', 'data', 'loanRequests');
                const loanDoc = await addDoc(loanRequestsRef, {
                    ...currentLoanRequest,
                    installments: currentLoanRequest.installments || [],
                    status: 'pending',
                    timestamp: new Date().toISOString(),
                    isActive: false,
                    paidAmount: 0,
                    paidInstallments: 0
                });
                
                // Create inbox message for user - UPDATED: 3 days expiry
                const inboxRef = collection(db, 'artifacts', appId, 'public', 'data', 'inboxMessages');
                const expiresAt = new Date();
                expiresAt.setDate(expiresAt.getDate() + 3); // FIXED: Changed from 3 to 3 days (already correct)
                
                await addDoc(inboxRef, {
                    userId: currentUser.id,
                    title: 'Loan Request Sent',
                    message: `Your loan request of ${formatCurrency(currentLoanRequest.amount)} has been submitted and is currently pending admin review.`,
                    status: 'processing',
                    type: 'loan_request',
                    loanId: loanDoc.id,
                    isRead: false,
                    timestamp: new Date().toISOString(),
                    expiresAt: expiresAt.toISOString()
                });
                
                hideDBLoading();
                showSuccessPage('loan', currentLoanRequest.amount);
                
                // Reset loan request
                currentLoanRequest = null;
                
            } catch (error) {
                console.error('Submit loan request error:', error);
                hideDBLoading();
                showToast('Error', 'Failed to submit loan request', 'error');
            }
        }

        function uploadProfilePicture() {
            const url = prompt('Enter profile picture URL:');
            if (url) {
                const userType = userTypes[currentUser.userType] || userTypes['starter'];
                if (!userType.canUploadProfilePicture) {
                    showToast('Error', 'Only VIP users can upload profile pictures', 'error');
                    return;
                }
                
                // Update profile picture
                updateProfilePicture(url);
            }
        }

        async function updateProfilePicture(url) {
            try {
                showDBLoading();
                
                const userDocId = getFirestoreDocId(currentUser.id);
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userDocId);
                
                await updateDoc(userRef, {
                    profilePicture: url
                });
                
                hideDBLoading();
                showToast('Success', 'Profile picture updated successfully', 'success');
                renderUserPanel();
                
            } catch (error) {
                console.error('Update profile picture error:', error);
                hideDBLoading();
                showToast('Error', 'Failed to update profile picture', 'error');
            }
        }

        // Fund Transfer Functions - UPDATED: Now uses linked profiles
        function startBkashTransfer() {
            setUserCurrentView('bkashtransfer');
        }

        function startBankTransfer() {
            setUserCurrentView('banktransfer');
        }

        function reviewBkashTransfer() {
            const amount = parseFloat(document.getElementById('bkashAmount').value);
            
            if (!amount) {
                showToast('Error', 'Please enter amount', 'error');
                return;
            }
            
            if (amount < 10) {
                showToast('Error', 'Minimum amount is $10', 'error');
                return;
            }
            
            if (amount > currentUser.balance) {
                showToast('Error', 'Insufficient balance', 'error');
                return;
            }
            
            currentFundTransfer = {
                type: 'bkash',
                account: currentUser.bkashAccount,
                amount: amount,
                timestamp: new Date().toISOString()
            };
            
            setUserCurrentView('transferreview');
        }

        function reviewBankTransfer() {
            const amount = parseFloat(document.getElementById('bankAmount').value);
            
            if (!amount) {
                showToast('Error', 'Please enter amount', 'error');
                return;
            }
            
            if (amount < 10) {
                showToast('Error', 'Minimum amount is $10', 'error');
                return;
            }
            
            if (amount > currentUser.balance) {
                showToast('Error', 'Insufficient balance', 'error');
                return;
            }
            
            currentFundTransfer = {
                type: 'bank',
                bankName: currentUser.bankName,
                account: currentUser.bankAccount,
                amount: amount,
                timestamp: new Date().toISOString()
            };
            
            setUserCurrentView('transferreview');
        }

        async function submitFundTransfer() {
            if (!currentFundTransfer) {
                showToast('Error', 'No transfer data found', 'error');
                return;
            }
            
            try {
                showDBLoading();
                
                // Create fund transfer record
                const fundTransfersRef = collection(db, 'artifacts', appId, 'public', 'data', 'fundTransfers');
                const transferDoc = await addDoc(fundTransfersRef, {
                    id: Date.now(),
                    userId: currentUser.id,
                    username: currentUser.username,
                    fullName: currentUser.fullName,
                    type: currentFundTransfer.type,
                    account: currentFundTransfer.account,
                    bankName: currentFundTransfer.bankName || null,
                    amount: currentFundTransfer.amount,
                    status: 'pending',
                    timestamp: new Date().toISOString(),
                    charge: currentFundTransfer.type === 'bkash' ? 0 : (currentFundTransfer.type === 'agent_out' ? 0.88 : 0.88)
                });
                
                // Create inbox message for user - UPDATED: 3 days expiry
                const inboxRef = collection(db, 'artifacts', appId, 'public', 'data', 'inboxMessages');
                const expiresAt = new Date();
                expiresAt.setDate(expiresAt.getDate() + 3); // FIXED: Changed from 3 to 3 days (already correct)
                
                let title = '';
                let message = '';
                
                if (currentFundTransfer.type === 'agent_out') {
                    title = 'bKash Agent Cash Out Processing';
                    message = `Your transaction of ${formatCurrency(currentFundTransfer.amount)} to ${currentFundTransfer.account} is processing. It is currently pending admin review.`;
                } else if (currentFundTransfer.type === 'bkash') {
                    title = 'bKash Personal Processing';
                    message = `Your transaction of ${formatCurrency(currentFundTransfer.amount)} to ${currentFundTransfer.account} is processing. It is currently pending admin review.`;
                } else {
                    title = 'Bank Transfer Processing';
                    message = `Your transaction of ${formatCurrency(currentFundTransfer.amount)} to ${currentFundTransfer.account} is processing. It is currently pending admin review.`;
                }
                
                await addDoc(inboxRef, {
                    userId: currentUser.id,
                    title: title,
                    message: message,
                    status: 'processing',
                    type: 'fund_transfer',
                    transferId: transferDoc.id,
                    isRead: false,
                    timestamp: new Date().toISOString(),
                    expiresAt: expiresAt.toISOString()
                });
                
                // Deduct amount from user balance
                const userDocId = getFirestoreDocId(currentUser.id);
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userDocId);
                
                const chargePercentage = currentFundTransfer.type === 'bkash' ? 0 : (currentFundTransfer.type === 'agent_out' ? 0.88 : 0.88);
                const chargeAmount = currentFundTransfer.amount * (chargePercentage / 100);
                const totalDeduction = currentFundTransfer.amount + chargeAmount;
                
                await updateDoc(userRef, {
                    balance: currentUser.balance - totalDeduction
                });
                
                hideDBLoading();
                setUserCurrentView('requestsent');
                
            } catch (error) {
                console.error('Submit fund transfer error:', error);
                hideDBLoading();
                showToast('Error', 'Failed to submit transfer request', 'error');
            }
        }

        async function handleUserDeposit() {
            if (currentUser.isLocked) {
                showToast('Account Locked', 'Your account is locked', 'error');
                return;
            }
            
            const method = document.querySelector('input[name="depositMethod"]:checked')?.value;
            
            if (!method) {
                showToast('Error', 'Please select a payment method', 'error');
                return;
            }
            
            let amount, trxId, name, bankName, bankAc;
            
            if (method === 'bkash' || method === 'nagad') {
                amount = parseFloat(document.getElementById('bkashDepositAmount').value);
                name = document.getElementById('bkashName').value;
                trxId = document.getElementById('bkashTrxId').value;
                
                if (!name || !trxId || !amount) {
                    showToast('Error', 'Please fill all fields', 'error');
                    return;
                }
            } else if (method === 'bank') {
                amount = parseFloat(document.getElementById('bankDepositAmount').value);
                bankName = document.getElementById('bankDepositName').value;
                bankAc = document.getElementById('bankDepositAc').value;
                
                if (!bankName || !bankAc || !amount) {
                    showToast('Error', 'Please fill all fields', 'error');
                    return;
                }
                trxId = bankAc; // Use bank account number as transaction ID
            }
            
            if (!amount || amount < 10) {
                showToast('Error', 'Minimum deposit is $10', 'error');
                return;
            }
            
            try {
                showDBLoading();
                
                const transactionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
                
                let transactionDetails = '';
                if (method === 'bkash' || method === 'nagad') {
                    transactionDetails = `Name: ${name}, Transaction ID: ${trxId}`;
                } else if (method === 'bank') {
                    transactionDetails = `Bank: ${bankName}, Account: ${bankAc}`;
                }
                
                await addDoc(transactionsRef, {
                    id: Date.now(),
                    userId: currentUser.id,
                    username: currentUser.username,
                    type: 'deposit',
                    amount: amount,
                    method: method,
                    transactionDetails: transactionDetails,
                    status: 'pending',
                    timestamp: new Date().toISOString()
                });
                
                hideDBLoading();
                showSuccessPage('deposit', amount, method);
                // Reset form
                const depositForm = document.getElementById('depositForm');
                if (depositForm) depositForm.reset();
                
            } catch (error) {
                console.error('Deposit error:', error);
                hideDBLoading();
                showToast('Error', 'Failed to submit deposit request', 'error');
            }
        }

        // Admin Functions
        function setupAdminListeners() {
            const createUserForm = document.getElementById('createUserForm');
            if (createUserForm) {
                createUserForm.addEventListener('submit', handleCreateUser);
            }
            
            const editUserForm = document.getElementById('editUserForm');
            if (editUserForm) {
                editUserForm.addEventListener('submit', handleEditUser);
            }
            
            const adminDepositForm = document.getElementById('adminDepositForm');
            if (adminDepositForm) {
                adminDepositForm.addEventListener('submit', handleAdminDeposit);
            }
        }

        // Modal Functions
        function openCreateUserModal() {
            document.getElementById('createUserModal').classList.remove('hidden');
        }

        function closeCreateUserModal() {
            document.getElementById('createUserModal').classList.add('hidden');
        }

        function openEditUserModal(userId) {
            const user = localUsers.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUserFullName').value = user.fullName;
            document.getElementById('editUserType').value = user.userType;
            document.getElementById('editUserEmail').value = user.email || '';
            document.getElementById('editUserPhone').value = user.phone || '';
            document.getElementById('editUserAddress').value = user.address || '';
            document.getElementById('editUserProfilePicture').value = user.profilePicture || '';
            document.getElementById('editUserBkashAccount').value = user.bkashAccount || '';
            document.getElementById('editUserBankName').value = user.bankName || '';
            document.getElementById('editUserBankAccount').value = user.bankAccount || '';
            
            document.getElementById('editUserModal').classList.remove('hidden');
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').classList.add('hidden');
        }

        function openUserDepositModal(userId) {
            document.getElementById('depositUserId').value = userId;
            document.getElementById('depositModal').classList.remove('hidden');
        }

        function closeDepositModal() {
            document.getElementById('depositModal').classList.add('hidden');
        }

        function openDeleteUserModal(userId) {
            window.deleteUserId = userId;
            document.getElementById('deleteUserModal').classList.remove('hidden');
        }

        function closeDeleteUserModal() {
            document.getElementById('deleteUserModal').classList.add('hidden');
        }

        // Transaction Modals
        function showApproveTransactionModal(transactionId, userId, type, amount, method) {
            window.approveTransactionData = { transactionId, userId, type, amount, method };
            document.getElementById('approveTransactionModal').classList.remove('hidden');
        }

        function closeApproveTransactionModal() {
            document.getElementById('approveTransactionModal').classList.add('hidden');
            document.getElementById('approveTransactionReason').value = '';
        }

        function showRejectTransactionModal(transactionId) {
            window.rejectTransactionId = transactionId;
            document.getElementById('rejectTransactionModal').classList.remove('hidden');
        }

        function closeRejectTransactionModal() {
            document.getElementById('rejectTransactionModal').classList.add('hidden');
            document.getElementById('rejectTransactionReason').value = '';
        }

        // Fund Transfer Modals
        function showApproveFundTransferModal(transferId, userId, amount, type) {
            window.approveFundTransferData = { transferId, userId, amount, type };
            document.getElementById('approveFundTransferModal').classList.remove('hidden');
        }

        function closeApproveFundTransferModal() {
            document.getElementById('approveFundTransferModal').classList.add('hidden');
            document.getElementById('approveFundTransferReason').value = '';
        }

        function showRejectFundTransferModal(transferId) {
            window.rejectTransferId = transferId;
            document.getElementById('rejectFundTransferModal').classList.remove('hidden');
        }

        function closeRejectFundTransferModal() {
            document.getElementById('rejectFundTransferModal').classList.add('hidden');
            document.getElementById('rejectFundTransferReason').value = '';
        }

        // Loan Modals
        function showApproveLoanModal(loanId, userId, amount, totalRepayment, term) {
            window.approveLoanData = { loanId, userId, amount, totalRepayment, term };
            document.getElementById('approveLoanModal').classList.remove('hidden');
        }

        function closeApproveLoanModal() {
            document.getElementById('approveLoanModal').classList.add('hidden');
            document.getElementById('approveLoanReason').value = '';
        }

        function showRejectLoanModal(loanId) {
            window.rejectLoanId = loanId;
            document.getElementById('rejectLoanModal').classList.remove('hidden');
        }

        function closeRejectLoanModal() {
            document.getElementById('rejectLoanModal').classList.add('hidden');
            document.getElementById('rejectLoanReason').value = '';
        }

        // Confirm Functions - UPDATED: Store approvalReason in inbox messages
        async function confirmApproveTransaction() {
            const reason = document.getElementById('approveTransactionReason').value;
            const { transactionId, userId, type, amount, method } = window.approveTransactionData;
            
            try {
                showDBLoading();
                
                // Update transaction status
                const transactionRef = doc(db, 'artifacts', appId, 'public', 'data', 'transactions', transactionId);
                await updateDoc(transactionRef, {
                    status: 'approved',
                    approvedAt: new Date().toISOString(),
                    approvedBy: currentUser.username,
                    approvalReason: reason || null
                });
                
                // Update user balance if deposit
                if (type === 'deposit') {
                    const user = localUsers.find(u => u.id === userId);
                    if (user) {
                        const userDocId = getFirestoreDocId(userId);
                        const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userDocId);
                        await updateDoc(userRef, {
                            balance: user.balance + amount
                        });
                    }
                }
                
                // Record in history
                const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'fundHistory');
                const transaction = localTransactions.find(t => t.docId === transactionId);
                
                await addDoc(historyRef, {
                    id: Date.now(),
                    userId: userId,
                    username: transaction.username,
                    amount: amount,
                    method: method,
                    type: type,
                    transactionDetails: transaction.transactionDetails,
                    timestamp: new Date().toISOString(),
                    approvedBy: currentUser.username,
                    approvalReason: reason || null,
                    status: 'approved'
                });
                
                hideDBLoading();
                closeApproveTransactionModal();
                showToast('Success', 'Transaction approved', 'success');
                
            } catch (error) {
                console.error('Approve transaction error:', error);
                hideDBLoading();
                showToast('Error', 'Failed to approve transaction', 'error');
            }
        }

        async function confirmRejectTransaction() {
            const reason = document.getElementById('rejectTransactionReason').value;
            const transactionId = window.rejectTransactionId;
            
            if (!reason) {
                showToast('Error', 'Please enter rejection reason', 'error');
                return;
            }
            
            try {
                const transactionRef = doc(db, 'artifacts', appId, 'public', 'data', 'transactions', transactionId);
                await updateDoc(transactionRef, {
                    status: 'rejected',
                    rejectedAt: new Date().toISOString(),
                    rejectedBy: currentUser.username,
                    rejectionReason: reason
                });
                
                hideDBLoading();
                closeRejectTransactionModal();
                showToast('Transaction Rejected', `Reason: ${reason}`, 'info');
                
            } catch (error) {
                console.error('Reject transaction error:', error);
                hideDBLoading();
                showToast('Error', 'Failed to reject transaction', 'error');
            }
        }

        async function confirmApproveFundTransfer() {
            const reason = document.getElementById('approveFundTransferReason').value;
            const { transferId, userId, amount, type } = window.approveFundTransferData;
            
            try {
                showDBLoading();
                
                const transfer = localFundTransfers.find(t => t.docId === transferId);
                if (!transfer) {
                    showToast('Error', 'Transfer not found', 'error');
                    return;
                }
                
                // Update transfer status
                const transferRef = doc(db, 'artifacts', appId, 'public', 'data', 'fundTransfers', transferId);
                await updateDoc(transferRef, {
                    status: 'successful',
                    approvedAt: new Date().toISOString(),
                    approvedBy: currentUser.username,
                    approvalReason: reason || null
                });
                
                // Find and update the existing pending inbox message
                const pendingMessage = localInboxMessages.find(msg => 
                    msg.userId === userId && 
                    msg.transferId === transferId && 
                    msg.status === 'processing'
                );
                
                if (pendingMessage) {
                    const msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'inboxMessages', pendingMessage.docId);
                    const chargePercentage = type === 'bkash' ? 0 : (type === 'agent_out' ? 0.88 : 0.88);
                    const chargeAmount = amount * (chargePercentage / 100);
                    const totalDeduction = amount + chargeAmount;
                    
                    let title = '';
                    if (type === 'agent_out') {
                        title = 'bKash Agent Cash Out Successful';
                    } else if (type === 'bkash') {
                        title = 'bKash Personal Successful';
                    } else {
                        title = 'Bank Transfer Successful';
                    }
                    
                    // FIXED: Store approval reason in inbox message
                    await updateDoc(msgRef, {
                        title: title,
                        message: `Your transfer of ${formatCurrency(amount)} to ${transfer.account} has been successfully completed. Total Deduction: ${formatCurrency(totalDeduction)}.`,
                        status: 'successful',
                        approvalReason: reason || null, // Store approval reason
                        isRead: false
                    });
                }
                
                // Record in history
                const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'fundHistory');
                await addDoc(historyRef, {
                    id: Date.now(),
                    userId: userId,
                    username: transfer.username,
                    amount: amount,
                    type: type === 'agent_out' ? 'agent_out' : 'fund_transfer',
                    method: type,
                    transactionDetails: `${type === 'agent_out' ? 'bKash Agent' : (type === 'bkash' ? 'bKash' : 'Bank')} transfer to ${transfer.account}`,
                    timestamp: new Date().toISOString(),
                    approvedBy: currentUser.username,
                    approvalReason: reason || null,
                    status: 'approved'
                });
                
                hideDBLoading();
                closeApproveFundTransferModal();
                showToast('Success', 'Transfer approved successfully', 'success');
                
            } catch (error) {
                console.error('Approve fund transfer error:', error);
                hideDBLoading();
                showToast('Error', 'Failed to approve transfer', 'error');
            }
        }

        async function confirmRejectFundTransfer() {
            const reason = document.getElementById('rejectFundTransferReason').value;
            const transferId = window.rejectTransferId;
            
            if (!reason) {
                showToast('Error', 'Please enter rejection reason', 'error');
                return;
            }
            
            try {
                showDBLoading();
                
                const transfer = localFundTransfers.find(t => t.docId === transferId);
                if (!transfer) {
                    showToast('Error', 'Transfer not found', 'error');
                    return;
                }
                
                // Update transfer status
                const transferRef = doc(db, 'artifacts', appId, 'public', 'data', 'fundTransfers', transferId);
                await updateDoc(transferRef, {
                    status: 'rejected',
                    rejectedAt: new Date().toISOString(),
                    rejectedBy: currentUser.username,
                    rejectionReason: reason
                });
                
                // Refund amount to user (add back the deducted amount)
                const userDocId = getFirestoreDocId(transfer.userId);
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userDocId);
                
                const user = localUsers.find(u => u.id === transfer.userId);
                const chargePercentage = transfer.type === 'bkash' ? 0 : (transfer.type === 'agent_out' ? 0.88 : 0.88);
                const chargeAmount = transfer.amount * (chargePercentage / 100);
                const totalDeduction = transfer.amount + chargeAmount;
                
                await updateDoc(userRef, {
                    balance: user.balance + totalDeduction
                });
                
                // Find and update the existing pending inbox message
                const pendingMessage = localInboxMessages.find(msg => 
                    msg.userId === transfer.userId && 
                    msg.transferId === transferId && 
                    msg.status === 'processing'
                );
                
                if (pendingMessage) {
                    const msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'inboxMessages', pendingMessage.docId);
                    
                    let title = '';
                    if (transfer.type === 'agent_out') {
                        title = 'bKash Agent Cash Out Rejected';
                    } else if (transfer.type === 'bkash') {
                        title = 'bKash Personal Rejected';
                    } else {
                        title = 'Bank Transfer Rejected';
                    }
                    
                    await updateDoc(msgRef, {
                        title: title,
                        message: `Your transfer of ${formatCurrency(transfer.amount)} to ${transfer.account} was rejected.`,
                        status: 'rejected',
                        rejectionReason: reason,
                        isRead: false
                    });
                }
                
                // Record in history
                const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'fundHistory');
                await addDoc(historyRef, {
                    id: Date.now(),
                    userId: transfer.userId,
                    username: transfer.username,
                    amount: transfer.amount,
                    type: transfer.type === 'agent_out' ? 'agent_out' : 'fund_transfer',
                    method: transfer.type,
                    transactionDetails: `${transfer.type === 'agent_out' ? 'bKash Agent' : (transfer.type === 'bkash' ? 'bKash' : 'Bank')} transfer to ${transfer.account} - REJECTED: ${reason}`,
                    timestamp: new Date().toISOString(),
                    rejectedBy: currentUser.username,
                    status: 'rejected',
                    rejectionReason: reason
                });
                
                hideDBLoading();
                closeRejectFundTransferModal();
                showToast('Transfer Rejected', `Reason: ${reason}`, 'info');
                
            } catch (error) {
                console.error('Reject fund transfer error:', error);
                hideDBLoading();
                showToast('Error', 'Failed to reject transfer', 'error');
            }
        }

        async function confirmApproveLoan() {
            const reason = document.getElementById('approveLoanReason').value;
            const { loanId, userId, amount, totalRepayment, term } = window.approveLoanData;
            
            try {
                showDBLoading();
                
                const loan = localLoanRequests.find(l => l.docId === loanId);
                if (!loan) {
                    showToast('Error', 'Loan request not found', 'error');
                    return;
                }
                
                // Update loan request status
                const loanRef = doc(db, 'artifacts', appId, 'public', 'data', 'loanRequests', loanId);
                await updateDoc(loanRef, {
                    status: 'approved',
                    approvedAt: new Date().toISOString(),
                    approvedBy: currentUser.username,
                    approvalReason: reason || null,
                    isActive: true
                });
                
                // Update user balance and loan status
                const user = localUsers.find(u => u.id === userId);
                const userDocId = getFirestoreDocId(userId);
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userDocId);
                
                await updateDoc(userRef, {
                    balance: user.balance + amount,
                    loanAmount: totalRepayment,
                    loanActive: true
                });
                
                // Find and update the existing pending inbox message
                const pendingMessage = localInboxMessages.find(msg => 
                    msg.userId === userId && 
                    msg.loanId === loanId && 
                    msg.status === 'processing'
                );
                
                if (pendingMessage) {
                    const msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'inboxMessages', pendingMessage.docId);
                    
                    // FIXED: Store approval reason in inbox message
                    await updateDoc(msgRef, {
                        title: 'Loan Request Approved',
                        message: `Congratulations! Your loan of ${formatCurrency(amount)} has been approved. Total repayment amount: ${formatCurrency(totalRepayment)} over ${term} months.`,
                        status: 'successful',
                        approvalReason: reason || null, // Store approval reason
                        isRead: false
                    });
                }
                
                // Record in history
                const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'fundHistory');
                await addDoc(historyRef, {
                    id: Date.now(),
                    userId: userId,
                    username: loan.username,
                    amount: amount,
                    type: 'loan',
                    method: 'loan_approval',
                    transactionDetails: `Loan approved for ${term} months. Total repayment: ${formatCurrency(totalRepayment)}`,
                    timestamp: new Date().toISOString(),
                    approvedBy: currentUser.username,
                    approvalReason: reason || null,
                    status: 'approved'
                });
                
                hideDBLoading();
                closeApproveLoanModal();
                showToast('Success', 'Loan approved successfully', 'success');
                
            } catch (error) {
                console.error('Approve loan error:', error);
                hideDBLoading();
                showToast('Error', 'Failed to approve loan', 'error');
            }
        }

        async function confirmRejectLoan() {
            const reason = document.getElementById('rejectLoanReason').value;
            const loanId = window.rejectLoanId;
            
            if (!reason) {
                showToast('Error', 'Please enter rejection reason', 'error');
                return;
            }
            
            try {
                showDBLoading();
                
                const loan = localLoanRequests.find(l => l.docId === loanId);
                if (!loan) {
                    showToast('Error', 'Loan request not found', 'error');
                    return;
                }
                
                // Update loan request status
                const loanRef = doc(db, 'artifacts', appId, 'public', 'data', 'loanRequests', loanId);
                await updateDoc(loanRef, {
                    status: 'rejected',
                    rejectedAt: new Date().toISOString(),
                    rejectedBy: currentUser.username,
                    rejectionReason: reason
                });
                
                // Find and update the existing pending inbox message
                const pendingMessage = localInboxMessages.find(msg => 
                    msg.userId === loan.userId && 
                    msg.loanId === loanId && 
                    msg.status === 'processing'
                );
                
                if (pendingMessage) {
                    const msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'inboxMessages', pendingMessage.docId);
                    await updateDoc(msgRef, {
                        title: 'Loan Request Rejected',
                        message: `We regret to inform you that your loan request of ${formatCurrency(loan.amount)} was rejected.`,
                        status: 'rejected',
                        rejectionReason: reason,
                        isRead: false
                    });
                }
                
                hideDBLoading();
                closeRejectLoanModal();
                showToast('Loan Rejected', `Reason: ${reason}`, 'info');
                
            } catch (error) {
                console.error('Reject loan error:', error);
                hideDBLoading();
                showToast('Error', 'Failed to reject loan', 'error');
            }
        }

        // Export functions to global scope for HTML onclick handlers
        window.logout = logout;
        window.setUserCurrentView = setUserCurrentView;
        window.setCurrentView = setCurrentView;
        window.togglePasswordVisibility = togglePasswordVisibility;
        window.showDepositFields = showDepositFields;
        window.closeSuccessPage = closeSuccessPage;
        window.downloadHistoryCSV = downloadHistoryCSV;
        window.reviewAgentOutTransfer = reviewAgentOutTransfer;
        window.selectLoanTerm = selectLoanTerm;
        window.calculateLoanDetails = calculateLoanDetails;
        window.showInstallmentPlan = showInstallmentPlan;
        window.showLoanConfirmation = showLoanConfirmation;
        window.submitLoanRequest = submitLoanRequest;
        window.uploadProfilePicture = uploadProfilePicture;
        window.startBkashTransfer = startBkashTransfer;
        window.startBankTransfer = startBankTransfer;
        window.reviewBkashTransfer = reviewBkashTransfer;
        window.reviewBankTransfer = reviewBankTransfer;
        window.submitFundTransfer = submitFundTransfer;
        window.payInstallment = payInstallment;
        window.clearLoan = clearLoan;
        window.openCreateUserModal = openCreateUserModal;
        window.closeCreateUserModal = closeCreateUserModal;
        window.openEditUserModal = openEditUserModal;
        window.closeEditUserModal = closeEditUserModal;
        window.openUserDepositModal = openUserDepositModal;
        window.closeDepositModal = closeDepositModal;
        window.openDeleteUserModal = openDeleteUserModal;
        window.closeDeleteUserModal = closeDeleteUserModal;
        window.showApproveTransactionModal = showApproveTransactionModal;
        window.closeApproveTransactionModal = closeApproveTransactionModal;
        window.showRejectTransactionModal = showRejectTransactionModal;
        window.closeRejectTransactionModal = closeRejectTransactionModal;
        window.showApproveFundTransferModal = showApproveFundTransferModal;
        window.closeApproveFundTransferModal = closeApproveFundTransferModal;
        window.showRejectFundTransferModal = showRejectFundTransferModal;
        window.closeRejectFundTransferModal = closeRejectFundTransferModal;
        window.showApproveLoanModal = showApproveLoanModal;
        window.closeApproveLoanModal = closeApproveLoanModal;
        window.showRejectLoanModal = showRejectLoanModal;
        window.closeRejectLoanModal = closeRejectLoanModal;
        window.confirmApproveTransaction = confirmApproveTransaction;
        window.confirmRejectTransaction = confirmRejectTransaction;
        window.confirmApproveFundTransfer = confirmApproveFundTransfer;
        window.confirmRejectFundTransfer = confirmRejectFundTransfer;
        window.confirmApproveLoan = confirmApproveLoan;
        window.confirmRejectLoan = confirmRejectLoan;

    </script>
</body>
</html>
