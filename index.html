<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Black Bee - Digital Payment Solution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f0f0f;
            color: #ffffff;
        }
        
        /* Dark theme overrides */
        .dark-bg {
            background-color: #0f0f0f;
        }
        
        .card-bg {
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
        }
        
        .header-bg {
            background-color: #000000;
            border-bottom: 1px solid #2a2a2a;
        }
        
        .yellow-gradient {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        }
        
        .yellow-text {
            color: #FFD700;
        }
        
        .gray-text {
            color: #a0a0a0;
        }
        
        .border-gray-dark {
            border-color: #2a2a2a;
        }
        
        /* Black Bee specific styles */
        .bee-card {
            background: linear-gradient(145deg, #1a1a1a 0%, #151515 100%);
            border: 1px solid #333;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .bee-button {
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 12px;
            transition: all 0.3s;
        }
        
        .bee-button:hover {
            background: #333;
            transform: translateY(-2px);
        }
        
        .bee-yellow-button {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            color: #000;
            font-weight: 600;
            border-radius: 12px;
        }
        
        .bee-yellow-button:hover {
            opacity: 0.9;
        }
        
        /* Balance display */
        .balance-display {
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -1px;
            text-shadow: 0 2px 10px rgba(255, 215, 0, 0.2);
        }
        
        /* Loan badge */
        .loan-badge {
            background: rgba(255, 0, 0, 0.15);
            border: 1px solid rgba(255, 0, 0, 0.3);
            color: #ff4444;
            border-radius: 20px;
        }
        
        /* Icon containers */
        .icon-container {
            width: 50px;
            height: 50px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: #2a2a2a;
            border: 1px solid #333;
        }
        
        /* Animation for fade in */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Bottom navigation */
        .bottom-nav {
            background: #000000;
            border-top: 1px solid #2a2a2a;
            padding: 12px 0;
        }
        
        .nav-item {
            color: #a0a0a0;
            transition: color 0.3s;
        }
        
        .nav-item.active {
            color: #FFD700;
        }
        
        .nav-item:hover {
            color: #ffffff;
        }
        
        /* Notification badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #FF4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Dropdown menu */
        .dropdown-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            min-width: 150px;
            z-index: 40;
            display: none;
        }
        
        .dropdown-menu.show {
            display: block;
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: #ffffff;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .dropdown-item:hover {
            background-color: #2a2a2a;
        }
        
        .dropdown-item.delete {
            color: #ff4444;
        }
        
        /* Loading screen */
        .loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #0f0f0f;
        }
        
        .loading-logo {
            width: 120px;
            height: 120px;
            margin-bottom: 1rem;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        /* Success page */
        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.5s ease-out;
        }
        
        .success-card {
            background: linear-gradient(145deg, #1a1a1a 0%, #151515 100%);
            border: 1px solid #333;
            border-radius: 24px;
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            text-align: center;
            color: white;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2.5rem;
            color: #000;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 20px;
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            color: white;
        }
        
        /* Input styles */
        .bee-input {
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 12px;
            color: white;
            padding: 0.75rem 1rem;
            width: 100%;
        }
        
        .bee-input:focus {
            outline: none;
            border-color: #FFD700;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }
        
        /* Hold to pay button */
        .hold-to-pay-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
            user-select: none;
            border: none;
        }
        
        .hold-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(255, 215, 0, 0.3);
            width: 0%;
            transition: width 2s linear;
            z-index: 1;
        }
        
        .hold-to-pay-btn.holding .hold-progress {
            animation: fillProgress 2s linear forwards;
        }
        
        @keyframes fillProgress {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        /* Status badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-active {
            background: rgba(0, 255, 0, 0.1);
            color: #00ff00;
            border: 1px solid rgba(0, 255, 0, 0.3);
        }
        
        .status-pending {
            background: rgba(255, 215, 0, 0.1);
            color: #FFD700;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .status-rejected {
            background: rgba(255, 0, 0, 0.1);
            color: #ff4444;
            border: 1px solid rgba(255, 0, 0, 0.3);
        }
    </style>
</head>
<body class="dark-bg text-white min-h-screen">
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 transform translate-x-full transition-transform duration-300 z-50 bg-black border-l-4 border-gray-500 shadow-lg rounded-r p-4 flex items-center hidden">
        <div id="toast-icon" class="text-gray-400 mr-3"><i class="fas fa-info-circle"></i></div>
        <div>
            <p id="toast-title" class="font-bold text-sm">Notification</p>
            <p id="toast-message" class="text-xs text-gray-400">Message content</p>
        </div>
    </div>

    <!-- Success Overlay -->
    <div id="successPage" class="success-overlay hidden">
        <div class="success-card fade-in">
            <div class="success-icon">
                <i id="successIcon" class="fas fa-check"></i>
            </div>
            <h1 id="successTitle" class="text-xl font-bold mb-2">Payment Successful</h1>
            <p id="successMessage" class="text-gray-400 mb-4">Your transaction has been processed successfully</p>
            <div id="successAmount" class="text-2xl font-bold yellow-text mb-2">৳0.00</div>
            <div id="successMethod" class="text-gray-400 mb-6">Via Method</div>
            <p class="text-sm text-gray-500">You will be redirected in <span id="countdown">5</span> seconds</p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="dbLoading" class="success-overlay hidden">
        <div class="success-card">
            <div class="flex flex-col items-center">
                <div class="w-16 h-16 border-4 border-t-yellow-500 border-gray-700 rounded-full animate-spin mb-4"></div>
                <h2 class="text-xl font-bold mb-2">Processing</h2>
                <p class="text-gray-400">Please wait...</p>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app" class="min-h-screen pb-20">
        <!-- Loading Screen -->
        <div class="loading-screen">
            <div class="bee-card p-8 flex flex-col items-center">
                <div class="icon-container yellow-gradient mb-4">
                    <i class="fas fa-bee text-black"></i>
                </div>
                <h1 class="text-2xl font-bold mb-2">Black Bee</h1>
                <p class="text-gray-400 mb-6">Digital Payment Solution</p>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-yellow-500 rounded-full animate-pulse mr-2"></div>
                    <p class="text-gray-400">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        /**
         * FIREBASE INTEGRATION
         */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD5fr0JZKm9ZvVHY6CRNoi8KqLOXDDIdUY",
            authDomain: "coffee-spark-ai-barista-7951b.firebaseapp.com",
            projectId: "coffee-spark-ai-barista-7951b",
            storageBucket: "coffee-spark-ai-barista-7951b.firebasestorage.app",
            messagingSenderId: "720643698314",
            appId: "1:720643698314:web:546679d3d90210384e4773"
        };
        
        const appInstance = initializeApp(firebaseConfig);
        const auth = getAuth(appInstance);
        const db = getFirestore(appInstance);
        const appId = 'mizx-pay-live';

        // State Management
        let localUsers = [];
        let localHistory = [];
        let localTransactions = [];
        let localSendMoneyHistory = [];
        let currentUser = null;
        let currentView = 'dashboard';
        let currentUserView = 'dashboard';
        let successTimer = null;
        let selectedRecipient = null;
        let holdTimer = null;
        let isHolding = false;

        // Default Users
        const defaultUsers = [
            { 
                id: 1, 
                username: 'Mizx999', 
                password: '123', 
                role: 'admin', 
                balance: 0, 
                isLocked: false, 
                fullName: 'System Administrator', 
                email: 'admin@blackbee.com',
                phone: '+8801700000000',
                address: '',
                accountType: 'vip',
                createdAt: new Date().toISOString(),
                loanAmount: 0,
                loanActive: false
            },
            { 
                id: 2, 
                username: 'muzahid0x2', 
                password: 'password', 
                role: 'user', 
                balance: 1150.00, 
                isLocked: false, 
                fullName: 'Muzahidul Islam', 
                email: 'muzahid@example.com',
                phone: '+8801712345678',
                address: '',
                accountType: 'member',
                createdAt: new Date().toISOString(),
                loanAmount: 500.00,
                loanActive: true
            },
            { 
                id: 3, 
                username: 'user2', 
                password: 'password', 
                role: 'user', 
                balance: 250.50, 
                isLocked: false, 
                fullName: 'Jane Smith',
                email: 'jane@example.com',
                phone: '+8801711111111',
                address: 'Dhaka, Bangladesh',
                accountType: 'standard',
                createdAt: new Date().toISOString(),
                loanAmount: 0,
                loanActive: false
            }
        ];

        // Format currency
        function formatCurrency(amount) {
            return `৳${amount.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        }

        // Initialize Auth
        async function initAuth() {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth Error:", error);
                showToast('Connection Error', 'Could not connect to database', 'error');
            }
        }

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Connected to Firebase as:", user.uid);
                setupRealtimeListeners();
            }
        });

        function setupRealtimeListeners() {
            const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
            const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'fundHistory');
            const transactionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
            const sendMoneyHistoryRef = collection(db, 'artifacts', appId, 'public', 'data', 'sendMoneyHistory');

            // Users listener
            onSnapshot(usersRef, (snapshot) => {
                localUsers = [];
                snapshot.forEach((doc) => {
                    localUsers.push({ 
                        ...doc.data(), 
                        docId: doc.id,
                        email: doc.data().email || '',
                        phone: doc.data().phone || '',
                        address: doc.data().address || '',
                        accountType: doc.data().accountType || 'normal',
                        loanAmount: doc.data().loanAmount || 0,
                        loanActive: doc.data().loanActive || false
                    });
                });
                
                if (localUsers.length === 0 && !window.hasSeeded) {
                    window.hasSeeded = true;
                    defaultUsers.forEach(async (u) => {
                        await addDoc(usersRef, u);
                    });
                    return;
                }

                if (currentUser) {
                    const updated = localUsers.find(u => u.id === currentUser.id);
                    if (updated) currentUser = updated;
                }

                refreshUI();
            });

            // History listener
            onSnapshot(historyRef, (snapshot) => {
                localHistory = [];
                snapshot.forEach((doc) => {
                    localHistory.push({ ...doc.data(), docId: doc.id });
                });
                refreshUI();
            });

            // Transactions listener
            onSnapshot(transactionsRef, (snapshot) => {
                localTransactions = [];
                snapshot.forEach((doc) => {
                    localTransactions.push({ ...doc.data(), docId: doc.id });
                });
                refreshUI();
            });

            // Send Money History listener
            onSnapshot(sendMoneyHistoryRef, (snapshot) => {
                localSendMoneyHistory = [];
                snapshot.forEach((doc) => {
                    localSendMoneyHistory.push({ ...doc.data(), docId: doc.id });
                });
                refreshUI();
            });
        }

        function refreshUI() {
            const app = document.getElementById('app');
            app.classList.remove('loading-screen');
            
            if (!currentUser) {
                renderLogin();
            } else if (currentUser.role === 'admin') {
                renderAdminPanel();
            } else {
                renderUserPanel();
            }
        }

        // Firebase document ID helper
        function getFirestoreDocId(numericId) {
            const user = localUsers.find(u => u.id === numericId);
            return user ? user.docId : null;
        }

        // UI Utilities
        function showToast(title, message, type = 'info') {
            const toast = document.getElementById('toast');
            const tTitle = document.getElementById('toast-title');
            const tMsg = document.getElementById('toast-message');
            const tIcon = document.getElementById('toast-icon');

            tTitle.innerText = title;
            tMsg.innerText = message;
            toast.classList.remove('hidden', 'translate-x-full');
            
            if(type === 'error') {
                toast.classList.replace('border-gray-500', 'border-red-500');
                tIcon.innerHTML = '<i class="fas fa-exclamation-circle text-red-500"></i>';
            } else if (type === 'success') {
                toast.classList.replace('border-gray-500', 'border-green-500');
                tIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
            } else {
                toast.classList.replace('border-red-500', 'border-gray-500');
                tIcon.innerHTML = '<i class="fas fa-info-circle text-gray-400"></i>';
            }

            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        function showDBLoading() {
            const loading = document.getElementById('dbLoading');
            loading.classList.remove('hidden');
        }

        function hideDBLoading() {
            const loading = document.getElementById('dbLoading');
            loading.classList.add('hidden');
        }

        function showSuccessPage(type, amount, method = '', recipientName = '') {
            const successPage = document.getElementById('successPage');
            const successIcon = document.getElementById('successIcon');
            const successTitle = document.getElementById('successTitle');
            const successMessage = document.getElementById('successMessage');
            const successAmount = document.getElementById('successAmount');
            const successMethod = document.getElementById('successMethod');
            const countdownElement = document.getElementById('countdown');
            
            if (successTimer) clearInterval(successTimer);
            
            if (type === 'deposit') {
                successIcon.className = 'fas fa-check';
                successTitle.textContent = 'Payment Successful';
                successMessage.textContent = `Your deposit of ${formatCurrency(amount)} has been submitted for approval.`;
                successMethod.textContent = `Via ${method.toUpperCase()}`;
            } else if (type === 'withdraw') {
                successIcon.className = 'fas fa-check';
                successTitle.textContent = 'Withdrawal Requested';
                successMessage.textContent = `Your withdrawal of ${formatCurrency(amount)} has been submitted for approval.`;
                successMethod.textContent = `Via ${method.toUpperCase()}`;
            } else if (type === 'sendmoney') {
                successIcon.className = 'fas fa-exchange-alt';
                successTitle.textContent = 'Send Money Successful!';
                successMessage.textContent = `Your money transfer has been completed successfully.`;
                successMethod.textContent = 'DIRECT TRANSFER';
            }
            
            successAmount.textContent = formatCurrency(amount);
            successPage.classList.remove('hidden');
            
            let seconds = 5;
            countdownElement.textContent = seconds;
            
            successTimer = setInterval(() => {
                seconds--;
                countdownElement.textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(successTimer);
                    successPage.classList.add('hidden');
                    if (type === 'sendmoney') {
                        setUserCurrentView('dashboard');
                    }
                }
            }, 1000);
        }

        // Render Login Page
        function renderLogin() {
            const app = document.getElementById('app');
            app.className = "min-h-screen pb-20 flex items-center justify-center p-4";
            app.innerHTML = `
                <div class="w-full max-w-md fade-in">
                    <div class="bee-card p-8 mb-6 text-center">
                        <div class="icon-container yellow-gradient mx-auto mb-4">
                            <i class="fas fa-bee text-black"></i>
                        </div>
                        <h1 class="text-3xl font-bold mb-2">Black Bee</h1>
                        <p class="text-gray-400 mb-8">Digital Payment Solution</p>
                        
                        <form id="loginForm" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">User ID</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                        <i class="fas fa-user"></i>
                                    </span>
                                    <input type="text" id="username" class="bee-input pl-10" placeholder="Enter User ID" required>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Password</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                        <i class="fas fa-lock"></i>
                                    </span>
                                    <input type="password" id="password" class="bee-input pl-10" placeholder="Enter Password" required>
                                    <button type="button" onclick="togglePasswordVisibility()" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-gray-300">
                                        <i class="fas fa-eye" id="eyeIcon"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <button type="submit" class="w-full bee-yellow-button py-3 rounded-xl font-bold text-black">
                                Login to Dashboard
                            </button>
                        </form>
                        
                        <div class="mt-6 pt-6 border-t border-gray-800">
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-shield-alt mr-1"></i> Secure System. Your data is protected.
                            </p>
                        </div>
                    </div>
                    
                    <div class="text-center text-gray-500 text-sm">
                        <p>Don't have an account? Contact administration</p>
                    </div>
                </div>
            `;

            const form = document.getElementById('loginForm');
            if(form) form.addEventListener('submit', handleLogin);
        }

        // Render User Panel (Black Bee Style)
        function renderUserPanel() {
            const app = document.getElementById('app');
            app.className = "min-h-screen pb-20";
            
            // Determine active nav item
            const dashboardActive = currentUserView === 'dashboard' ? 'active' : '';
            const depositActive = currentUserView === 'deposit' ? 'active' : '';
            const withdrawActive = currentUserView === 'withdraw' ? 'active' : '';
            const sendmoneyActive = currentUserView === 'sendmoney' ? 'active' : '';
            const historyActive = currentUserView === 'history' ? 'active' : '';
            const profileActive = currentUserView === 'profile' ? 'active' : '';
            
            app.innerHTML = `
                <!-- Header -->
                <div class="header-bg p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <h1 class="text-2xl font-bold mb-1">Black Bee</h1>
                            <div class="flex items-center space-x-2 mb-2">
                                <h2 class="text-lg font-semibold">${currentUser.fullName}</h2>
                                <span class="text-xs yellow-text bg-black px-2 py-1 rounded-full">BLACK BEE MEMBER</span>
                            </div>
                            <p class="text-gray-400 text-sm">@${currentUser.username}</p>
                        </div>
                        <button onclick="logout()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-sign-out-alt text-xl"></i>
                        </button>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="p-4 fade-in">
                    ${currentUserView === 'dashboard' ? renderUserDashboard() : 
                      currentUserView === 'deposit' ? renderUserDeposit() : 
                      currentUserView === 'withdraw' ? renderUserWithdraw() : 
                      currentUserView === 'sendmoney' ? renderUserSendMoney() :
                      currentUserView === 'history' ? renderUserHistory() :
                      currentUserView === 'profile' ? renderUserProfile() : ''}
                </div>

                <!-- Bottom Navigation -->
                <div class="bottom-nav fixed bottom-0 left-0 right-0 z-30">
                    <div class="flex justify-around">
                        <button onclick="setUserCurrentView('dashboard')" class="nav-item ${dashboardActive} flex flex-col items-center">
                            <i class="fas fa-home text-xl mb-1"></i>
                            <span class="text-xs">Home</span>
                        </button>
                        
                        <button onclick="setUserCurrentView('history')" class="nav-item ${historyActive} flex flex-col items-center">
                            <i class="fas fa-history text-xl mb-1"></i>
                            <span class="text-xs">History</span>
                        </button>
                        
                        <button class="nav-item flex flex-col items-center relative">
                            <i class="fas fa-inbox text-xl mb-1"></i>
                            <span class="text-xs">Inbox</span>
                            <span class="notification-badge">3</span>
                        </button>
                        
                        <button onclick="setUserCurrentView('profile')" class="nav-item ${profileActive} flex flex-col items-center">
                            <i class="fas fa-user-circle text-xl mb-1"></i>
                            <span class="text-xs">Profile</span>
                        </button>
                    </div>
                </div>
            `;
            
            // Add form event listeners based on current view
            setupFormListeners();
        }

        // Render User Dashboard (Black Bee Style)
        function renderUserDashboard() {
            const user = currentUser;
            const hasActiveLoan = user.loanActive && user.loanAmount > 0;
            
            return `
                <!-- Current Balance & Active Loan -->
                <div class="bee-card p-6 mb-6">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <p class="text-gray-400 text-sm mb-1">CURRENT BALANCE</p>
                            <div class="balance-display yellow-text">${formatCurrency(user.balance)}</div>
                        </div>
                        ${hasActiveLoan ? `
                            <div class="loan-badge px-4 py-2">
                                <p class="text-sm font-bold">ACTIVE LOAN</p>
                                <p class="text-lg font-bold">${formatCurrency(user.loanAmount)}</p>
                                <p class="text-xs text-gray-400">Loan Amount Received: $ ${user.loanAmount}</p>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="text-center">
                        <button onclick="setUserCurrentView('sendmoney')" class="bee-yellow-button w-full py-3 rounded-xl font-bold text-black mb-4">
                            Send Money
                        </button>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <button onclick="setUserCurrentView('deposit')" class="bee-button p-4 flex flex-col items-center">
                        <div class="icon-container mb-2">
                            <i class="fas fa-plus"></i>
                        </div>
                        <span class="text-sm font-medium">Add Money</span>
                    </button>
                    
                    <button onclick="setUserCurrentView('sendmoney')" class="bee-button p-4 flex flex-col items-center">
                        <div class="icon-container mb-2">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <span class="text-sm font-medium">Fund Transfer</span>
                    </button>
                    
                    <button class="bee-button p-4 flex flex-col items-center">
                        <div class="icon-container mb-2">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <span class="text-sm font-medium">Bkash Agent Out</span>
                    </button>
                </div>

                <!-- History Section -->
                <div class="grid grid-cols-2 gap-3 mb-8">
                    <button class="bee-button p-4 flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="icon-container mr-3">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium">Loan (Active)</p>
                                <p class="text-xs text-gray-400">Manage your loan</p>
                            </div>
                        </div>
                        <i class="fas fa-arrow-right text-gray-400"></i>
                    </button>
                    
                    <button class="bee-button p-4 flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="icon-container mr-3">
                                <i class="fas fa-question-circle"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium">Help</p>
                                <p class="text-xs text-gray-400">Get support</p>
                            </div>
                        </div>
                        <i class="fas fa-arrow-right text-gray-400"></i>
                    </button>
                </div>

                <!-- Recent Activity -->
                <div class="bee-card p-6">
                    <h3 class="text-lg font-bold mb-4">Recent Activity</h3>
                    ${renderRecentActivity()}
                </div>
                
                ${user.isLocked ? `
                    <div class="mt-6 p-4 border border-red-800 bg-red-900/20 rounded-xl">
                        <div class="flex items-center">
                            <i class="fas fa-lock text-red-400 mr-3"></i>
                            <div>
                                <p class="text-red-400 font-medium">Account Locked</p>
                                <p class="text-sm text-gray-400">Contact administration to unlock your account</p>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function renderRecentActivity() {
            const userHistory = localHistory
                .filter(log => log.userId === currentUser.id)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);

            if (userHistory.length === 0) {
                return `
                    <div class="text-center py-8">
                        <i class="fas fa-history text-3xl text-gray-700 mb-3"></i>
                        <p class="text-gray-500">No transactions recorded yet</p>
                        <p class="text-sm text-gray-600 mt-1">Make your first transaction to see activity here</p>
                    </div>
                `;
            }

            return userHistory.map(log => {
                const isDeposit = log.type === 'deposit';
                const isSendMoney = log.type === 'sendmoney';
                
                return `
                    <div class="flex items-center justify-between py-3 border-b border-gray-800 last:border-0">
                        <div class="flex items-center">
                            <div class="icon-container mr-3 ${isDeposit ? 'bg-green-900/30 border-green-800' : 'bg-blue-900/30 border-blue-800'}">
                                <i class="fas ${isDeposit ? 'fa-arrow-down' : isSendMoney ? 'fa-exchange-alt' : 'fa-arrow-up'} ${isDeposit ? 'text-green-400' : isSendMoney ? 'text-blue-400' : 'text-red-400'}"></i>
                            </div>
                            <div>
                                <p class="font-medium">${isDeposit ? 'Deposit' : isSendMoney ? 'Send Money' : 'Withdrawal'}</p>
                                <p class="text-xs text-gray-400">${new Date(log.timestamp).toLocaleDateString()}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold ${isDeposit ? 'text-green-400' : 'text-red-400'}">${isDeposit ? '+' : '-'} ${formatCurrency(log.amount)}</p>
                            <p class="text-xs text-gray-400">${log.status || 'completed'}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render User Deposit Page
        function renderUserDeposit() {
            if (currentUser.isLocked) {
                return renderLockedMessage();
            }
            
            return `
                <div class="bee-card p-6">
                    <h2 class="text-xl font-bold mb-6">Add Money</h2>
                    
                    <form id="depositForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Amount</label>
                            <input type="number" id="depositAmount" min="10" step="0.01" class="bee-input" placeholder="Enter amount" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-3">Payment Method</label>
                            <div class="grid grid-cols-3 gap-3">
                                <label class="bee-button p-3 flex flex-col items-center cursor-pointer">
                                    <input type="radio" name="depositMethod" value="bkash" class="hidden" required>
                                    <i class="fas fa-mobile-alt text-xl mb-2"></i>
                                    <span class="text-sm">Bkash</span>
                                </label>
                                
                                <label class="bee-button p-3 flex flex-col items-center cursor-pointer">
                                    <input type="radio" name="depositMethod" value="nagad" class="hidden">
                                    <i class="fas fa-wallet text-xl mb-2"></i>
                                    <span class="text-sm">Nagad</span>
                                </label>
                                
                                <label class="bee-button p-3 flex flex-col items-center cursor-pointer">
                                    <input type="radio" name="depositMethod" value="bank" class="hidden">
                                    <i class="fas fa-university text-xl mb-2"></i>
                                    <span class="text-sm">Bank</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Transaction ID</label>
                            <input type="text" id="depositTrxId" class="bee-input" placeholder="Enter Transaction ID" required>
                        </div>
                        
                        <button type="button" id="depositHoldButton" class="hold-to-pay-btn bee-yellow-button w-full py-3 rounded-xl font-bold text-black relative">
                            <div class="hold-progress"></div>
                            <div class="relative z-10">
                                <i class="fas fa-hand-holding mr-2"></i>
                                Hold to Submit
                            </div>
                        </button>
                        <p class="text-center text-xs text-gray-500 mt-2">Press and hold for 2 seconds to confirm</p>
                    </form>
                </div>
                
                <div class="mt-6 p-4 border border-yellow-800 bg-yellow-900/20 rounded-xl">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-yellow-400 mr-3 mt-1"></i>
                        <div>
                            <p class="text-yellow-400 font-medium">Important</p>
                            <p class="text-sm text-gray-400">Your deposit will be processed after verification. This may take up to 24 hours.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render User Withdraw Page
        function renderUserWithdraw() {
            if (currentUser.isLocked) {
                return renderLockedMessage();
            }
            
            return `
                <div class="bee-card p-6">
                    <h2 class="text-xl font-bold mb-6">Withdraw Money</h2>
                    
                    <div class="mb-6 p-4 border border-blue-800 bg-blue-900/20 rounded-xl">
                        <div class="flex items-center">
                            <i class="fas fa-wallet text-blue-400 mr-3"></i>
                            <div>
                                <p class="text-blue-400 font-medium">Available Balance</p>
                                <p class="text-2xl font-bold">${formatCurrency(currentUser.balance)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <form id="withdrawForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Amount</label>
                            <input type="number" id="withdrawAmount" min="10" step="0.01" max="${currentUser.balance}" class="bee-input" placeholder="Enter amount" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-3">Withdrawal Method</label>
                            <div class="grid grid-cols-3 gap-3">
                                <label class="bee-button p-3 flex flex-col items-center cursor-pointer">
                                    <input type="radio" name="withdrawMethod" value="bkash" class="hidden" required>
                                    <i class="fas fa-mobile-alt text-xl mb-2"></i>
                                    <span class="text-sm">Bkash</span>
                                </label>
                                
                                <label class="bee-button p-3 flex flex-col items-center cursor-pointer">
                                    <input type="radio" name="withdrawMethod" value="nagad" class="hidden">
                                    <i class="fas fa-wallet text-xl mb-2"></i>
                                    <span class="text-sm">Nagad</span>
                                </label>
                                
                                <label class="bee-button p-3 flex flex-col items-center cursor-pointer">
                                    <input type="radio" name="withdrawMethod" value="bank" class="hidden">
                                    <i class="fas fa-university text-xl mb-2"></i>
                                    <span class="text-sm">Bank</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Account Number</label>
                            <input type="text" id="withdrawAccount" class="bee-input" placeholder="Enter account number" required>
                        </div>
                        
                        <button type="button" id="withdrawHoldButton" class="hold-to-pay-btn bee-yellow-button w-full py-3 rounded-xl font-bold text-black relative">
                            <div class="hold-progress"></div>
                            <div class="relative z-10">
                                <i class="fas fa-hand-holding mr-2"></i>
                                Hold to Request
                            </div>
                        </button>
                        <p class="text-center text-xs text-gray-500 mt-2">Press and hold for 2 seconds to confirm</p>
                    </form>
                </div>
            `;
        }

        // Render User Send Money Page
        function renderUserSendMoney() {
            if (currentUser.isLocked) {
                return renderLockedMessage();
            }
            
            return `
                <div class="bee-card p-6 mb-6">
                    <h2 class="text-xl font-bold mb-6">Send Money</h2>
                    
                    <form id="sendMoneyForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Recipient Username</label>
                            <input type="text" id="recipientUsername" class="bee-input" placeholder="Enter username" oninput="searchRecipient()">
                            <div id="recipientResults" class="mt-2 space-y-2"></div>
                        </div>
                        
                        ${selectedRecipient ? `
                            <div class="p-4 border border-green-800 bg-green-900/20 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center mr-3">
                                            <span class="font-bold">${selectedRecipient.fullName.charAt(0)}</span>
                                        </div>
                                        <div>
                                            <p class="font-medium">${selectedRecipient.fullName}</p>
                                            <p class="text-sm text-gray-400">@${selectedRecipient.username}</p>
                                        </div>
                                    </div>
                                    <button type="button" onclick="clearRecipient()" class="text-red-400">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Amount</label>
                                <input type="number" id="sendMoneyAmount" min="10" step="0.01" max="${currentUser.balance}" class="bee-input" placeholder="Enter amount" required>
                            </div>
                            
                            <button type="button" id="sendMoneyHoldButton" class="hold-to-pay-btn bee-yellow-button w-full py-3 rounded-xl font-bold text-black relative">
                                <div class="hold-progress"></div>
                                <div class="relative z-10">
                                    <i class="fas fa-hand-holding mr-2"></i>
                                    Hold to Send
                                </div>
                            </button>
                            <p class="text-center text-xs text-gray-500 mt-2">Press and hold for 2 seconds to confirm</p>
                        ` : ''}
                    </form>
                </div>
                
                ${selectedRecipient ? `
                    <div class="p-4 border border-green-800 bg-green-900/20 rounded-xl">
                        <div class="flex items-start">
                            <i class="fas fa-bolt text-green-400 mr-3 mt-1"></i>
                            <div>
                                <p class="text-green-400 font-medium">Instant Transfer</p>
                                <p class="text-sm text-gray-400">Money will be transferred instantly to the recipient</p>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // Render User History Page
        function renderUserHistory() {
            const userSendMoneyHistory = localSendMoneyHistory
                .filter(log => log.userId === currentUser.id || log.recipientId === currentUser.id)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            return `
                <div class="bee-card p-6">
                    <h2 class="text-xl font-bold mb-6">Transaction History</h2>
                    
                    <div class="space-y-4">
                        ${userSendMoneyHistory.length > 0 ? userSendMoneyHistory.map(log => {
                            const isSender = log.userId === currentUser.id;
                            const otherUser = isSender ? (log.recipientName || 'Unknown') : (log.senderName || 'Unknown');
                            
                            return `
                                <div class="flex items-center justify-between p-3 border border-gray-800 rounded-xl">
                                    <div class="flex items-center">
                                        <div class="icon-container mr-3 ${isSender ? 'bg-purple-900/30 border-purple-800' : 'bg-green-900/30 border-green-800'}">
                                            <i class="fas ${isSender ? 'fa-arrow-up' : 'fa-arrow-down'} ${isSender ? 'text-purple-400' : 'text-green-400'}"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium">${isSender ? 'Sent to' : 'Received from'} ${otherUser}</p>
                                            <p class="text-xs text-gray-400">${new Date(log.timestamp).toLocaleString()}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold ${isSender ? 'text-red-400' : 'text-green-400'}">${isSender ? '-' : '+'} ${formatCurrency(log.amount)}</p>
                                        <span class="status-badge status-active">Completed</span>
                                    </div>
                                </div>
                            `;
                        }).join('') : `
                            <div class="text-center py-8">
                                <i class="fas fa-history text-3xl text-gray-700 mb-3"></i>
                                <p class="text-gray-500">No transaction history</p>
                                <p class="text-sm text-gray-600 mt-1">Your transactions will appear here</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // Render User Profile Page
        function renderUserProfile() {
            return `
                <div class="bee-card p-6">
                    <div class="text-center mb-6">
                        <div class="w-20 h-20 yellow-gradient rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-2xl font-bold text-black">${currentUser.fullName.charAt(0)}</span>
                        </div>
                        <h2 class="text-xl font-bold">${currentUser.fullName}</h2>
                        <p class="text-gray-400">@${currentUser.username}</p>
                        <div class="mt-2">
                            <span class="inline-block px-3 py-1 bg-black text-yellow-500 text-xs font-bold rounded-full">BLACK BEE MEMBER</span>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 border border-gray-800 rounded-xl">
                            <span class="text-gray-400">Account Balance</span>
                            <span class="font-bold yellow-text">${formatCurrency(currentUser.balance)}</span>
                        </div>
                        
                        <div class="flex justify-between items-center p-3 border border-gray-800 rounded-xl">
                            <span class="text-gray-400">Account Status</span>
                            <span class="font-bold ${currentUser.isLocked ? 'text-red-400' : 'text-green-400'}">${currentUser.isLocked ? 'Locked' : 'Active'}</span>
                        </div>
                        
                        <div class="flex justify-between items-center p-3 border border-gray-800 rounded-xl">
                            <span class="text-gray-400">Member Since</span>
                            <span class="font-medium">${new Date(currentUser.createdAt).toLocaleDateString()}</span>
                        </div>
                        
                        ${currentUser.loanActive ? `
                            <div class="flex justify-between items-center p-3 border border-red-800 rounded-xl">
                                <span class="text-gray-400">Active Loan</span>
                                <span class="font-bold text-red-400">${formatCurrency(currentUser.loanAmount)}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="mt-6 pt-6 border-t border-gray-800">
                        <h3 class="text-lg font-bold mb-4">Contact Information</h3>
                        <div class="space-y-3">
                            ${currentUser.email ? `
                                <div class="flex items-center text-gray-400">
                                    <i class="fas fa-envelope mr-3"></i>
                                    <span>${currentUser.email}</span>
                                </div>
                            ` : ''}
                            
                            ${currentUser.phone ? `
                                <div class="flex items-center text-gray-400">
                                    <i class="fas fa-phone mr-3"></i>
                                    <span>${currentUser.phone}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Render Locked Message
        function renderLockedMessage() {
            return `
                <div class="bee-card p-6 text-center">
                    <div class="w-16 h-16 bg-red-900/30 border border-red-800 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-lock text-red-400 text-2xl"></i>
                    </div>
                    <h2 class="text-xl font-bold mb-2">Account Locked</h2>
                    <p class="text-gray-400 mb-4">Dear Client! Your account has been Locked. Contact the Administration to unlock your account.</p>
                    <button onclick="setUserCurrentView('dashboard')" class="bee-button w-full py-3 rounded-xl font-medium">
                        Return to Dashboard
                    </button>
                </div>
            `;
        }

        // Render Admin Panel (Black Bee Style)
        function renderAdminPanel() {
            const users = localUsers.filter(u => u.role !== 'admin');
            const totalUsers = users.length;
            const totalBalance = users.reduce((acc, curr) => acc + curr.balance, 0);
            const activeUsers = users.filter(u => !u.isLocked).length;
            const pendingTransactions = localTransactions.filter(t => t.status === 'pending').length;
            
            const app = document.getElementById('app');
            app.className = "min-h-screen";
            
            app.innerHTML = `
                <!-- Admin Header -->
                <div class="header-bg p-6">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <div class="icon-container yellow-gradient mr-3">
                                <i class="fas fa-bee text-black"></i>
                            </div>
                            <div>
                                <h1 class="text-xl font-bold">Admin Console</h1>
                                <p class="text-sm text-gray-400">Black Bee System</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm bg-gray-800 px-3 py-1 rounded-full">${currentUser.username}</span>
                            <button onclick="logout()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Admin Navigation -->
                    <div class="flex space-x-4 mt-4 overflow-x-auto">
                        <button onclick="setCurrentView('dashboard')" class="px-4 py-2 rounded-xl ${currentView === 'dashboard' ? 'bg-gray-800' : 'bg-transparent hover:bg-gray-800/50'}">
                            Dashboard
                        </button>
                        <button onclick="setCurrentView('users')" class="px-4 py-2 rounded-xl ${currentView === 'users' ? 'bg-gray-800' : 'bg-transparent hover:bg-gray-800/50'}">
                            Users
                        </button>
                        <button onclick="setCurrentView('transactions')" class="px-4 py-2 rounded-xl ${currentView === 'transactions' ? 'bg-gray-800' : 'bg-transparent hover:bg-gray-800/50'} relative">
                            Transactions
                            ${pendingTransactions > 0 ? `<span class="notification-badge">${pendingTransactions}</span>` : ''}
                        </button>
                        <button onclick="setCurrentView('history')" class="px-4 py-2 rounded-xl ${currentView === 'history' ? 'bg-gray-800' : 'bg-transparent hover:bg-gray-800/50'}">
                            History
                        </button>
                    </div>
                </div>

                <!-- Admin Content -->
                <div class="p-4 fade-in">
                    ${currentView === 'dashboard' ? renderAdminDashboard(users, totalUsers, totalBalance, activeUsers) :
                      currentView === 'users' ? renderAdminUsers(users) :
                      currentView === 'transactions' ? renderAdminTransactions() :
                      currentView === 'history' ? renderAdminHistory() : ''}
                </div>

                <!-- Admin Modals -->
                ${getAdminModals()}
            `;
            
            // Add admin event listeners
            setupAdminListeners();
        }

        function renderAdminDashboard(users, totalUsers, totalBalance, activeUsers) {
            return `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bee-card p-6">
                        <div class="flex items-center">
                            <div class="icon-container mr-4">
                                <i class="fas fa-users"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">Total Users</p>
                                <p class="text-2xl font-bold">${totalUsers}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bee-card p-6">
                        <div class="flex items-center">
                            <div class="icon-container mr-4">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">System Balance</p>
                                <p class="text-2xl font-bold yellow-text">${formatCurrency(totalBalance)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bee-card p-6">
                        <div class="flex items-center">
                            <div class="icon-container mr-4">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">Active Users</p>
                                <p class="text-2xl font-bold">${activeUsers}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bee-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Recent Transactions</h2>
                        <button onclick="setCurrentView('transactions')" class="text-sm text-yellow-500 hover:text-yellow-400">
                            View All
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        ${localTransactions.slice(0, 5).map(tx => {
                            const user = localUsers.find(u => u.id === tx.userId);
                            return `
                                <div class="flex items-center justify-between p-3 border border-gray-800 rounded-xl">
                                    <div class="flex items-center">
                                        <div class="icon-container mr-3 ${tx.type === 'deposit' ? 'bg-green-900/30 border-green-800' : 'bg-red-900/30 border-red-800'}">
                                            <i class="fas ${tx.type === 'deposit' ? 'fa-arrow-down' : 'fa-arrow-up'} ${tx.type === 'deposit' ? 'text-green-400' : 'text-red-400'}"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium">${user ? user.fullName : 'Unknown User'}</p>
                                            <p class="text-xs text-gray-400">${tx.type.toUpperCase()} • ${new Date(tx.timestamp).toLocaleDateString()}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold ${tx.type === 'deposit' ? 'text-green-400' : 'text-red-400'}">${tx.type === 'deposit' ? '+' : '-'} ${formatCurrency(tx.amount)}</p>
                                        <span class="status-badge ${tx.status === 'pending' ? 'status-pending' : tx.status === 'approved' ? 'status-active' : 'status-rejected'}">
                                            ${tx.status}
                                        </span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderAdminUsers(users) {
            return `
                <div class="bee-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">User Management</h2>
                        <button onclick="openCreateUserModal()" class="bee-yellow-button px-4 py-2 rounded-xl font-medium text-black">
                            <i class="fas fa-plus mr-2"></i> New User
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        ${users.map(user => {
                            return `
                                <div class="flex items-center justify-between p-4 border border-gray-800 rounded-xl">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center mr-3">
                                            <span class="font-bold">${user.fullName.charAt(0)}</span>
                                        </div>
                                        <div>
                                            <p class="font-medium">${user.fullName}</p>
                                            <p class="text-sm text-gray-400">@${user.username} • ${formatCurrency(user.balance)}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <button onclick="openUserDepositModal(${user.id})" class="bee-button p-2" title="Deposit">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                        <button onclick="toggleUserLock(${user.id})" class="bee-button p-2 ${user.isLocked ? 'text-red-400' : 'text-green-400'}" title="${user.isLocked ? 'Unlock' : 'Lock'}">
                                            <i class="fas ${user.isLocked ? 'fa-lock' : 'fa-lock-open'}"></i>
                                        </button>
                                        <button onclick="openDeleteUserModal(${user.id})" class="bee-button p-2 text-red-400" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderAdminTransactions() {
            const pendingTransactions = localTransactions.filter(t => t.status === 'pending');
            
            return `
                <div class="bee-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Pending Transactions</h2>
                        <span class="text-sm text-gray-400">${pendingTransactions.length} pending</span>
                    </div>
                    
                    ${pendingTransactions.length > 0 ? pendingTransactions.map(tx => {
                        const user = localUsers.find(u => u.id === tx.userId);
                        return `
                            <div class="mb-4 p-4 border border-gray-800 rounded-xl">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <p class="font-bold">${user ? user.fullName : 'Unknown User'}</p>
                                        <p class="text-sm text-gray-400">@${tx.username} • ${tx.type.toUpperCase()}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-xl font-bold ${tx.type === 'deposit' ? 'text-green-400' : 'text-red-400'}">${formatCurrency(tx.amount)}</p>
                                        <span class="status-badge status-pending">Pending</span>
                                    </div>
                                </div>
                                
                                <div class="text-sm text-gray-400 mb-4">
                                    <p><strong>Method:</strong> ${tx.method}</p>
                                    <p><strong>Details:</strong> ${tx.transactionDetails}</p>
                                    <p><strong>Date:</strong> ${new Date(tx.timestamp).toLocaleString()}</p>
                                </div>
                                
                                <div class="flex space-x-2">
                                    <button onclick="approveTransaction('${tx.docId}', ${tx.userId}, '${tx.type}', ${tx.amount}, '${tx.method}')" class="flex-1 bee-yellow-button py-2 rounded-xl font-medium text-black">
                                        Approve
                                    </button>
                                    <button onclick="rejectTransaction('${tx.docId}')" class="flex-1 bee-button py-2 rounded-xl font-medium">
                                        Reject
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('') : `
                        <div class="text-center py-8">
                            <i class="fas fa-check-circle text-3xl text-gray-700 mb-3"></i>
                            <p class="text-gray-500">No pending transactions</p>
                        </div>
                    `}
                </div>
            `;
        }

        function renderAdminHistory() {
            const recentHistory = localHistory
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 20);
            
            return `
                <div class="bee-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Transaction History</h2>
                        <button onclick="downloadHistory()" class="bee-button px-4 py-2 rounded-xl font-medium">
                            <i class="fas fa-download mr-2"></i> Export
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        ${recentHistory.map(log => {
                            const user = localUsers.find(u => u.id === log.userId);
                            return `
                                <div class="flex items-center justify-between p-3 border border-gray-800 rounded-xl">
                                    <div class="flex items-center">
                                        <div class="icon-container mr-3 ${log.type === 'deposit' ? 'bg-green-900/30 border-green-800' : log.type === 'sendmoney' ? 'bg-purple-900/30 border-purple-800' : 'bg-red-900/30 border-red-800'}">
                                            <i class="fas ${log.type === 'deposit' ? 'fa-arrow-down' : log.type === 'sendmoney' ? 'fa-exchange-alt' : 'fa-arrow-up'} ${log.type === 'deposit' ? 'text-green-400' : log.type === 'sendmoney' ? 'text-purple-400' : 'text-red-400'}"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium">${user ? user.fullName : 'Unknown User'}</p>
                                            <p class="text-xs text-gray-400">${log.type.toUpperCase()} • ${new Date(log.timestamp).toLocaleDateString()}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold ${log.type === 'deposit' ? 'text-green-400' : 'text-red-400'}">${log.type === 'deposit' ? '+' : '-'} ${formatCurrency(log.amount)}</p>
                                        <p class="text-xs text-gray-400">${log.method || 'N/A'}</p>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function getAdminModals() {
            return `
                <!-- Create User Modal -->
                <div id="createUserModal" class="modal-overlay hidden">
                    <div class="modal-content fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold">Create New User</h3>
                            <button onclick="closeCreateUserModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="createUserForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Full Name</label>
                                <input type="text" name="fullName" class="bee-input" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Username</label>
                                <input type="text" name="username" class="bee-input" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Password</label>
                                <input type="password" name="password" class="bee-input" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Initial Balance</label>
                                <input type="number" name="balance" value="0" class="bee-input" required>
                            </div>
                            
                            <button type="submit" class="w-full bee-yellow-button py-3 rounded-xl font-bold text-black">
                                Create User
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Deposit Modal -->
                <div id="depositModal" class="modal-overlay hidden">
                    <div class="modal-content fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold">Deposit Funds</h3>
                            <button onclick="closeDepositModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="adminDepositForm" class="space-y-4">
                            <input type="hidden" id="depositUserId">
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Amount</label>
                                <input type="number" id="adminDepositAmount" class="bee-input" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Method</label>
                                <select id="adminDepositMethod" class="bee-input">
                                    <option value="bkash">Bkash</option>
                                    <option value="nagad">Nagad</option>
                                    <option value="bank">Bank</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Transaction ID</label>
                                <input type="text" id="adminDepositTrxId" class="bee-input" required>
                            </div>
                            
                            <button type="submit" class="w-full bee-yellow-button py-3 rounded-xl font-bold text-black">
                                Process Deposit
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Delete User Modal -->
                <div id="deleteUserModal" class="modal-overlay hidden">
                    <div class="modal-content fade-in">
                        <div class="text-center">
                            <div class="w-12 h-12 bg-red-900/30 border border-red-800 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-exclamation-triangle text-red-400"></i>
                            </div>
                            <h3 class="text-lg font-bold mb-2">Delete User?</h3>
                            <p class="text-gray-400 mb-6">Are you sure you want to delete this user account?</p>
                            
                            <div class="flex space-x-3">
                                <button onclick="closeDeleteUserModal()" class="flex-1 bee-button py-2 rounded-xl font-medium">
                                    Cancel
                                </button>
                                <button onclick="confirmDeleteUser()" class="flex-1 bee-button py-2 rounded-xl font-medium bg-red-900/30 border-red-800 text-red-400">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Event Handlers
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Special admin login
            if (username === 'Mizx999' && password === '123') {
                const adminUser = localUsers.find(u => u.username === 'Mizx999');
                if (adminUser) {
                    currentUser = adminUser;
                    currentView = 'dashboard';
                    refreshUI();
                    showToast('Welcome Admin', 'Logged in as system administrator', 'success');
                    return;
                }
            }
            
            // Regular user login
            const foundUser = localUsers.find(u => u.username === username && u.password === password);
            
            if (foundUser) {
                currentUser = foundUser;
                currentUserView = 'dashboard';
                refreshUI();
                
                if (foundUser.isLocked) {
                    showToast('Account Locked', 'Your account is locked. Contact administration.', 'error');
                } else {
                    showToast('Welcome Back', `Logged in as ${foundUser.fullName}`, 'success');
                }
            } else {
                showToast('Login Failed', 'Invalid username or password', 'error');
            }
        }

        function logout() {
            currentUser = null;
            currentView = 'dashboard';
            currentUserView = 'dashboard';
            selectedRecipient = null;
            refreshUI();
        }

        function setUserCurrentView(view) {
            currentUserView = view;
            renderUserPanel();
        }

        function setCurrentView(view) {
            currentView = view;
            renderAdminPanel();
        }

        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const eyeIcon = document.getElementById('eyeIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.remove('fa-eye');
                eyeIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('fa-eye-slash');
                eyeIcon.classList.add('fa-eye');
            }
        }

        function setupFormListeners() {
            // Deposit form
            const depositForm = document.getElementById('depositForm');
            if (depositForm) {
                const holdButton = document.getElementById('depositHoldButton');
                if (holdButton) setupHoldButton(holdButton, handleUserDeposit);
            }
            
            // Withdraw form
            const withdrawForm = document.getElementById('withdrawForm');
            if (withdrawForm) {
                const holdButton = document.getElementById('withdrawHoldButton');
                if (holdButton) setupHoldButton(holdButton, handleUserWithdraw);
            }
            
            // Send money form
            const sendMoneyForm = document.getElementById('sendMoneyForm');
            if (sendMoneyForm) {
                const holdButton = document.getElementById('sendMoneyHoldButton');
                if (holdButton) setupHoldButton(holdButton, handleSendMoney);
            }
        }

        function setupHoldButton(button, callback) {
            let holdStartTime = null;
            const holdDuration = 2000;
            
            button.addEventListener('mousedown', startHold);
            button.addEventListener('mouseup', endHold);
            button.addEventListener('mouseleave', endHold);
            
            button.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startHold();
            });
            button.addEventListener('touchend', endHold);
            button.addEventListener('touchcancel', endHold);
            
            function startHold() {
                holdStartTime = Date.now();
                button.classList.add('holding');
                button.disabled = true;
                
                holdTimer = setTimeout(() => {
                    callback();
                    button.classList.remove('holding');
                    button.disabled = false;
                }, holdDuration);
            }
            
            function endHold() {
                if (holdTimer) clearTimeout(holdTimer);
                button.classList.remove('holding');
                button.disabled = false;
                
                if (holdStartTime) {
                    const holdTime = Date.now() - holdStartTime;
                    if (holdTime < holdDuration) {
                        showToast('Hold Longer', 'Please hold for 2 seconds to confirm', 'info');
                    }
                }
            }
        }

        async function handleUserDeposit() {
            if (currentUser.isLocked) {
                showToast('Account Locked', 'Your account is locked', 'error');
                return;
            }
            
            const amount = parseFloat(document.getElementById('depositAmount').value);
            const method = document.querySelector('input[name="depositMethod"]:checked')?.value;
            const trxId = document.getElementById('depositTrxId').value;
            
            if (!amount || amount < 10) {
                showToast('Error', 'Minimum deposit is ৳10', 'error');
                return;
            }
            
            if (!method) {
                showToast('Error', 'Please select a payment method', 'error');
                return;
            }
            
            if (!trxId) {
                showToast('Error', 'Please enter transaction ID', 'error');
                return;
            }
            
            try {
                showDBLoading();
                
                const transactionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
                await addDoc(transactionsRef, {
                    id: Date.now(),
                    userId: currentUser.id,
                    username: currentUser.username,
                    type: 'deposit',
                    amount: amount,
                    method: method,
                    transactionDetails: trxId,
                    status: 'pending',
                    timestamp: new Date().toISOString()
                });
                
                hideDBLoading();
                showSuccessPage('deposit', amount, method);
                document.getElementById('depositForm').reset();
                
            } catch (error) {
                console.error('Deposit error:', error);
                hideDBLoading();
                showToast('Error', 'Failed to submit deposit request', 'error');
            }
        }

        async function handleUserWithdraw() {
            if (currentUser.isLocked) {
                showToast('Account Locked', 'Your account is locked', 'error');
                return;
            }
            
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const method = document.querySelector('input[name="withdrawMethod"]:checked')?.value;
            const account = document.getElementById('withdrawAccount').value;
            
            if (!amount || amount < 10) {
                showToast('Error', 'Minimum withdrawal is ৳10', 'error');
                return;
            }
            
            if (amount > currentUser.balance) {
                showToast('Error', 'Insufficient balance', 'error');
                return;
            }
            
            if (!method) {
                showToast('Error', 'Please select a withdrawal method', 'error');
                return;
            }
            
            if (!account) {
                showToast('Error', 'Please enter account number', 'error');
                return;
            }
            
            try {
                showDBLoading();
                
                const transactionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
                await addDoc(transactionsRef, {
                    id: Date.now(),
                    userId: currentUser.id,
                    username: currentUser.username,
                    type: 'withdraw',
                    amount: amount,
                    method: method,
                    transactionDetails: account,
                    status: 'pending',
                    timestamp: new Date().toISOString()
                });
                
                hideDBLoading();
                showSuccessPage('withdraw', amount, method);
                document.getElementById('withdrawForm').reset();
                
            } catch (error) {
                console.error('Withdraw error:', error);
                hideDBLoading();
                showToast('Error', 'Failed to submit withdrawal request', 'error');
            }
        }

        function searchRecipient() {
            const searchTerm = document.getElementById('recipientUsername').value.toLowerCase();
            const resultsDiv = document.getElementById('recipientResults');
            
            if (searchTerm.length < 2) {
                resultsDiv.innerHTML = '';
                return;
            }
            
            const filteredUsers = localUsers.filter(user => 
                user.id !== currentUser.id && 
                !user.isLocked &&
                user.role !== 'admin' &&
                (user.username.toLowerCase().includes(searchTerm) || 
                 user.fullName.toLowerCase().includes(searchTerm))
            ).slice(0, 5);
            
            if (filteredUsers.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="text-gray-500 text-sm p-2">
                        No users found
                    </div>
                `;
                return;
            }
            
            resultsDiv.innerHTML = filteredUsers.map(user => `
                <div class="bee-button p-3 cursor-pointer" onclick="selectRecipient(${user.id})">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-gray-800 rounded-full flex items-center justify-center mr-3">
                            <span class="font-bold text-sm">${user.fullName.charAt(0)}</span>
                        </div>
                        <div>
                            <p class="font-medium">${user.fullName}</p>
                            <p class="text-xs text-gray-400">@${user.username}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selectRecipient(userId) {
            selectedRecipient = localUsers.find(u => u.id === userId);
            renderUserPanel();
        }

        function clearRecipient() {
            selectedRecipient = null;
            renderUserPanel();
        }

        async function handleSendMoney() {
            if (!selectedRecipient) {
                showToast('Error', 'Please select a recipient', 'error');
                return;
            }
            
            if (currentUser.isLocked) {
                showToast('Account Locked', 'Your account is locked', 'error');
                return;
            }
            
            const amount = parseFloat(document.getElementById('sendMoneyAmount').value);
            
            if (!amount || amount < 10) {
                showToast('Error', 'Minimum amount is ৳10', 'error');
                return;
            }
            
            if (amount > currentUser.balance) {
                showToast('Error', 'Insufficient balance', 'error');
                return;
            }
            
            try {
                showDBLoading();
                
                // Update sender balance
                const senderDocId = getFirestoreDocId(currentUser.id);
                const senderRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', senderDocId);
                await updateDoc(senderRef, {
                    balance: currentUser.balance - amount
                });
                
                // Update recipient balance
                const recipientDocId = getFirestoreDocId(selectedRecipient.id);
                const recipientRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', recipientDocId);
                await updateDoc(recipientRef, {
                    balance: selectedRecipient.balance + amount
                });
                
                // Record in send money history
                const sendMoneyRef = collection(db, 'artifacts', appId, 'public', 'data', 'sendMoneyHistory');
                await addDoc(sendMoneyRef, {
                    id: Date.now(),
                    userId: currentUser.id,
                    username: currentUser.username,
                    senderName: currentUser.fullName,
                    recipientId: selectedRecipient.id,
                    recipientUsername: selectedRecipient.username,
                    recipientName: selectedRecipient.fullName,
                    amount: amount,
                    type: 'sent',
                    timestamp: new Date().toISOString(),
                    status: 'completed'
                });
                
                // Also record for recipient
                await addDoc(sendMoneyRef, {
                    id: Date.now() + 1,
                    userId: selectedRecipient.id,
                    username: selectedRecipient.username,
                    senderId: currentUser.id,
                    senderUsername: currentUser.username,
                    senderName: currentUser.fullName,
                    amount: amount,
                    type: 'received',
                    timestamp: new Date().toISOString(),
                    status: 'completed'
                });
                
                // Record in main history
                const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'fundHistory');
                await addDoc(historyRef, {
                    id: Date.now(),
                    userId: currentUser.id,
                    username: currentUser.username,
                    amount: amount,
                    type: 'sendmoney',
                    timestamp: new Date().toISOString(),
                    status: 'completed',
                    recipientId: selectedRecipient.id,
                    recipientName: selectedRecipient.fullName
                });
                
                hideDBLoading();
                showSuccessPage('sendmoney', amount);
                selectedRecipient = null;
                
            } catch (error) {
                console.error('Send money error:', error);
                hideDBLoading();
                showToast('Error', 'Failed to send money', 'error');
            }
        }

        // Admin Functions
        function setupAdminListeners() {
            const createUserForm = document.getElementById('createUserForm');
            if (createUserForm) {
                createUserForm.addEventListener('submit', handleCreateUser);
            }
            
            const adminDepositForm = document.getElementById('adminDepositForm');
            if (adminDepositForm) {
                adminDepositForm.addEventListener('submit', handleAdminDeposit);
            }
        }

        function openCreateUserModal() {
            document.getElementById('createUserModal').classList.remove('hidden');
        }

        function closeCreateUserModal() {
            document.getElementById('createUserModal').classList.add('hidden');
        }

        function openUserDepositModal(userId) {
            document.getElementById('depositUserId').value = userId;
            document.getElementById('depositModal').classList.remove('hidden');
        }

        function closeDepositModal() {
            document.getElementById('depositModal').classList.add('hidden');
        }

        function openDeleteUserModal(userId) {
            window.deleteUserId = userId;
            document.getElementById('deleteUserModal').classList.remove('hidden');
        }

        function closeDeleteUserModal() {
            document.getElementById('deleteUserModal').classList.add('hidden');
        }

        async function handleCreateUser(e) {
            e.preventDefault();
            
            const form = e.target;
            const username = form.username.value;
            
            if (localUsers.find(u => u.username === username)) {
                showToast('Error', 'Username already exists', 'error');
                return;
            }
            
            const newUser = {
                id: Date.now(),
                username: username,
                password: form.password.value,
                fullName: form.fullName.value,
                email: '',
                phone: '',
                address: '',
                balance: parseFloat(form.balance.value),
                role: 'user',
                accountType: 'member',
                isLocked: false,
                loanAmount: 0,
                loanActive: false,
                createdAt: new Date().toISOString()
            };
            
            try {
                const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                await addDoc(usersRef, newUser);
                
                closeCreateUserModal();
                form.reset();
                showToast('Success', 'User created successfully', 'success');
                
            } catch (error) {
                console.error('Create user error:', error);
                showToast('Error', 'Failed to create user', 'error');
            }
        }

        async function handleAdminDeposit(e) {
            e.preventDefault();
            
            const userId = parseInt(document.getElementById('depositUserId').value);
            const amount = parseFloat(document.getElementById('adminDepositAmount').value);
            const method = document.getElementById('adminDepositMethod').value;
            const trxId = document.getElementById('adminDepositTrxId').value;
            
            if (!amount || amount <= 0) {
                showToast('Error', 'Please enter valid amount', 'error');
                return;
            }
            
            const user = localUsers.find(u => u.id === userId);
            if (!user) {
                showToast('Error', 'User not found', 'error');
                return;
            }
            
            try {
                showDBLoading();
                
                // Update user balance
                const userDocId = getFirestoreDocId(userId);
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userDocId);
                await updateDoc(userRef, {
                    balance: user.balance + amount
                });
                
                // Record in history
                const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'fundHistory');
                await addDoc(historyRef, {
                    id: Date.now(),
                    userId: userId,
                    username: user.username,
                    amount: amount,
                    method: method,
                    type: 'deposit',
                    transactionDetails: trxId,
                    timestamp: new Date().toISOString(),
                    approvedBy: currentUser.username,
                    status: 'approved'
                });
                
                hideDBLoading();
                closeDepositModal();
                document.getElementById('adminDepositForm').reset();
                showToast('Success', `Deposited ${formatCurrency(amount)} to ${user.fullName}`, 'success');
                
            } catch (error) {
                console.error('Admin deposit error:', error);
                hideDBLoading();
                showToast('Error', 'Failed to process deposit', 'error');
            }
        }

        async function toggleUserLock(userId) {
            const user = localUsers.find(u => u.id === userId);
            if (!user) return;
            
            try {
                const userDocId = getFirestoreDocId(userId);
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userDocId);
                
                await updateDoc(userRef, {
                    isLocked: !user.isLocked
                });
                
                showToast('Success', `User ${user.isLocked ? 'unlocked' : 'locked'}`, 'success');
                
            } catch (error) {
                console.error('Toggle lock error:', error);
                showToast('Error', 'Failed to update user status', 'error');
            }
        }

        async function confirmDeleteUser() {
            const userId = window.deleteUserId;
            const user = localUsers.find(u => u.id === userId);
            
            if (!user) {
                showToast('Error', 'User not found', 'error');
                return;
            }
            
            try {
                const userDocId = getFirestoreDocId(userId);
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userDocId);
                
                await deleteDoc(userRef);
                
                closeDeleteUserModal();
                showToast('Success', 'User deleted successfully', 'success');
                
            } catch (error) {
                console.error('Delete user error:', error);
                showToast('Error', 'Failed to delete user', 'error');
            }
        }

        async function approveTransaction(transactionId, userId, type, amount, method) {
            try {
                showDBLoading();
                
                // Update transaction status
                const transactionRef = doc(db, 'artifacts', appId, 'public', 'data', 'transactions', transactionId);
                await updateDoc(transactionRef, {
                    status: 'approved',
                    approvedAt: new Date().toISOString(),
                    approvedBy: currentUser.username
                });
                
                // Update user balance if deposit
                if (type === 'deposit') {
                    const user = localUsers.find(u => u.id === userId);
                    if (user) {
                        const userDocId = getFirestoreDocId(userId);
                        const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userDocId);
                        await updateDoc(userRef, {
                            balance: user.balance + amount
                        });
                    }
                }
                
                // Record in history
                const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'fundHistory');
                const transaction = localTransactions.find(t => t.docId === transactionId);
                
                await addDoc(historyRef, {
                    id: Date.now(),
                    userId: userId,
                    username: transaction.username,
                    amount: amount,
                    method: method,
                    type: type,
                    transactionDetails: transaction.transactionDetails,
                    timestamp: new Date().toISOString(),
                    approvedBy: currentUser.username,
                    status: 'approved'
                });
                
                hideDBLoading();
                showToast('Success', 'Transaction approved', 'success');
                
            } catch (error) {
                console.error('Approve transaction error:', error);
                hideDBLoading();
                showToast('Error', 'Failed to approve transaction', 'error');
            }
        }

        async function rejectTransaction(transactionId) {
            const reason = prompt('Enter rejection reason:');
            if (!reason) return;
            
            try {
                const transactionRef = doc(db, 'artifacts', appId, 'public', 'data', 'transactions', transactionId);
                await updateDoc(transactionRef, {
                    status: 'rejected',
                    rejectedAt: new Date().toISOString(),
                    rejectedBy: currentUser.username,
                    rejectionReason: reason
                });
                
                showToast('Transaction Rejected', `Reason: ${reason}`, 'info');
                
            } catch (error) {
                console.error('Reject transaction error:', error);
                showToast('Error', 'Failed to reject transaction', 'error');
            }
        }

        function downloadHistory() {
            const historyData = localHistory.map(log => {
                const user = localUsers.find(u => u.id === log.userId);
                return {
                    'Date': new Date(log.timestamp).toLocaleString(),
                    'User': user ? user.fullName : 'Unknown',
                    'Username': log.username,
                    'Type': log.type,
                    'Method': log.method || 'N/A',
                    'Amount': formatCurrency(log.amount),
                    'Details': log.transactionDetails || '',
                    'Status': log.status || 'completed',
                    'Approved By': log.approvedBy || ''
                };
            });
            
            const csvContent = [
                Object.keys(historyData[0] || {}).join(','),
                ...historyData.map(row => Object.values(row).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `blackbee-history-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast('Success', 'History exported successfully', 'success');
        }

        // Expose functions to window
        window.togglePasswordVisibility = togglePasswordVisibility;
        window.setUserCurrentView = setUserCurrentView;
        window.setCurrentView = setCurrentView;
        window.logout = logout;
        window.searchRecipient = searchRecipient;
        window.selectRecipient = selectRecipient;
        window.clearRecipient = clearRecipient;
        window.openCreateUserModal = openCreateUserModal;
        window.closeCreateUserModal = closeCreateUserModal;
        window.openUserDepositModal = openUserDepositModal;
        window.closeDepositModal = closeDepositModal;
        window.openDeleteUserModal = openDeleteUserModal;
        window.closeDeleteUserModal = closeDeleteUserModal;
        window.toggleUserLock = toggleUserLock;
        window.confirmDeleteUser = confirmDeleteUser;
        window.approveTransaction = approveTransaction;
        window.rejectTransaction = rejectTransaction;
        window.downloadHistory = downloadHistory;
        window.handleLogin = handleLogin;

    </script>
</body>
</html>
